<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta content="Computer,Music,MIDI,VST,DAW,DTM" name="keywords" />
<meta property="og:title" content="WebKnobMan Knob Designer | g200kg Music &amp; Software" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://www.g200kg.com/en/webknobman/index.html" />
<meta property="og:site_name" content="g200kg Music &amp; Software" />
<meta property="og:image" content="https://www.g200kg.com/en/webknobman/img/JKnobMan.png" />
<meta property="fb:admins" content="100002707605815" />
<meta name="msvalidate.01" content="43A64EFC06DC48878352725A6B464427" />
<meta name="y_key" content="860a71a10535d067" />
<title>WebKnobMan Knob Designer | g200kg Music &amp; Software</title>
<link rel="icon" href="https://www.g200kg.com/favicon.ico" type="image/vnd.microsoft.icon" />
<link href='https://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
<link href="https://fonts.googleapis.com/css?family=Cinzel+Decorative&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">
<link rel="shortcut icon" href="https://www.g200kg.com/favicon.ico" type="image/vnd.microsoft.icon" />
<script src="dd.js"></script>
<script src="apngbuilder.js"></script>
<script src="colormap.js"></script>
<script src="popupmenu.js"></script>
<link rel="stylesheet" type="text/css" href="dd.css" />
<link rel="stylesheet" type="text/css" href="popupmenu.css" />

<style type="text/css">
body {
  margin: 0 auto;
  padding: 0px;
  background-color: #f8f8f8;
  color:#eeeeff;
  font-family: 'Roboto Condensed', sans-serif;
  font-size:14px;
  line-height:170%;
  height:100%;
  position:relative;
}
#container {
  position:relative;
  margin: 0px auto;
  padding: 8px;
  text-align: left;
  background-color:#334455;
  /*background-image:url(img/g200kgcorner.png);*/
  background-repeat:no-repeat;
  width:1000px;
}
#header {
  height:90px;
  background:#ddf;
  color:#334477;
  margin-bottom:4px;
}
#logo {
  float:left;
}
#titlediv{
  margin-left:20px;
  color:#448;
  float:left;
}
#title{
  font-family: 'Cinzel Decorative', cursive;
  color:#334455;
}
#ad {
  float:left;
  margin:0px;
}
#gallerybuttons{
  float:left;
  margin-left:10px;
}
a {
  color:#aaccff;
}
hr {
  border:0;
  height:4px;
  background: #338;
  background:linear-gradient(to right, #ccf, #338);
}
#editor select {
  height:23px;
  box-sizing:border-box;
  border:1px solid #000;
  vertical-align:middle;
}
#editor input {
  height:23px;
  box-sizing:border-box;
  border:1px solid #000;
  vertical-align:middle;
  text-align:center;
}
#editor input:disabled{
  background:#bbbbbb;
}
#editor select:disabled{
  background:#bbbbbb;
}
#editor .spin {
  cursor:n-resize;
  width:27px;
  height:23px;
  padding:0;
  margin:0;
  border:1px solid #000;
  vertical-align:middle;
  box-sizing:border-box;
}
#editor .spin img{
  padding:0;
  margin:0 auto;
  width:12px;
  height:12px;
  vertical-align:middle;
  user-drag:none;
}
br {
  clear:both;
}
#layerpane{
  user-select:none;
  color:#222266;
  background:#ddddff;
}
#layerpane div {
  padding:2px;
  border:1px solid #88aacc;
}
#layerpane div img
{
  vertical-align:middle;
}
table {
  border:1px solid #88f;
}
table td {
  border:1px solid #88f;
  padding:1px 5px;
}
.subgrp{
  background:#ccccdd;
  padding:2px;
  margin:5px;
  color:#223344
}

.paramrow{
  display:flex;
  vertical-align:middle;
  padding:0;
  margin:0;
}
.paramrow div{
  vertical-align:middle;
  padding:0;
  margin:0;
}
.paramrow select{
  vertical-align:middle;
  margin:0px 5px;
}
.paramrow input[type=checkbox]{
  vertical-align:middle;
  padding:0;
  width:14px;
  height:14px;
  margin:0px 3px;
}
.paramrow input[type=text]{
  vertical-align:middle;
  padding:0;
  margin:0;
}
.paramrow button{
  vertical-align:middle;
  padding:0;
  margin:0;
  height:23px;
}
#editor{
  position:relative;
  user-select:none;
}
#renderframe{
  position:absolute;
  top:0;
  left:0;
  background:argb(0,0,0, 0.5);
  width:100%;
  height:100%;
  text-align:center;
  display:none;
  overflow:auto;
}
#rendermsg{
  background:#000;
  color:#fff;
}
#typesel{
  width:120px;
  height:24px;
}
.option{
  height:26px;
}
.select{
}
.select img {
  vertical-align:middle;
  object-fit:none;
  width:32px;
  height:20px;
  padding:0;
  margin:-2px 5px 0 0;
}
input::-ms-clear {
  visibility:hidden
}
</style>

<script type="text/javascript">
  var cvPrevFrom;
  var ctxPrevFrom;
  var cvPrevTo;
  var ctxPrevTo;
//    var cvColorMap;
//    var ctxColorMap;
  var ctxRender;
  var imgRender;
  var imgColorbar;
  var layers;
  var curLayer;
  var s = 0;
  var paramDrag = 0;
  var paramGroup = -1;
  var dragType = "";
  var dragv0 = 0;
  var dragy0 = 0;
//    var colorMapEdit = 0;
  var prefs;
  var renderframe = -4;
  var renderlayer = 0;
  var renderinit = 0;
  var fileapi = 0;
  var exporting = 0;
  var shapeeditor;
  var curveeditor;
  var shiftkey=0;
  var ctrlkey=0;
  var loadingtex = new Array();
  var loadingimg = new Array();
  var easy=0;
  var timeoutId;
  var colorMap;
  var MAXLAYER = 60;

  document.onkeydown = function(e) {
    var ev=e;
    if(e==null)
      ev=event;
    ctrlkey = ev.ctrlKey;
    shiftkey = ev.shiftKey;
//		event.returnValue = false;
//		event.cancelBubble = true;
  }
  document.onkeyup = function(e) {
    var ev=e;
    if(e==null)
      ev=event;
    ctrlkey = ev.ctrlKey;
    shiftkey = ev.shiftKey;
  }
  function LightFilter(w, h, slightdir, sden, elightdir, eoff, eden, imgTemp){
    let x, y, rX, rY, br, iR, p, pp, a1;
    let rLX, rLY, rLXE, rLYE, ew;
    const col00 = new Col(0, 0, 0);
//        const startTime = performance.now();
    p = 0;
    ew = Math.floor(Math.min(w, h) * eoff / 200);
    rLX = -Math.sin(slightdir * Math.PI / 180);
    rLY = Math.cos(slightdir * Math.PI / 180);
    rLXE = -Math.sin(elightdir * Math.PI / 180);
    rLYE = Math.cos(elightdir * Math.PI / 180);
    iR = ew * ew * 2;
    const data = imgTemp.data;
    const nn = iR * (Math.PI/2);
    n1 = n2 = 0;
    for (y = 0; y < h; ++y) {
      const yymin = Math.max(-y, -ew);
      const yymax = Math.min(h - y, ew + 1);
      rY = (y + 0.5) * 2 / h - 1.0;
      for (x = 0; x < w; ++x) {
        rX = (x + 0.5) * 2 / w - 1.0;
        br = (-(rLX * rX + rLY * rY) * sden * 2.55);
        if (eden) {
          let asum = 0;
          const xxmin = Math.max(-x, -ew);
          const xxmax = Math.min(w - x, ew + 1);
          for (let yy = yymin; yy < yymax; ++yy) {
            const y2 = y + yy;
            const rly = yy * rLYE;
            let pp = ((y2 * w + x + xxmin)<<2) + 3;
            for (let xx = xxmin; xx < xxmax; ++xx, pp+=4) {
                asum += (data[pp] * (xx * rLXE + rly));
            }
          }
          if (nn)
            br += (asum / nn * eden / (20 * ew));

        }
        col00.GetPix(imgTemp, p);
        col00.ChangeBrightness(br);
        col00.SetPix(imgTemp, p);
        p += 4;
      }
    }
//        const endTime = performance.now();
//        console.log("elapse:"+(endTime - startTime)+" ms");
  }
  function CheckFileApi() {
    if (typeof (window.File) == "function") {
      var fapi = new FileReader();
      if (typeof (fapi.readAsBinaryString) == "function")
        return 1;
      return 0;
    }
    return 0;
  }
  function ImageToPng(img) {
//        var cvWork3 = document.getElementById("canvaswork3");
    cvWork3.width = img.width;
    cvWork3.height = img.height;
    var ctxWork3 = cvWork3.getContext("2d");
    ctxWork3.drawImage(img, 0, 0,img.width,img.height,0,0,img.width,img.height);
    return cvWork3.toDataURL();
  }
  function B64toB64Url(s) {
    s = s.replace(/\+/g,"-");
    s = s.replace(/\//g,"_");
    return s;
  }
  function B64(s) {
    var b = new Array(0, 0, 0);
    var uri = "";
    var cnt = 0;
    function ToX(x) {
      return "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[x & 0x3f];
    }
    function Add1(x) {
      b[cnt] = x;
      if (++cnt >= 3) {
        cnt = 0;
        uri += (ToX(b[0] >> 2)
            + ToX((b[0] << 4) + ((b[1] >> 4) & 0xf))
            + ToX((b[1] << 2) + ((b[2] >> 6) & 0x3))
            + ToX(b[2]));
      }
    }
    if (typeof s === "string") {
      for (var i = 0; i < s.length; ++i)
        Add1(s.charCodeAt(i));
    }
    else {
      for (var i = 0; i < s.length; ++i)
        Add1(s[i]);
    }
    switch (cnt) {
      case 1:
        uri += (ToX(b[0] >> 2) + ToX(b[0] << 4) + "==");
        break;
      case 2:
        uri += (ToX(b[0] >> 2) + ToX((b[0] << 4) + ((b[1] >> 4) & 0xf)) + ToX(b[1] << 2) + "=");
        break;
    }
    return uri;
  }
  function B64Url(s) {
    var b = new Array(0, 0, 0);
    var uri = "";
    var cnt = 0;
    function ToX(x) {
      return "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"[x & 0x3f];
    }
    function Add1(x) {
      b[cnt] = x;
      if (++cnt >= 3) {
        cnt = 0;
        uri += (ToX(b[0] >> 2)
            + ToX((b[0] << 4) + ((b[1] >> 4) & 0xf))
            + ToX((b[1] << 2) + ((b[2] >> 6) & 0x3))
            + ToX(b[2]));
      }
    }
    if (typeof s==="string") {
      for (var i = 0; i < s.length; ++i)
        Add1(s.charCodeAt(i));
    }
    else {
      for (var i = 0; i < s.length; ++i)
        Add1(s[i]);
    }
    switch (cnt) {
      case 1:
        uri += ToX(b[0] >> 2) + ToX(b[0] << 4);
        break;
      case 2:
        uri += ToX(b[0] >> 2) + ToX((b[0] << 4) + ((b[1] >> 4) & 0xf)) + ToX(b[1] << 2);
        break;
    }
    return uri;
  }
  function B64Dec(s) {
    var len = s.length;
    var bin = "";
    var a1, a2, a3, a4;
    var ToB = function(x) {
      if (x >= 0x41 && x <= 0x5a)
        return x - 0x41;
      if (x >= 0x61 && x <= 0x7a)
        return x - 0x61 + 26;
      if (x >= 0x30 && x <= 0x39)
        return x - 0x30 + 52;
      if (x == 0x2b || x == 0x2d)
        return 62;
      if (x == 0x2f || x == 0x5f)
        return 63;
      if (x == 0x3d)
        return -1;
      return 0;
    }
    for (var i = 0; i + 3 < len; i += 4) {
      a1 = ToB(s.charCodeAt(i));
      a2 = ToB(s.charCodeAt(i + 1));
      a3 = ToB(s.charCodeAt(i + 2));
      a4 = ToB(s.charCodeAt(i + 3));
      if (a4 < 0)
        break;
      bin += String.fromCharCode((a1 << 2) + (a2 >> 4), ((a2 & 0xf) << 4) + ((a3 & 0x3c) >> 2), ((a3 & 0x3) << 6) + a4);
    }
    if (len == i + 2 || a3 < 0) {
      a1 = ToB(s.charCodeAt(i));
      a2 = ToB(s.charCodeAt(i + 1));
      bin += String.fromCharCode((a1 << 2) + (a2 >> 4));
    }
    else if (len == i + 3 || a4 < 0) {
      a1 = ToB(s.charCodeAt(i));
      a2 = ToB(s.charCodeAt(i + 1));
      a3 = ToB(s.charCodeAt(i + 2));
      bin += String.fromCharCode((a1 << 2) + (a2 >> 4), ((a2 & 0xf) << 4) + ((a3 & 0x3c) >> 2));
    }
    return bin;
  }
  function Mime(s) {
    if (s[0] == 'B' && s[1] == 'M')
      return "image/bmp";
    if (s[0] == 0x89 && s[1] == 0x50)
      return "image/png";
    return "image/jpeg";
  }
  function ProfileReader(s) {
    this.str = s;
    this.len = s.length;
    this.line="";
    this.unicode = 0;
    this.ptr = 0;
    this.ptrSec = 0;
    this.ptrHead = 0;
    this.err = 0;
    this.Read=function(n) {
      var d = 0;
      for (var i = 0; i < n; ++i) {
        d = d + this.str.charCodeAt(this.ptr++)*(1<<(i*8));
      }
      return d;
    }
    this.GetLine = function() {
      this.line = "";
      while (this.ptr < this.str.length) {
        var c = this.str[this.ptr++];
//                if (this.unicode)
//                    this.ptr++;
        if (c == '\x0a') {
          if (this.line[0] == '[')
            return -1;
          return 1;
        }
        if(c!='\x0d'&&c!='\x00')
          this.line += c;
      }
      return 0;
    }
    this.SeekHead = function() {
      this.ptr = this.ptrHead;
    }
    this.FindSection = function(strSection) {
      console.log("FindSection:"+strSection);
      var strSec = "[" + strSection + "]";
      this.SeekHead();
      for (; ; ) {
        if (this.GetLine() == 0)
          break;
        if (this.line.indexOf(strSec) == 0) {
          this.ptrSec = this.ptr;
          console.log("exit");
          return;
        }
      }
      console.log("exit");
    }
    this.ReadString = function(strKey, def) {
      var str = strKey + "=";
      this.ptr = this.ptrSec;
      for (; ; ) {
        if (this.GetLine() <= 0)
          break;
        if (this.line.indexOf(str) == 0) {
          return this.line.substring(str.length);
        }
      }
      return def;
    }
    this.ReadVal = function(strKey, def) {
      var str = strKey + "=";
      this.ptr = this.ptrSec;
      for (; ; ) {
        if (this.GetLine() <= 0)
          break;
        if (this.line.indexOf(str) == 0) {
          return parseFloat(this.line.substring(str.length));
        }
      }
      return def;
    }
    this.ReadNext = function(def) {
      if (this.GetLine() <= 0)
        return def;
      var p = this.line.indexOf("=") + 1;
      return this.line.substring(p);
    }
    this.ExtractFile = function(strKeyBase) {
      var strFileBuff;
      var strKey;
      var datFile = new Array();
      strKey = strKeyBase + "0";
      strFileBuff = this.ReadString(strKey, "");
      if (strFileBuff[0]) {
        var i, j, jMax, c;
        for (i = 0; ; ++i) {
          strKey = strKeyBase + i;
          if (i == 0)
            strFileBuff = this.ReadString(strKey, "");
          else
            strFileBuff = this.ReadNext("");
          jMax = strFileBuff.length;
          for (j = 0; j < jMax; j += 2) {
            c = parseInt(strFileBuff.substr(j, 2), 16);
            datFile.push(c);
          }
          if (jMax < 512)
            break;
        }
        return datFile;
      }
      return datFile;
    }
    switch (this.Read(2)) {
    case 0xfeff:
      this.unicode = 1;
      this.ptrHead = this.ptr = 2;
      break;
    case 0x4d4b:
      this.unicode = 1;
      this.ptrHead = this.ptr = this.Read(4);
      break;
    case 0x5089:
      this.unicode = 0;
      var chunkLen, chunkID, pos;
      this.ptrHead = 8;
      for (; ; ) {
        this.ptr = this.ptrHead;
        chunkLen = this.Read(4);
        chunkLen = ((chunkLen & 0xff) << 24) | ((chunkLen & 0xff00) << 8) | ((chunkLen & 0xff0000) >> 8) | ((chunkLen & 0xff000000) >> 24);
        chunkID = this.Read(4);
        if (chunkID == 0x74584574) {//tEXt
          this.ptrHead += 16;
          break;
        }
        else if (chunkID == NaN) {
          break;
        }
        else {
          this.ptrHead += (chunkLen + 12); //len+id+crc
          if(this.ptrHead >= this.len){
            this.err = 1;
            break;
          }
        }
      }
      break;
    }
  }
  function ProfileWriter() {
    this.info = Array();
    this.WriteBOM2 = function() {
      this.info.push(0x4b,0x4d,6,0,0,0);
    }
    this.WriteHeader = function(thumb) {
      var sz = thumb.length;
      this.info.push(0x4b, 0x4d);
      this.info.push(sz & 0xff, (sz >> 8) & 0xff, (sz >> 16) & 0xff, (sz >> 24) & 0xff);
      for (var i = 6; i < sz; ++i)
        this.info.push(thumb.charCodeAt(i));
    }
    this.Add = function(s) {
      for (var i = 0; i < s.length; ++i) {
        this.info.push(s.charCodeAt(i));
        this.info.push(0);
      }
    }
    this.Section = function(strSection) {
      this.Add("[" + strSection + "]\n");
    }
    this.WriteStr = function(strKey, strValue) {
      this.Add(strKey + "=" + strValue+"\n");
    }
    this.WriteInt = function(strKey, iValue) {
      this.Add(strKey + "=" + Math.floor(iValue)+"\n");
    }
    this.WriteFloat = function(strKey, fValue) {
      this.Add(strKey + "=" + fValue+"\n");
    }
    this.Hex = function(x) {
      return "0123456789abcdef"[x & 0xf];
    }
    this.EmbedFile=function(strKeyBase,content) {
      var out="";
      var cnt=0;
      var line=0;
      for(var i=0;i<content.length;++i) {
        v=content.charCodeAt(i);
        out+=this.Hex(v>>4);
        out+=this.Hex(v);
        if(++cnt>=256) {
          this.WriteStr(strKeyBase+line,out);
          cnt=0;
          out="";
          ++line;
        }
      }
      this.WriteStr(strKeyBase + line, out);
    }
  }
  function AnimCurve() {
    this.tm = Array();
    this.lv = Array();
    this.stepreso = 0;
    for (var i = 0; i < 6; ++i)
      this.tm[i] = this.lv[i] = -1;
    this.tm[0] = this.lv[0] = 0;
    this.tm[5] = this.lv[5] = 100;
    this.GetVal = function(ratio) {
      var i, iT0, iL0, iT1, iL1;
      iT0 = 0;
      iL0 = this.lv[0];
      for (var i = 1; i < 6; ++i) {
        if (this.tm[i] >= 0) {
          iT1 = this.tm[i];
          iL1 = this.lv[i];
          if (ratio * 100 <= this.tm[i]) {
            ratio = (iL0 + (iL1 - iL0) * (ratio * 100 - iT0) / (iT1 - iT0)) / 100;
            break;
          }
          iT0 = iT1;
          iL0 = iL1;
        }
      }

      if (this.stepreso == 1)
        ratio = 0;
      else if (this.stepreso >= 2) {
        i = Math.floor(ratio * this.stepreso);
        if (i >= this.stepreso)
          --i;
        ratio = i / (this.stepreso - 1);
      }

      return ratio;
    }
  }
  function DynamicText(s) {
    this.str = s;
    this.p = 0;
    this.pi = 0;
    this.fx = "x";
    this.fmt = "%d";
    this.Skip = function(p) {
      while (this.str[p] == ' ')
        ++p;
      return p;
    }
    this.Digit = function(x) {
      if (x >= '0' && x <= '9')
        return 1;
      return 0;
    }
    this.Eval0 = function(p, rVal) {
      switch (this.str[p]) {
        case 'x':
          this.p = p + 1;
          return rVal;
        case '(':
          var d = this.Eval(p + 1, rVal);
          if (this.str[this.p] == ')')
            ++this.p;
          return d;
        case '-':
          return -this.Eval0(p + 1, rVal);
        case '+':
          return this.Eval0(p + 1, rVal);
      }
      return this.GetANum(p);
    }
    this.Eval1 = function(p, rVal) {
      var d;
      if (this.str.indexOf("pow(", p) == p) {
        d = this.Eval(p + 4, rVal);
        if (this.str[this.p] == ',')
          ++this.p;
        d = Math.pow(d, this.Eval(this.p, rVal));
        if (this.str[this.p] == ')')
          ++this.p;
        return d;
      }
      if (this.str.indexOf("exp(", p) == p) {
        d = this.Eval(p + 4, rVal);
        if (this.str[this.p] == ')')
          ++this.p;
        return Math.exp(d);
      }
      if (this.str.indexOf("log(", p) == p) {
        d = this.Eval(p + 4, rVal);
        if (this.str[this.p] == ')')
          ++this.p;
        return Math.log(d);
      }
      if (this.str.indexOf("log10(", p) == p) {
        d = this.Eval(p + 6, rVal);
        if (this.str[this.p] == ')')
          ++this.p;
        return Math.LOG10E*Math.log(d);
      }
      if (this.str.indexOf("sqrt(", p) == p) {
        d = this.Eval(p + 5, rVal);
        if (this.str[this.p] == ')')
          ++this.p;
        return Math.sqrt(d);
      }
      return this.Eval0(p, rVal);
    }
    this.Eval2 = function(p, rVal) {
      var d;
      d = this.Eval1(p, rVal);
      for (; ; ) {
        switch (this.str[this.p]) {
          case '*':
            d *= this.Eval1(this.p + 1, rVal);
            break;
          case '/':
            d = d / this.Eval1(this.p + 1, rVal);
            break;
          default:
            return d;
        }
      }
    }
    this.Eval3 = function(p, rVal) {
      var d;
      d = this.Eval2(p, rVal);
      for (; ; ) {
        switch (this.str[this.p]) {
          case '+':
            d += this.Eval2(this.p + 1, rVal);
            break;
          case '-':
            d = d - this.Eval2(this.p + 1, rVal);
            break;
          default:
            return d;
        }
      }
    }
    this.Eval = function(p, rVal) {
      return this.Eval3(p, rVal);
    }
    this.WSprintf = function(rVal) {
      if (this.fx != 0)
        rVal = this.Eval(this.fx, rVal);

      var str = "";
      var pcs = 4;
      var w = 0, z = 0, p = 0;
      for (var i = 0; i < this.fmt.length; ++i) {
        if (this.fmt[i] == "%") {
          var strv = "";
          ++i;
          if (this.fmt[i] == "+") {
            ++i;
            if (rVal >= 0)
              p = 1;
          }
          if (this.fmt[i] == "0") {
            z = 1;
            ++i;
          }
          if (this.Digit(this.fmt[i])) {
            w = this.fmt.charCodeAt(i) - 0x30;
            ++i;
          }
          if (this.fmt[i] == '.') {
            ++i;
            pcs = 0;
            if (this.Digit(this.fmt[i])) {
              pcs = this.fmt.charCodeAt(i) - 0x30;
              ++i;
            }
          }
          switch (this.fmt[i]) {
            case 'd':
              strv = Math.floor(rVal).toString(10);
              break;
            case 'f':
              strv = rVal.toFixed(pcs);
              break;
            case 'x':
              strv = Math.floor(rVal).toString(16);
              break;
            case 'X':
              strv = Math.floor(rVal).toString(16).toUpperCase();
              break;
          }
          if (w) {
            strv = ((z?"00000000":"        ") + strv).substr(-w);
          }
          if (p)
            strv = "+" + strv;
          str += strv;
        }
        else
          str += this.fmt[i];
      }
      return str;
    }
    this.GetANum = function(p) {
      var p;
      var sign, frac, dp;
      var n1;
      sign = 1.0;
      frac = 0.0;
      n1 = 0;
      p = this.Skip(p);
      if (this.str[p] == '-') {
        sign = -1.0;
        ++p;
      }
      p = this.Skip(p);
      while (this.Digit(this.str[p])) {
        n1 = n1 * 10 + this.str.charCodeAt(p) - 0x30;
        ++p;
      }
      if (this.str[p] == '.') {
        ++p;
        dp = 0.1;
        while (this.Digit(this.str[p])) {
          frac += dp * (this.str.charCodeAt(p) - 0x30);
          dp *= 0.1;
          ++p;
        }
      }
      this.p = this.Skip(p);
      return sign * (n1 + frac);
    }
    this.CheckNum = function(p) {
      var r1, r2, r3;
      var iParen = 0;
      this.fx = 0;
      this.fmt = "%d";
      ++p;
      r1 = this.GetANum(p);
      if (this.str[this.p] != ':')
        return -1;
      r2 = this.GetANum(this.p + 1);
      r3 = 1.0;
      if (this.str[this.p] == ':') {
        if (this.Digit(this.str[this.p + 1]) || this.str[this.p + 1] == '.') {
          r3 = this.GetANum(this.p + 1);
        }
        if (this.str[this.p] == ':') {
          ++this.p;
          this.fmt = "";
          while (this.str[this.p] && this.str[this.p] != ')' && this.str[this.p] != ':') {
            this.fmt += this.str[this.p++];
          }
        }
        if (this.str[this.p] == ':') {
          ++this.p;
          this.fx = this.p;
          iParen = 0;
          while (this.str[this.p] && this.str[this.p] != ':') {
            if (this.str[this.p] == '(')
              ++iParen;
            if (this.str[this.p] == ')') {
              if (--iParen < 0)
                break;
            }
            ++this.p;
          }
        }
      }
      if (this.str[this.p] != ')')
        return -1;
      this.pn1 = r1;
      this.pn2 = r2;
      this.pn3 = r3;
      return Math.abs(r1 - r2) / r3;
    }
    this.Count = function() {
      var p;
      var i, j;
      for (p = 0, i = 1; this.str[p]; ) {
        if (this.str[p] == ',')
          ++i;
        else if (this.str[p] == '(') {
          j = this.CheckNum(p);
          p = this.p;
          if (j > 0)
            i += j;
        }
        ++p;
      }
      return i;
    }
    this.GetNext = function(p) {
      var strTemp = "";
      var pStart = p;
      var i;
      var c;
      for (; ; ) {
        if (this.str[p] == '(') {
          i = this.CheckNum(p);
          if (i >= 0) {
            if (this.pn2 >= this.pn1)
              strTemp += this.WSprintf(this.pn1 + this.pi * this.pn3);
            else
              strTemp += this.WSprintf(this.pn1 - this.pi * this.pn3);
            ++this.pi;
            ++this.p;
            while (this.str[this.p] && this.str[this.p] != ',') {
              strTemp += this.str[this.p++];
            }
            if (this.pi > i) {
              this.pi = 0;
              this.p = this.Skip(this.p);
              if (this.str[this.p] == ',')
                ++this.p;
            }
            else
              this.p = pStart;
            return strTemp;
          }
        }
        if (p >= this.str.length)
          break;
        c = this.str[p++];
        if (c == ',')
          break;
        strTemp += c;
      }
      this.p = p;
      return strTemp;
    }
    this.GetItem = function(n) {
      var p = 0;
      this.pi = 0;
      var pItem;
      if (n >= this.total)
        n = this.total - 1;
      for (; n >= 0; --n) {
        pItem = this.GetNext(p);
        p = this.p;
      }
      return pItem;
    }
    this.total = this.Count();
    this.Get = function(frame,maxframe) {
      if (this.total <= 1)
        return this.GetItem(0);
      return this.GetItem(this.total * frame / (maxframe - 1));
    }
  }
  function Prefs() {
    this.alignhorz = 0;
    document.getElementById("orientation").selectedIndex = 0;
//        document.getElementById("alignvert").checked = true;
//        document.getElementById("alignhorz").checked = false;
    this.width = 32;
    this.height = 32;
    this.paramwidth = new ParamV(32, 1, 128, document.prefs.paramwidth, 0);
    this.paramheight = new ParamV(32, 1, 128, document.prefs.paramheight, 0);
    this.framesprev = new ParamV(5,1,101,document.prefs.framesprev, 0);
    this.framesrender = new ParamV(31,1,201,document.prefs.framesrender, 0);
    this.frames = 5;
    this.bkcolor = new Col(255, 255, 255);
    this.bkcolr = new ParamV(255, 0, 255, document.prefs.bkcolr, 0);
    this.bkcolg = new ParamV(255, 0, 255, document.prefs.bkcolg, 0);
    this.bkcolb = new ParamV(255, 0, 255, document.prefs.bkcolb, 0);
    this.Init=function() {
      this.alignhorz=0;
      document.getElementById("orientation").selectedIndex = 0;
//            document.getElementById("alignvert").checked = true;
//            document.getElementById("alignhorz").checked = false;
      this.width=32;
      this.height=32;
      this.paramwidth.SetVal(32);
      this.paramheight.SetVal(32);
      this.framesprev.SetVal(5);
      this.framesrender.SetVal(31);
      this.frames=5;
      this.bkcolor=new Col(255,255,255);
      this.bkcolr.SetVal(255);
      this.bkcolg.SetVal(255);
      this.bkcolb.SetVal(255);
      document.getElementById("imgxylink").checked=true;
      EditPrefs(2);
    }
  }
  function Vector(x, y) {
    this.x = x;
    this.y = y;
    this.Set = function(v) {
      this.x = v.x; this.y = v.y;
    }
    this.Add = function(v) {
      this.x += v.x; this.y += v.y;
    }
    this.Sub = function(v) {
      this.x -= v.x; this.y -= v.y;
    }
    this.Mul = function(v) {
      this.x *= v.x; this.y *= v.y;
    }
    this.Scale = function(t) {
      this.x *= t; this.y *= t;
    }
    this.Div = function(v) {
      this.x /= v.x; this.y /= v.y;
    }
    this.Rotate = function(t) {
      var rSin = Math.sin(t * Math.PI / 180);
      var rCos = Math.cos(t * Math.PI / 180);
      var xx = rCos * this.x + rSin * this.y;
      this.y = rCos * this.y - rSin * this.x;
      this.x = xx;
    }
    this.RotateAt = function(t, vOrig, vAsp) {
      this.Sub(vOrig);
      this.Rotate(t);
      this.Add(vOrig);
    }
    this.Product = function(v) {
      return this.x * v.x + this.y * v.y;
    }
    this.Length2 = function() {
      return this.x * this.x + this.y * this.y;
    }
    this.Abs = function() {
      return Math.sqrt(this.Length2());
    }
    this.Normalize = function() {
      var t = this.Abs();
      this.x /= t;
      this.y /= t;
    }
  }
  function XYMatrix() {
    this.a = new Array(9);
    for (var i = 0; i < 9; ++i)
      this.a[i] = 0;
    this.a[0] = this.a[4] = this.a[8] = 1;
    this.Copy = function(b) {
      for (var i = 0; i < 9; ++i)
        this.a[i] = b.a[i];
    }
    this.Add = function(b) {
      for (var i = 0; i < 9; ++i)
        this.a[i] += b.a[i];
    }
    this.Mul = function(b) {
      var t = new XYMatrix();
      t.a[0] = this.a[0] * b.a[0] + this.a[1] * b.a[3] + this.a[2] * b.a[6];
      t.a[1] = this.a[0] * b.a[1] + this.a[1] * b.a[4] + this.a[2] * b.a[7];
      t.a[2] = this.a[0] * b.a[2] + this.a[1] * b.a[5] + this.a[2] * b.a[8];
      t.a[3] = this.a[3] * b.a[0] + this.a[4] * b.a[3] + this.a[5] * b.a[6];
      t.a[4] = this.a[3] * b.a[1] + this.a[4] * b.a[4] + this.a[5] * b.a[7];
      t.a[5] = this.a[3] * b.a[2] + this.a[4] * b.a[5] + this.a[5] * b.a[8];
      t.a[6] = this.a[6] * b.a[0] + this.a[7] * b.a[3] + this.a[8] * b.a[6];
      t.a[7] = this.a[6] * b.a[1] + this.a[7] * b.a[4] + this.a[8] * b.a[7];
      t.a[8] = this.a[6] * b.a[2] + this.a[7] * b.a[5] + this.a[8] * b.a[8];
      this.Copy(t);
    }
    this.Translate = function(x, y) {
      var t = new XYMatrix();
      t.a[2] = x;
      t.a[5] = y;
      t.Mul(this);
      this.Copy(t);
    }
    this.Rotate = function(r) {
      r = r * Math.PI / 180;
      var t = new XYMatrix();
      t.a[0] = Math.cos(r);
      t.a[1] = Math.sin(r);
      t.a[3] = -t.a[1];
      t.a[4] = t.a[0];
      t.Mul(this);
      this.Copy(t);
    }
    this.Scale = function(x, y) {
      var t = new XYMatrix();
      t.a[0] = x;
      t.a[4] = y;
      t.Mul(this);
      this.Copy(t);
    }
    this.RotateAt = function(r, x, y) {
      var t = new XYMatrix();
      t.Translate(-x, -y);
      t.Rotate(r);
      t.Translate(x, y);
      t.Mul(this);
      this.Copy(t);
    }
    this.ScaleAt = function(sx, sy, x, y) {
      var t = new XYMatrix();
      t.Translate(-x, -y);
      t.Scale(sx, sy);
      t.Translate(x, y);
      t.Mul(this);
      this.Copy(t);
    }
    this.Transform = function(p) {
      var x, y;
      x = p[0] * this.a[0] + p[1] * this.a[1] + this.a[2];
      y = p[0] * this.a[3] + p[1] * this.a[4] + this.a[5];
      p[0] = x, p[1] = y;
    }
  }
  function getXY(e) {
    var rc = e.target.getBoundingClientRect();
    mouseX = Math.floor(e.clientX - rc.left);
    mouseY = Math.floor(e.clientY - rc.top);
    if (mouseX < 0) mouseX = 0;
    if (mouseY < 0) mouseY = 0;
  }
  function Tex(name) {
    this.pdata=0;
    this.adata=0;
    this.init=0;
    this.name="tex-"+name;
    this.width=0;
    this.height = 0;
    this.img = 0;
    this.out4 = function(o, v) {
      o.push(v & 0xff, (v >> 8) & 0xff, (v >> 16) & 0xff, (v >> 24) & 0xff);
    }
    this.GetBmp = function() {
      var xsz = Math.floor((this.width + 3) / 4) * 4;
      var size = 14 + 40 + 4 * 256 + this.height * xsz;
      var ioff = 14 + 40 + 4 * 256;
      var out = Array();
      out.push(0x42, 0x4d);
      this.out4(out, size);
      out.push(0, 0, 0, 0);
      this.out4(out, ioff);
      out.push(40, 0, 0, 0);
      this.out4(out, this.width);
      this.out4(out, this.height);
      out.push(1, 0);
      out.push(8, 0);
      out.push(0, 0, 0, 0);
      out.push(0, 0, 0, 0);
      this.out4(out, 3780);
      this.out4(out, 3780);
      out.push(0, 0, 0, 0, 0, 0, 0, 0);
      for (xx = 0; xx < 256; ++xx)
        out.push(xx, xx, xx, 0);
      for (yy = this.height - 1; yy >= 0; --yy) {
        for (xx = 0; xx < this.width; ++xx) {
          out.push(this.pdata[yy * this.width + xx]);
        }
        while (xx < xsz) {
          out.push(0);
          ++xx;
        }
      }
      return out;
    }
    this.Get = function(x, y, z) {
      if (this.init == 0) {
        this.init = 1;
        if(this.img==0)
          this.img = document.getElementById(this.name);
        if(this.img){
          this.width = this.img.width;
          this.height = this.img.height;
          ctxWork.clearRect(0,0,this.width,this.height);
          ctxWork.drawImage(this.img, 0, 0);
          imgdat = ctxWork.getImageData(0, 0, this.width, this.height);
          this.pdata = new Array(this.width * this.height);
          this.adata = new Array(this.width * this.height);
          p = 0;
          for (yy = 0; yy < this.height; ++yy) {
            for (xx = 0; xx < this.width; ++xx) {
              c = imgdat.data[p + 3] * (imgdat.data[p] * 3 + imgdat.data[p + 1] * 6 + imgdat.data[p + 2]) / 2550;
              this.pdata[yy * this.width + xx] = (Math.min(255,c)|0);
              this.adata[yy * this.width + xx] = ((imgdat.data[p + 3]&0xff)<<24);
              p += 4;
            }
          }
        }
      }
      if (z == 0)
        return 0xff000080;

      x = Math.floor(x * 100 / z+this.width*0.5);
      y = Math.floor(y * 100 / z+this.height*0.5);
      x -= Math.floor(x / this.width) * this.width;
      y -= Math.floor(y / this.height) * this.height;

//            x=((x+this.width*0.1)|0)%this.width;
//            y=((y+this.height*0.1)|0)%this.height;
      var xx=y*this.width+x;
//            return this.adata[xx] + 0x80;
      return this.adata[xx] + this.pdata[xx];
    }
  }
  function Col(r, g, b) {
    this.r = r;
    this.g = g;
    this.b = b;
    this.a=255;
    this.h = 0;
    this.l = 0;
    this.s = 0;
    this.cnt = 0;
    this.SetColStr = function (str){
      if(str.indexOf("rgb(")==0){
        const ss=str.substring(4).split(",");
        this.SetRgb(parseInt(ss[0]), parseInt(ss[1]), parseInt(ss[2]));
        return;
      }
      if(str[0]=="#")
        str=str.substring(1);
      if(str.length>=6){
        this.SetRgb(parseInt(str.substring(0,2),16), parseInt(str.substring(2,4),16), parseInt(str.substring(4,6),16));
        return;
      }
      const r = parseInt(str[0],16);
      const g = parseInt(str[1],16);
      const b = parseInt(str[2],16);
      this.SetRgb(r+(r<<4), g+(g<<4), b+(b<<4));
    }
    this.GetColStr = function() {
      return "#" + ("00" + (this.r | 0).toString(16).toUpperCase()).substr(-2)
         + ("00" + (this.g | 0).toString(16).toUpperCase()).substr(-2)
         + ("00" + (this.b | 0).toString(16).toUpperCase()).substr(-2);
    }
    this.SetRgb = function(r, g, b) {
      this.r = isNaN(r)?0:Math.max(0,Math.min(255,parseInt(r)));
      this.g = isNaN(g)?0:Math.max(0,Math.min(255,parseInt(g)));
      this.b = isNaN(b)?0:Math.max(0,Math.min(255,parseInt(b)));
      this.rgbtohls();
    }
    this.htorgb = function(n1, n2, h) {
      while (h < 0)
        h += 240;
      while (h > 240)
        h -= 240;
      if (h < (240 / 6))
        return (n1 + (((n2 - n1) * h + (240 / 12)) / (240 / 6)));
      if (h < (240 / 2))
        return (n2);
      if (h < ((240 * 2) / 3))
        return (n1 + (((n2 - n1) * (((240 * 2) / 3) - h) + (240 / 12)) / (240 / 6)));
      else
        return (n1);
    }
    this.SetHls = function(h, l, s) {
      var tmp1, tmp2;
      h = Math.max(0,Math.min(255,parseFloat(h)));
      l = Math.max(0,Math.min(255,parseFloat(l)));
      s = Math.max(0,Math.min(255,parseFloat(s)));
      this.h = h;
      this.l = l;
      this.s = s;
      if (l > 240)
        l = 240;
      if (l < 0)
        l = 0;
      if (s > 240)
        s = 240;
      if (s <= 0)
        this.r = this.g = this.b = l * 255 / 240;
      else {
        if (l <= 120)
          tmp2 = (l * (240 + s) + 120) / 240;
        else
          tmp2 = l + s - ((l * s) + 120) / 240;
        tmp1 = 2 * l - tmp2;
        this.r = Math.min(255,((this.htorgb(tmp1, tmp2, h + (240 / 3)) * 255 + (240 / 2)) / 240)|0);
        this.g = Math.min(255,((this.htorgb(tmp1, tmp2, h) * 255 + (240 / 2)) / 240)|0);
        this.b = Math.min(255,((this.htorgb(tmp1, tmp2, h - (240 / 3)) * 255 + (240 / 2)) / 240)|0);
      }
    }
    this.SetCol = function(c) {
      this.r = c.r;
      this.g = c.g;
      this.b = c.b;
      this.a = c.a;
    }
    this.rgbtohls = function() {
      var cmax = Math.max(Math.max(this.r, this.g), this.b);
      var cmin = Math.min(Math.min(this.r, this.g), this.b);
      this.l = ((cmax + cmin) * 240 + 255) / (2 * 255);
      if (cmax == cmin) {
        this.h = this.s = 0;
      }
      else {
        if (this.l < 120)
          this.s = ((cmax - cmin) * 240 + (cmax + cmin) / 2) / (cmax + cmin);
        else
          this.s = ((cmax - cmin) * 240 + ((2 * 255 - cmax - cmin) / 2)) / (2 * 255 - cmax - cmin);
        rr = (((cmax - this.r) * 40) + (cmax - cmin) / 2) / (cmax - cmin);
        gg = (((cmax - this.g) * 40) + (cmax - cmin) / 2) / (cmax - cmin);
        bb = (((cmax - this.b) * 40) + (cmax - cmin) / 2) / (cmax - cmin);
        if (this.r == cmax)
          this.h = bb - gg;
        else if (this.g == cmax)
          this.h = 80 + rr - bb;
        else
          this.h = 160 + gg - rr;
        if (this.h < 0)
          this.h += 240;
        if (this.h > 240)
          this.h -= 240;
      }
    }
    this.ChangeBrightness = function(n) {
      this.r += n;
      this.r = Math.max(0, Math.min(255, this.r));
      this.g += n;
      this.g = Math.max(0, Math.min(255, this.g));
      this.b += n;
      this.b = Math.max(0, Math.min(255, this.b));
    }
    this.BlendTo=function(r,g,b,a) {
      this.r=(this.r*(256-a)+r*a)/256;
      this.g=(this.g*(256-a)+g*a)/256;
      this.b=(this.b*(256-a)+b*a)/256;
    }
    this.Bright=function(a) {
      this.r=this.r*a/255;
      this.g=this.g*a/255;
      this.b=this.b*a/255;
    }
    this.Copy = function(c) {
      this.r = c.r;
      this.g = c.g;
      this.b = c.b;
      this.a = c.a;
    }
    this.Blend4 = function(c01, c10, c11, x, y) {
      var a0, a1;
      a0 = this.r + (c01.r - this.r) * x;
      a1 = c10.r + (c11.r - c10.r) * x;
      this.r = a0 + (a1 - a0) * y;
      a0 = this.g + (c01.g - this.g) * x;
      a1 = c10.g + (c11.g - c10.g) * x;
      this.g = a0 + (a1 - a0) * y;
      a0 = this.b + (c01.b - this.b) * x;
      a1 = c10.b + (c11.b - c10.b) * x;
      this.b = a0 + (a1 - a0) * y;
      a0 = this.a + (c01.a - this.a) * x;
      a1 = c10.a + (c11.a - c10.a) * x;
      this.a = a0 + (a1 - a0) * y;
    }
    this.Conv = function(b, c, s, h) {
      h *= (240 / 360);
      this.rgbtohls();
      this.l = (this.l - 120) * (c + 100) / 100 + 120;
      this.l += b * 240 / 100;
      if (this.l >= 240)
        this.l = 239;
      if (this.l < 0)
        this.l = 0;
      this.s = this.s * (s + 100) / 100;
      this.h += h;
      this.SetHls(this.h, this.l, this.s);
    }
    this.GetPix = function(img, p) {
      this.r = img.data[p];
      this.g = img.data[p + 1];
      this.b = img.data[p + 2];
      this.a = img.data[p + 3];
    }
    this.SetPix = function(img, p) {
      img.data[p] = this.r;
      img.data[p + 1] = this.g;
      img.data[p + 2] = this.b;
      img.data[p + 3] = this.a;
    }
    this.AddPix = function(img, p) {
      if (this.a >= 255 || img.data[p + 3] == 0)
        this.SetPix(img, p);
      else {
        var r = this.a / 255;
        img.data[p] += (this.r - img.data[p]) * r;
        img.data[p + 1] += (this.g - img.data[p + 1]) * r;
        img.data[p + 2] += (this.b - img.data[p + 2]) * r;
        img.data[p + 3] += (255 - img.data[p + 3]) * r;
      }
    }
    this.MulAddPix = function(img, imgMask,pD,pM) {
      if (this.a <= 0)
        return;
      this.a = this.a * imgMask.data[pM + 3] / 255;
      if (this.a >= 255 || img.data[pD + 3] == 0)
        this.SetPix(img, pD);
      else {
        var r = this.a / 255;
        img.data[pD] += (this.r - img.data[pD]) * r;
        img.data[pD + 1] += (this.g - img.data[pD + 1]) * r;
        img.data[pD + 2] += (this.b - img.data[pD + 2]) * r;
        img.data[pD + 3] += (255 - img.data[pD + 3]) * r;
      }
    }
    this.Reset = function() {
      this.r=this.g=this.b=this.a=this.cnt=0;
    }
    this.AddVal=function(img,x,y) {
      p=(img.width*y+x)*4;
      this.r+=img.data[p];
      this.g+=img.data[p+1];
      this.b+=img.data[p+2];
      this.a+=img.data[p+3];
      ++this.cnt;
    }
    this.SetAve=function(img,x,y) {
      p=(img.width*y+x)*4;
      img.data[p]=this.r/this.cnt;
      img.data[p+1]=this.g/this.cnt;
      img.data[p+2]=this.b/this.cnt;
      img.data[p+3]=this.a/this.cnt;
    }
  }
  function ParamCol(defr, defg, defb, fcv, fh, fl, fs, fr, fg, fb) {
    this.col = new Col(defr, defg, defb);
    this.fcv = fcv; this.fh = fh; this.fl = fl; this.fs = fs; this.fr = fr; this.fg = fg; this.fb = fb;

    this.Disp = function() {
      this.fr.value = this.col.r;
      this.fg.value = this.col.g;
      this.fb.value = this.col.b;
      this.fh.value = this.col.h;
      this.hl.value = this.col.l;
      this.hs.value = this.col.s;
    }
  }
  class ParamV {
    constructor(def,mn,mx,f,dig,data,name){
      this.min = mn;
      this.max = mx;
      this.form = f;
      if(dig)
        this.dig = dig;
      else
        this.dig = 0;
      if(data){
        this.data = data;
        this.name = name;
        this.data[this.name] = def;
      }
      else{
        this._val = def;
      }
    }
    get val(){
      if(this.data)
        return this.data[this.name];
      return this._val;
    }
    set val(v){
      if(this.data)
        this.data[this.name] = v;
      this._val = v;
    }
    Set() {
      this.val = parseFloat(this.form.value);
      if (this.val < this.min)
        this.val = this.min;
      if (this.val > this.max)
        this.val = this.max;
      this.form.value = this.val.toFixed(this.dig);
    }
    Disp() {
      this.form.value = this.val.toFixed(this.dig);
      this.form.param = this;
    }
    SetVal(v) {
      this.form.value=v.toFixed(this.dig);
      this.Set();
    }
  };
  function ParamC(def, f) {
    this.val = def;
    this.form = f;
    this.Set = function() {
      this.val = this.form.checked ? 1 : 0;
    }
    this.Disp = function() {
      this.form.checked=(this.val?true:false);
    }
  }
  function ParamS(def, f) {
    this.val = def;
    this.form = f;
    this.Set = function() {
      this.val = this.form.selectedIndex;
    }
    this.Disp = function() {
      this.form.selectedIndex = this.val;
    }
  }
  function ParamT(def,f) {
    this.val = def;
    this.form = f;
    this.Set = function() {
      this.val = this.form.value;
    }
    this.Disp = function() {
      this.form.value = this.val;
    }
  }
  var pxold,pyold;
  document.onmousemove = function(ev) {
    var px = 0;
    var py = 0;
    if (ev == 0)
      ev = window.event;
    if (!ev.pageX)
      px = ev.clientX + document.body.scrollLeft;
    else
      px = ev.pageX;
    if (!ev.pageY)
      py = ev.clientY + document.body.scrollTop;
    else
      py = ev.pageY;
    if(px!=pxold || py!=pyold){
      if (dragType != "") {
        switch (dragType) {
        case "param":
          if (dragy0 == 0) {
            dragy0 = py;
            dragv0 = parseFloat(paramDrag.value);
          }
          if(ev.shiftKey)
            paramDrag.value = dragv0 + (dragy0 - py)*0.01;
          else
            paramDrag.value = dragv0 + dragy0 - py;
          switch (paramGroup) {
            case 0:
              EditPrefs(1);
              break;
            case 1:
              EditPrim(1);
              break;
            case 2:
              EditEff(1);
              break;
          }
          break;
/*
        case "colormap":
          paramDrag.SetHls(px, 120, 240 - py);
          RedrawLayer(1);
          break;
*/
        }
      }
      pxold=px,pyold=py;
    }
  }
  document.onmouseup = function() {
    if (paramGroup == 0) {
      EditPrefs(2);
    }
    paramGroup = -1;
    paramDrag = 0;
    dragType = "";
//        colorMapEdit = 0;
  }
  function EditValue(ev,grp) {
    paramDrag = ev;
    paramGroup = grp;
    dragType = "param";
    dragy0 = 0;
    ev.focus();
    event.preventDefault();
  }
/*
  class ColorMapControl{
    constructor(elem){
      this.elem = elem;
      elem.innerHTML = `<div style="width:250px;height:220px;position:relative">
          <div style="width:100px;float:left">Color:</div><input style="width:150px;height:22px;background:#ffffff"/>
          <canvas width="140" height="120" style="position:absolute;top:30px;left:0px"></canvas>
          <div style="position:absolute;top:23px;left:150px">H :</div>
          <div style="position:absolute;top:23px;left:180px"><input size="3"/></div>
          <div style="position:absolute;top:46px;left:150px">L :</div>
          <div style="position:absolute;top:46px;left:180px"><input size="3"/></div>
          <div style="position:absolute;top:69px;left:150px">S :</div>
          <div style="position:absolute;top:69px;left:180px"><input size="3"/></div>
          <div style="position:absolute;top:92px;left:150px">R :</div>
          <div style="position:absolute;top:92px;left:180px"><input size="3"/></div>
          <div style="position:absolute;top:115px;left:150px">G :</div>
          <div style="position:absolute;top:115px;left:180px"><input size="3"/></div>
          <div style="position:absolute;top:138px;left:150px">B :</div>
          <div style="position:absolute;top:138px;left:180px"><input size="3"/></div>
          <button style="position:absolute;top:170px;left:0px;width:23px;height:16px;background:#000000"></button>
          <button style="position:absolute;top:170px;left:25px;width:23px;height:16px;background:#000080"></button>
          <button style="position:absolute;top:170px;left:50px;width:23px;height:16px;background:#008000"></button>
          <button style="position:absolute;top:170px;left:75px;width:23px;height:16px;background:#008080"></button>
          <button style="position:absolute;top:170px;left:100px;width:23px;height:16px;background:#800000"></button>
          <button style="position:absolute;top:170px;left:125px;width:23px;height:16px;background:#800080"></button>
          <button style="position:absolute;top:170px;left:150px;width:23px;height:16px;background:#808000"></button>
          <button style="position:absolute;top:170px;left:175px;width:23px;height:16px;background:#808080"></button>
          <button style="position:absolute;top:190px;left:0px;width:23px;height:16px;background:#c0c0c0"></button>
          <button style="position:absolute;top:190px;left:25px;width:23px;height:16px;background:#0000ff"></button>
          <button style="position:absolute;top:190px;left:50px;width:23px;height:16px;background:#00ff00"></button>
          <button style="position:absolute;top:190px;left:75px;width:23px;height:16px;background:#00ffff"></button>
          <button style="position:absolute;top:190px;left:100px;width:23px;height:16px;background:#ff0000"></button>
          <button style="position:absolute;top:190px;left:125px;width:23px;height:16px;background:#ff00ff"></button>
          <button style="position:absolute;top:190px;left:150px;width:23px;height:16px;background:#ffff00""></button>
          <button style="position:absolute;top:190px;left:175px;width:23px;height:16px;background:#ffffff""></button>
        </div>`;
      this.cv = elem.getElementsByTagName("canvas")[0];
      this.inputs = elem.getElementsByTagName("input");
      this.inputs[0].addEventListener("change",()=>{this.SetColStr(this.inputs[0].value)});
      for(let i=1;i<=3;++i)
        this.inputs[i].addEventListener("change",()=>{this.SetHls(this.inputs[1].value,this.inputs[2].value,this.inputs[3].value)});
      for(let i=4;i<=6;++i)
        this.inputs[i].addEventListener("change",()=>{this.SetRgb(this.inputs[4].value,this.inputs[5].value,this.inputs[6].value)});
      const btns = elem.getElementsByTagName("button");
      for(let x = 0; x < btns.length; ++x){
        btns[x].addEventListener("click",(event)=>{
          this.SetColStr(event.target.style.backgroundColor);
        });
      }
      this.ctxMap = this.cv.getContext("2d");
      this.imgdatMap = this.ctxMap.getImageData(0, 0, 120, 120);
      const col = new Col(0, 0, 0);
      let p = 0;
      for (let y = 0; y < 120; ++y) {
        for (let x = 0; x < 120; ++x) {
          col.SetHls(x * 2, 120, 238 - y * 2);
          this.imgdatMap.data[p] = col.r;
          this.imgdatMap.data[p + 1] = col.g;
          this.imgdatMap.data[p + 2] = col.b;
          this.imgdatMap.data[p + 3] = 255;
          p += 4;
        }
      }
      this.ctxMap.putImageData(this.imgdatMap, 0, 0);
      this.imgdatBar = this.ctxMap.getImageData(130, 0, 10, 120);
      this.cv.onmousedown = this.MouseDown.bind(this);
      this.MouseMoveBind = this.MouseMove.bind(this);
      this.MouseUpBind = this.MouseUp.bind(this);
      this.col = new Col(0, 0, 0,);
      this.drag = 0;
      this.Disp();
    }
    GetXY(ev){
      const rc = this.cv.getBoundingClientRect();
      const px = Math.max(0, Math.min(120, Math.floor(ev.clientX - rc.left)));
      const py = 120 - Math.max(0, Math.min(120, Math.floor(ev.clientY - rc.top)));
      return {x:px, y:py};
    }
    MouseDown(ev){
      if(ev.buttons==1){
        document.addEventListener("mousemove",this.MouseMoveBind);
        document.addEventListener("mouseup",this.MouseUpBind);
        const pos = this.GetXY(ev);
        this.drag = (pos.x >= 120) ? 2 : 1;
        this.MouseMove(ev);
      }
    }
    MouseMove(ev){
      const p = this.GetXY(ev);
      switch(this.drag){
      case 1:
        this.SetHls(p.x * 2, this.col.l, p.y * 2);
        break;
      case 2:
        this.SetHls(this.col.h, p.y * 2, this.col.s);
        break;
      }
    }
    MouseUp(ev){
      this.drag = 0;
      document.removeEventListener("mousemove", this.MouseMoveBind);
      document.removeEventListener("mosueup", this.MouseUpBind);
    }
    SetHls(h,l,s){
      this.col.SetHls(h,l,s);
      this.Disp();
      this.SendEvent();
    }
    SetRgb(r,g,b){
      this.col.SetRgb(r,g,b);
      this.Disp();
      this.SendEvent();
    }
    SetCol(c){
      this.col = c;
      this.Disp();
      this.SendEvent();
    }
    SetColStr(s){
      this.col.SetColStr(s);
      this.Disp();
      this.SendEvent();
    }
    ColorBar(c){
      const col = new Col(0, 0, 0);
      let p = 0;
      for (let y = 0; y < 120; ++y) {
        col.SetHls(c.h, (119 - y) * 2, c.s);
        for (let x = 0; x < 10; ++x) {
          this.imgdatBar.data[p] = col.r;
          this.imgdatBar.data[p + 1] = col.g;
          this.imgdatBar.data[p + 2] = col.b;
          this.imgdatBar.data[p + 3] = 255;
          p += 4;
        }
      }
      this.ctxMap.putImageData(this.imgdatBar, 130, 0);
    }
    SendEvent(){
      const e = document.createEvent("HTMLEvents");
      e.initEvent("change",true,true);
      this.elem.dispatchEvent(e);
    }
    Disp(){
      this.ctxMap.putImageData(this.imgdatMap, 0, 0);
      this.ColorBar(this.col);
      this.ctxMap.fillStyle="#ffffff";
      this.ctxMap.fillRect(this.col.h*0.5-10, 119-this.col.s*0.5, 20, 2);
      this.ctxMap.fillRect(this.col.h*0.5-1, 119-this.col.s*0.5-10, 2, 20);
      this.ctxMap.clearRect(120,0,10,120);
      this.ctxMap.beginPath();
      const py = 120-this.col.l*0.5;
      this.ctxMap.moveTo(130, py);
      this.ctxMap.lineTo(120, py + 5);
      this.ctxMap.lineTo(120, py - 5);
      this.ctxMap.closePath();
      this.ctxMap.fill();
      this.inputs[0].style.color= ((this.col.r * 3 + this.col.g * 6 + this.col.b) > 1280) ? "#000000":"#ffffff"; 
      this.inputs[0].style.background=this.col.GetColStr();
      this.inputs[0].value = this.col.GetColStr();
      this.inputs[1].value = Math.min(240,this.col.h|0);
      this.inputs[2].value = Math.min(240,this.col.l|0);
      this.inputs[3].value = Math.min(240,this.col.s|0);
      this.inputs[4].value = Math.min(255,this.col.r|0);
      this.inputs[5].value = Math.min(255,this.col.g|0);
      this.inputs[6].value = Math.min(255,this.col.b|0);
    }
  };
*/
  function SetupColorVal(c) {
    colorMap.SetRgb(c.r, c.g, c.b);
/*
    document.prim.colh.value = c.h | 0;
    document.prim.coll.value = c.l | 0;
    document.prim.cols.value = c.s | 0;
    document.prim.colr.value = c.r | 0;
    document.prim.colg.value = c.g | 0;
    document.prim.colb.value = c.b | 0;
    var b=document.prim.colorbutton;
    var s = layers[curLayer].prim.color.GetColStr();
    if (c.g*6+c.r*3+c.b > 1280)
      b.style.color = "#000000";
    else
      b.style.color = "#ffffff";
    b.style.background = s;
    b.value = s;
*/
  }
  function SetupColorFromText(){
/*
    const s=document.prim.colorbutton.value;
    layers[curLayer].prim.color.SetColStr(s);
    document.prim.colorbutton.value=layers[curLayer].prim.color.GetColStr();
    SetupColorVal(layers[curLayer].prim.color);
    RedrawLayer(1);
*/
  }
/*
  function ColorMapDown(ev) {
    if (curLayer >= 0) {
      layers[curLayer].prim.color.rgbtohls();
      getXY(ev);
      if (mouseX >= 120)
        colorMapEdit = 2;
      else
        colorMapEdit = 1;
      ColorMapMove(ev);
    }
  }
  function ColorMapMove(ev) {
    if (curLayer >= 0) {
      getXY(ev);
      switch (colorMapEdit) {
        case 1:
          let x = mouseX * 2;
          if (x > 240)
            x = 240;
          const y = (120 - mouseY) * 2;
          layers[curLayer].prim.color.SetHls(layers[curLayer].prim.color.h = x, layers[curLayer].prim.color.l, layers[curLayer].prim.color.s = y);
          ColorBar(layers[curLayer].prim.color);
          SetupColorVal(layers[curLayer].prim.color);
          RedrawLayer(1);
          ctxColorMap.putImageData(imgdatColorMap, 0, 0);
          ctxColorMap.fillRect(mouseX, mouseY-10, 2, 20);
          ctxColorMap.fillRect(mouseX-10, mouseY, 20, 2);
          console.log(x,y,ctxColorMap);
          break;
        case 2:
          layers[curLayer].prim.color.SetHls(layers[curLayer].prim.color.h, layers[curLayer].prim.color.l = 238 - mouseY * 2, layers[curLayer].prim.color.s);
          SetupColorVal(layers[curLayer].prim.color);
          RedrawLayer(1);
          break;
      }
    }
  }
  function ColorMapUp(ev) {
    colorMapEdit = 0;
  }
*/
  function Eff() {
    this.data = {};
    this.antialias = new ParamC(1, document.eff.antialias, this.data, "antialias");
    this.unfold = new ParamC(0, document.eff.unfold, this.data, "unfold");
    this.animstep = new ParamV(0, 0, 50, document.eff.animstep, 0, this.data, "animstep");
    this.zoomxysepa = new ParamC(0,document.eff.zoomxysepa, this.data, "zoomxysepa");
    this.zoomxf = new ParamV(100, 0, 100, document.eff.zoomxf, 2, this.data, "zoomxf");
    this.zoomxt = new ParamV(100, 0, 100, document.eff.zoomxt, 2, this.data, "zoomxt");
    this.zoomxanim = new ParamS(0, document.eff.zoomxanim, this.data, "zoomxanim");
    this.zoomyf = new ParamV(100, 0, 100, document.eff.zoomyf, 2, this.data, "zoomyf");
    this.zoomyt = new ParamV(100, 0, 100, document.eff.zoomyt, 2, this.data, "zoomyt");
    this.zoomyanim = new ParamS(0, document.eff.zoomyanim, this.data, "zoomyanim");
    this.offxf = new ParamV(0, -250, 250, document.eff.offxf, 2, this.data, "offxf");
    this.offxt = new ParamV(0, -250, 250, document.eff.offxt, 2, this.data, "offxt");
    this.offxanim = new ParamS(0, document.eff.offxanim, this.data, "offxanim");
    this.offyf = new ParamV(0, -250, 250, document.eff.offyf, 2, this.data, "offyf");
    this.offyt = new ParamV(0, -250, 250, document.eff.offyt, 2, this.data, "offyt");
    this.offyanim = new ParamS(0, document.eff.offyanim, this.data, "offyanim");
    this.keepdir = new ParamC(0, document.eff.keepdir, this.data, "keepdir");
    this.centerx = new ParamV(0, -250, 250, document.eff.centerx, 2, this.data, "centerx");
    this.centery = new ParamV(0, -250, 250, document.eff.centery, 2, this.data, "centery");
    this.anglef = new ParamV(0, -1800, 1800, document.eff.anglef, 2, this.data, "anglef");
    this.anglet = new ParamV(0, -1800, 1800, document.eff.anglet, 2, this.data, "anglet");
    this.angleanim = new ParamS(0, document.eff.angleanim, this.data, "angleanim");
    this.alphaf = new ParamV(100, 0, 100, document.eff.alphaf, 2, this.data, "alphaf");
    this.alphat = new ParamV(100, 0, 100, document.eff.alphat, 2, this.data, "alphat");
    this.alphaanim = new ParamS(0, document.eff.alphaanim, this.data, "alphaanim");
    this.brightf = new ParamV(0, -100, 100, document.eff.brightf, 2, this.data, "brightf");
    this.brightt = new ParamV(0, -100, 100, document.eff.brightt, 2, this.data, "brightt");
    this.brightanim = new ParamS(0, document.eff.brightanim, this.data, "brightanim");
    this.contrastf = new ParamV(0, -100, 100, document.eff.contrastf, 2, this.data, "contrastf");
    this.contrastt = new ParamV(0, -100, 100, document.eff.contrastt, 2, this.data, "contrastt");
    this.contrastanim = new ParamS(0, document.eff.contrastanim, this.data, "contrastanim");
    this.saturationf = new ParamV(0, -100, 100, document.eff.saturationf, 2, this.data, "saturationf");
    this.saturationt = new ParamV(0, -100, 100, document.eff.saturationt, 2, this.data, "saturationt");
    this.saturationanim = new ParamS(0, document.eff.saturationanim, this.data, "saturationanim");
    this.huef = new ParamV(0, -360, 360, document.eff.huef, 2, this.data, "huef");
    this.huet = new ParamV(0, -360, 360, document.eff.huet, 2, this.data, "huet");
    this.hueanim = new ParamS(0, document.eff.hueanim, this.data, "hueanim");
    this.mask1ena = new ParamC(0, document.eff.mask1ena, this.data, "mask1ena");
    this.mask1type = new ParamS(0, document.eff.mask1type, this.data, "mask1type");
    this.mask1grad = new ParamV(0, 0, 100, document.eff.mask1grad, 2, this.data, "mask1grad");
    this.mask1graddir = new ParamS(0, document.eff.mask1graddir, this.data, "mask1graddir");
    this.mask1startf = new ParamV(-140, -1800, 1800, document.eff.mask1startf, 2, this.data, "mask1startf");
    this.mask1startt = new ParamV(-140, -1800, 1800, document.eff.mask1startt, 2, this.data, "mask1startt");
    this.mask1startanim = new ParamS(0, document.eff.mask1startanim, this.data, "mask1startanim");
    this.mask1stopf = new ParamV(140, -1800, 1800, document.eff.mask1stopf, 2, this.data, "mask1stopf");
    this.mask1stopt = new ParamV(140, -1800, 1800, document.eff.mask1stopt, 2, this.data, "mask1stopt");
    this.mask1stopanim = new ParamS(0, document.eff.mask1stopanim, this.data, "mask1stopanim");
    this.mask2ena = new ParamC(0, document.eff.mask2ena, this.data, "mask2ena");
    this.mask2op = new ParamS(0, document.eff.mask2op, this.data, "mask2op");
    this.mask2type = new ParamS(0, document.eff.mask2type, this.data, "mask2type");
    this.mask2grad = new ParamV(0, 0, 100, document.eff.mask2grad, 2, this.data, "mask2grad");
    this.mask2graddir = new ParamS(0, document.eff.mask2graddir, this.data, "mask2graddir");
    this.mask2startf = new ParamV(-140, -1800, 1800, document.eff.mask2startf, 2, this.data, "mask2startf");
    this.mask2startt = new ParamV(-140, -1800, 1800, document.eff.mask2startt, 2, this.data, "mask2startt");
    this.mask2startanim = new ParamS(0, document.eff.mask2startanim, this.data, "mask2startanim");
    this.mask2stopf = new ParamV(140, -1800, 1800, document.eff.mask2stopf, 2, this.data, "mask2stopf");
    this.mask2stopt = new ParamV(140, -1800, 1800, document.eff.mask2stopt, 2, this.data, "mask2stopt");
    this.mask2stopanim = new ParamS(0, document.eff.mask2stopanim, this.data, "mask2stopanim");
    this.fmaskena = new ParamS(0, document.eff.fmaskena, this.data, "fmaskena");
    this.fmaskstart = new ParamV(0, 0, 100, document.eff.fmaskstart, 2, this.data, "fmaskstart");
    this.fmaskstop = new ParamV(0, 0, 100, document.eff.fmaskstop, 2, this.data, "fmaskstop");
    this.fmaskbits = new ParamT("11111",document.eff.fmaskbits);
    this.slightdirf = new ParamV(-45, -360, 360, document.eff.slightdirf, 2, this.data, "slightdirf");
    this.slightdirt = new ParamV(-45, -360, 360, document.eff.slightdirt, 2, this.data, "slightdirt");
    this.slightdiranim = new ParamS(0, document.eff.slightdiranim, this.data, "slightdiranim");
    this.sdensityf = new ParamV(0, -100, 100, document.eff.sdensityf, 2, this.data, "sdensityf");
    this.sdensityt = new ParamV(0, -100, 100, document.eff.sdensityt, 2, this.data, "sdensityt");
    this.sdensityanim = new ParamS(0, document.eff.sdensityanim, this.data, "sdensityanim");
    this.dlightdirena = new ParamC(0, document.eff.dlightdirena, this.data, "dlightdirena");
    this.dlightdirf = new ParamV(-45, -360, 360, document.eff.dlightdirf, 2, this.data, "dlightdirf");
    this.dlightdirt = new ParamV(-45, -360, 360, document.eff.dlightdirt, 2, this.data, "dlightdirt");
    this.dlightdiranim = new ParamS(0, document.eff.dlightdiranim, this.data, "dlightdiranim");
    this.doffsetf = new ParamV(5, -100, 100, document.eff.doffsetf, 2, this.data, "doffsetf");
    this.doffsett = new ParamV(5, -100, 100, document.eff.doffsett, 2, this.data, "doffsett");
    this.doffsetanim = new ParamS(0, document.eff.doffsetanim, this.data, "doffsetanim");
    this.ddensityf = new ParamV(0, -100, 100, document.eff.ddensityf, 2, this.data, "ddensityf");
    this.ddensityt = new ParamV(0, -100, 100, document.eff.ddensityt, 2, this.data, "ddensityt");
    this.ddensityanim = new ParamS(0, document.eff.ddensityanim, this.data, "ddensityanim");
    this.ddiffusef = new ParamV(20, 0, 100, document.eff.ddiffusef, 2, this.data, "ddiffusef");
    this.ddiffuset = new ParamV(20, 0, 100, document.eff.ddiffuset, 2, this.data, "ddiffuset");
    this.ddiffuseanim = new ParamS(0, document.eff.ddiffuseanim, this.data, "ddiffuseanim");
    this.dstype = new ParamS(0, document.eff.dstype, this.data, "dstype");
    this.dsgrad = new ParamV(100, 0, 100, document.eff.dsgrad, 2, this.data, "dsgrad");
    this.ilightdirena = new ParamC(0, document.eff.ilightdirena, this.data, "ilightdirena");
    this.ilightdirf = new ParamV(-45, -360, 360, document.eff.ilightdirf, 2, this.data, "ilightdirf");
    this.ilightdirt = new ParamV(-45, -360, 360, document.eff.ilightdirt, 2, this.data, "ilightdirt");
    this.ilightdiranim = new ParamS(0, document.eff.ilightdiranim, this.data, "ilightdiranim");
    this.ioffsetf = new ParamV(5, -100, 100, document.eff.ioffsetf, 2, this.data, "ioffsetf");
    this.ioffsett = new ParamV(5, -100, 100, document.eff.ioffsett, 2, this.data, "ioffsett");
    this.ioffsetanim = new ParamS(0, document.eff.ioffsetanim, this.data, "ioffsetanim");
    this.idensityf = new ParamV(0, -100, 100, document.eff.idensityf, 2, this.data, "idensityf");
    this.idensityt = new ParamV(0, -100, 100, document.eff.idensityt, 2, this.data, "idensityt");
    this.idensityanim = new ParamS(0, document.eff.idensityanim, this.data, "idensityanim");
    this.idiffusef = new ParamV(20, 0, 100, document.eff.idiffusef, 2, this.data, "idiffusef");
    this.idiffuset = new ParamV(20, 0, 100, document.eff.idiffuset, 2, this.data, "idiffuset");
    this.idiffuseanim = new ParamS(0, document.eff.idiffuseanim, this.data, "idiffuseanim");
    this.elightdirena = new ParamC(0, document.eff.elightdirena, this.data, "elightdirena");
    this.elightdirf = new ParamV(-45, -360, 360, document.eff.elightdirf, 2, this.data, "elightdirf");
    this.elightdirt = new ParamV(-45, -360, 360, document.eff.elightdirt, 2, this.data, "elightdirt");
    this.elightdiranim = new ParamS(0, document.eff.elightdiranim, this.data, "elightdiranim");
    this.eoffsetf = new ParamV(20, -100, 100, document.eff.eoffsetf, 2, this.data, "eoffsetf");
    this.eoffsett = new ParamV(20, -100, 100, document.eff.eoffsett, 2, this.data, "eoffsett");
    this.eoffsetanim = new ParamS(0, document.eff.eoffsetanim, this.data, "eoffsetanim");
    this.edensityf = new ParamV(0, -100, 100, document.eff.edensityf, 2, this.data, "edensityf");
    this.edensityt = new ParamV(0, -100, 100, document.eff.edensityt, 2, this.data, "edensityt");
    this.edensityanim = new ParamS(0, document.eff.edensityanim, this.data, "edensityanim");
  }
  function Primitive() {
    this.data = {};
    this.type = new ParamS(0, document.getElementById("typesel"));
    this.color = new Col(255, 0, 0);
    this.aspect = new ParamV(0, -100, 100, document.prim.aspect, 2, this.data, "aspect");
    this.round=new ParamV(0,0,100,document.prim.round, 2);
    this.width = new ParamV(10, 1, 100, document.prim.width, 2);
    this.length = new ParamV(50, 0, 100, document.prim.length, 2);
    this.step = new ParamV(20, 1, 100, document.prim.step, 2);
    this.anglestep = new ParamV(45, -135, 135, document.prim.anglestep, 2);
    this.emboss = new ParamV(0, -100, 100, document.prim.emboss, 2);
    this.embossdiffuse = new ParamV(0, 0, 100, document.prim.embossdiffuse, 2);
    this.ambient=new ParamV(50,0,100,document.prim.ambient, 2);
    this.lightdir=new ParamV(-50,-100,100,document.prim.lightdir, 2);
    this.specular = new ParamV(0, 0, 100, document.prim.specular, 2);
    this.specularwidth = new ParamV(50, 0, 100, document.prim.specularwidth, 2);
    this.texturename = "";
    this.texturefile = new ParamS(0, document.getElementById("texturesel"));
    this.texturedepth = new ParamV(0, 0, 100, document.prim.texturedepth, 2);
    this.texturezoom = new ParamV(100, 1, 400, document.prim.texturezoom, 2);
    this.diffuse = new ParamV(0, 0, 100, document.prim.diffuse, 2);
    this.colh = new ParamV(0, 0, 240, document.prim.colh, 0);
    this.coll = new ParamV(120, 0, 240, document.prim.coll, 0);
    this.cols = new ParamV(240, 0, 240, document.prim.cols, 0);
    this.colr = new ParamV(255, 0, 255, document.prim.colr, 0);
    this.colg = new ParamV(0, 0, 255, document.prim.colg, 0);
    this.colb = new ParamV(0, 0, 255, document.prim.colb, 0);
    this.text = new ParamT("(1:99)",document.prim.texts);
    this.font = new ParamS(0, document.prim.font);
    this.fontsize = new ParamV(50, 1, 100, document.prim.fontsize, 2);
    this.bold = new ParamC(0, document.prim.bold);
    this.italic = new ParamC(0, document.prim.italic);
    this.textalign = new ParamS(0, document.prim.textalign);
    this.shape = new ParamT("", document.prim.shape);
    this.fill = new ParamC(1, document.getElementById("shapefill"));

    this.imgdat = ctxPrevFrom.createImageData(prefs.width, prefs.height);
    this.tex0 = new Tex("None");
    this.tex = this.tex0;
    this.image = "AA";
    this.SetSize = function() {
      this.imgdat = ctxPrevFrom.createImageData(prefs.width, prefs.height);
      this.Render();
    }
    this.RenderShape = function() {
      function scalex(x) {
        return (x - 128) / 256 * prefs.width;
      }
      function scaley(y) {
        return (y - 128) / 256 * prefs.height;
      }
      var col = new Col(this.color.r, this.color.g, this.color.b);
      ctxWork.clearRect(0, 0, prefs.width, prefs.height);
      ctxWork.fillStyle = ctxWork.strokeStyle = "#0000ff";
      if (this.fill.val) {
        ctxWork.globalCompositeOperation="xor";
        var n;
        n=0;
        do {
          n=shapeeditor.MakePath(ctxWork, this.shape.val, this.fill.val, 1,n);
          var dw = Math.floor(Math.min(prefs.width, prefs.height) * this.diffuse.val * 0.005);
          if (dw) {
            ctxWork.save();
            ctxWork.clip();
            ctxWork.fill();
            var cold = -1;
            for (var i = dw; i > 0; --i) {
              var c = Math.floor(i * 255 / (dw + 1));
              if (c != cold) {
                col.b = c;
                ctxWork.strokeStyle = col.GetColStr();
                ctxWork.lineWidth = i;
                ctxWork.stroke();
                cold = c;
              }
            }
            ctxWork.restore();
          }
          else
            ctxWork.fill();
        } while(n);
        ctxWork.globalCompositeOperation="source-over";
      }
      else {
        shapeeditor.MakePath(ctxWork, this.shape.val, this.fill.val, 1,-1);
        ctxWork.lineWidth = this.width.val * prefs.width * 0.005;
        ctxWork.stroke();
      }
      this.imgdat = ctxWork.getImageData(0, 0, prefs.width, prefs.height);
      var rCX = prefs.width * 0.5;
      var rCY = prefs.height * 0.5;
      var p = 0;
      var txd=this.texturedepth.val*0.01;
      for (y = 0; y < prefs.height; ++y) {
        var rY = -(y + 0.5 - rCY);
        var rYN = rY / rCY;
        var rPY = y - rCY + 0.5;
        for (x = 0; x < prefs.width; ++x) {
          var rPX = x - rCX + 0.5;
          var rX = -(x + 0.5 - rCX);
          var rXN = rX / rCX;
          var pix=128;
          var alpha=255;
          if(this.tex) {
            pix=this.tex.Get(rPX,rPY,this.texturezoom.val);
            lumi=((pix&0xff)-128)*txd;
            alpha=255 - ((255-((pix>>24)&0xff))*txd);
          }
          else
            lumi=0;
          col.r = this.color.r;
          col.g = this.color.g;
          col.b = this.color.b;
          col.ChangeBrightness((rXN + rYN) * 128 * this.specular.val * 0.01 + lumi);
          this.imgdat.data[p + 3] = this.imgdat.data[p + 2] * this.imgdat.data[p + 3] * alpha / 65025;
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          p += 4;
        }
      }
    }
    this.RenderText = function(frame,total) {
      var sz = Math.min(prefs.height, prefs.width);
      ctxWork.clearRect(0, 0, prefs.width, prefs.height);
      let font = (this.italic.val ? "italic " : "") + (this.bold.val ? "bold " : "")
        + ((this.fontsize.val * sz * 0.01) | 0) + "px";
      if(this.fontname)
        font += ` '${this.fontname}'`;
      else
        font += " sans-serif";
      ctxWork.font = font;
      ctxWork.fillStyle = this.color.GetColStr();
      ctxWork.textBaseline = "middle";
      var dtx = new DynamicText(this.text.val);
      var tx = dtx.Get(frame,total);
      switch (this.textalign.val) {
        case 0:
          ctxWork.textAlign = "center";
          ctxWork.fillText(tx, prefs.width * 0.5, prefs.height * 0.5);
          break;
        case 1:
          ctxWork.textAlign = "left";
          ctxWork.fillText(tx, 0, prefs.height * 0.5);
          break;
        case 2:
          ctxWork.textAlign = "right";
          ctxWork.fillText(tx, prefs.width, prefs.height * 0.5);
          break;
      }
      this.imgdat = ctxWork.getImageData(0, 0, prefs.width, prefs.height);
    }
    this.RenderImage = function() {
      if (this.image != "AA") {
        ctxWork.clearRect(0, 0, prefs.width, prefs.height);
        ctxWork.drawImage(this.image, 0, 0, this.image.width, this.image.height, 0, 0, prefs.width, prefs.height);
      }
      this.imgdat = ctxWork.getImageData(0, 0, prefs.width, prefs.height);
    }
    this.RenderRect = function() {
      var rX, rY, rCX, rCY;
      var rXRO, rYRO;
      var rXRC, rYRC;
      var rXRI, rYRI;
      var rD;
      var rWidth, rWidth2;
      var rXCC, rYCC;
      var rRoundO, rRoundI;
      var r;
      var rYN, rXN, rYA, rXA;
      var x, y, iSpec;
      var pdw, dwCol;
      var rAlpha, rSpec;
      rCX = prefs.width / 2;
      rCY = prefs.height / 2;
      rXRO = rCX + 0.5;
      rYRO = rCY + 0.5;
      if (this.aspect.val > 0)
        rXRO = rXRO * (100 - Math.min(this.aspect.val, 99)) / 100;
      if (this.aspect.val < 0)
        rYRO = rYRO * (100 + Math.max(this.aspect.val, -99)) / 100;
      rWidth2 = (rWidth = Math.min(rCX, rCY) * this.width.val / 100 + 1) * 0.5;
      rD = rWidth2 * this.diffuse.val / 100;
      rXRC = rXRO - rWidth2;
      rYRC = rYRO - rWidth2;
      rXRI = rXRO - rWidth;
      rYRI = rYRO - rWidth;
      rRoundO = this.round.val * Math.min(rCX, rCY) / 100;
      rRoundI = rRoundO - rWidth;
      rXCC = rXRO - rRoundO;
      rYCC = rYRO - rRoundO;
      p = 0;
      for (y = 0; y < prefs.height; ++y) {
        rY = -(y + 0.5 - rCY);
        rYN = rY / rCY;
        rYA = Math.abs(rY);
        for (x = 0; x < prefs.width; ++x) {
          rX = -(x + 0.5 - rCX);
          rXN = rX / rCX;
          rXA = Math.abs(rX);
          rAlpha = 1.0;
          rSpec = rWidth;
          if (rXA > rXRO)
            rAlpha = 0;
          else if (rXA > rXRO - 1 - rD)
            rAlpha = (rXRO - rXA) / (1 + rD);
          if (rYA > rYRO)
            rAlpha = 0;
          else if (rYA > rYRO - 1 - rD)
            rAlpha = rAlpha * (rYRO - rYA) / (1 + rD);
          if (rXA >= rXCC && rYA >= rYCC) {
            var rdx, rdy;
            rdx = rXA - rXCC;
            rdy = rYA - rYCC;
            r = Math.sqrt(rdx * rdx + rdy * rdy);
            if (r > rRoundO)
              rAlpha = 0;
            if (r > rRoundO - 1 - rD)
              rAlpha = rAlpha * (rRoundO - r) / (1 + rD);
            if (r < rRoundI)
              rAlpha = 0;
            if (r < rRoundI + 1)
              rAlpha = rAlpha * (r - rRoundI);
          }
          else {
            if (rXA < rXRI && rYA < rYRI)
              rAlpha = 0;
            else {
              if (rXA < rXRI + 1 + rD && rYA < rYRI + 1 + rD) {
                rAlpha *= Math.max((rYA - rYRI), (rXA - rXRI)) / (1 + rD);
              }
            }
          }
          if (rYA < Math.min(rYRI, rYCC))
            rSpec = Math.max(0, Math.abs(rXA - rXRC));
          else if (rXA < Math.min(rXRI, rXCC))
            rSpec = Math.max(0, Math.abs(rYA - rYRC));
          else {
            if (rXA >= rXCC && rYA >= rYCC) {
              r = Math.sqrt((rXA - rXCC) * (rXA - rXCC) + (rYA - rYCC) * (rYA - rYCC));
              rSpec = r + (rWidth2 - rRoundO);
              rSpec = Math.abs(rSpec);
            }
            else {
              if (rYA - rYRI > rXA - rXRI) {
                rSpec = Math.abs(rYA - rYRC);
              }
              else {
                rSpec = Math.abs(rXA - rXRC);
              }
            }
          }
          iSpec = ((1.0 - rSpec / rWidth2) * 255 * this.specular.val / 100);
          var col = new Col(this.color.r, this.color.g, this.color.b);
          col.ChangeBrightness(iSpec);
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = rAlpha*255;
          p += 4;
        }
      }
    }
    this.RenderRectFill = function() {
      var x, y;
      var rX, rY, rXA, rYA, rXN, rYN, rCX, rCY, rPX, rPY, rXD, rYD;
      var rWidth, rHeight, rEmbossEdge;
      var rXE, rYE, rXEM, rYEM, rMin;
      var alpha, lumi, iA, iEm;
      var iTL, iRB;
      var rLX, rLY, rLZ;
      var rRound, rTZ;
      rLX = rLY = rLZ = Math.sqrt(1.0 / 3);
      ROOT2 = Math.sqrt(2);

      rMin = Math.min(prefs.width, prefs.height);
      rRound = this.round.val * rMin / 200;
      iEm = Math.abs(this.emboss.val);
      rEmbossEdge = (100 - this.embossdiffuse.val) / 100;
      rCX = prefs.width / 2;
      rCY = prefs.height / 2;
      rWidth = rCX;
      rHeight = rCY;
      if (this.aspect.val > 0)
        rWidth = rWidth * (100 - Math.min(this.aspect.val, 99)) / 100;
      if (this.aspect.val < 0)
        rHeight = rHeight * (100 + Math.max(this.aspect.val, -99)) / 100;
      rXD = rWidth * (100 - this.diffuse.val) / 100;
      rYD = rHeight * (100 - this.diffuse.val) / 100;
      rXE = rWidth + 1 - rMin * iEm / 200 * rEmbossEdge;
      rXEM = rWidth - rMin * iEm / 200;
      rYE = rHeight + 1 - rMin * iEm / 200 * rEmbossEdge;
      rYEM = rHeight - rMin * iEm / 200;
      if (this.emboss.val > 0)
        iTL = 100, iRB = -100;
      else
        iTL = -100, iRB = 100;
      p = 0;
      var txd=this.texturedepth.val*0.01;
      for (y = 0; y < prefs.height; ++y) {
        rY = -(y + 0.5 - rCY);
        rYN = rY / rCY;
        rYA = Math.abs(rY);
        rPY = y - rCY + 0.5;
        for (x = 0; x < prefs.width; ++x) {
          rPX = x - rCX + 0.5;
          var pix=128;
          alpha=255;
          if(this.tex) {
            pix=this.tex.Get(rPX,rPY,this.texturezoom.val);
            lumi=((pix&0xff)-128)*txd;
            alpha=255 - ((255-((pix>>24)&0xff))*txd);
          }
          else
            lumi=0;
          rX = -(x + 0.5 - rCX);
          rXN = rX / rCX;
          rXA = Math.abs(rX);
          if (rYA > rHeight || rXA > rWidth)
            alpha = 0;
          if (rXA > rXD) {
            alpha = Math.max(0, (alpha * (1.0 - (rXA - rXD) / (rWidth - rXD))));
          }
          if (rYA > rYD) {
            alpha = Math.max(0, (alpha * (1.0 - (rYA - rYD) / (rHeight - rYD))));
          }
          if (rXA > rWidth - rRound && rYA > rHeight - rRound) {
            var rR2, rXR, rYR, rXRM, rYRM;
            rXR = rXA - rWidth + rRound;
            rYR = rYA - rHeight + rRound;
            rR2 = rRound * rRound;
            rXRM = rXR + 1, rYRM = rYR + 1;
            if (rXRM * rXRM + rYRM * rYRM >= rR2) {
              if (rXR * rXR + rYR * rYR >= rR2)
                alpha = 0;
              else {
                // (x+v)*(y+v)+(y+v)*(y+v)=r2
                // 2v2 + 2(x+y)v + x2+y2-r2 =0
                var b = (rXR + rYR) * 2;
                var c = rXR * rXR + rYR * rYR - rR2;
                var v = ((Math.sqrt(b * b - 8 * c) - b) * 0.25);
                alpha = alpha * v;
              }
            }
          }
          var rRound2 = rRound * Math.min(rXE, rYE) / Math.min(rWidth, rHeight);
          iA = 0;
          var rXR = 0;
          var rYR = 0;
          var r2, rXYR;
          var iEmbossMode = 0;
          if (rXA >= rXEM) {
            rXR = rX / (rXA * ROOT2);
            rYR = 0;
            iEmbossMode = 1;
          }
          if (rYA >= rYEM) {
            rXR = 0;
            rYR = rY / (rYA * ROOT2);
            iEmbossMode = 2;
          }
          if (rXA >= rXEM - rRound2 && rYA >= rYEM - rRound2) {
            if (rX > 0)
              rXR = (rXA - rXEM + rRound2);
            else
              rXR = -(rXA - rXEM + rRound2);
            if (rY > 0)
              rYR = (rYA - rYEM + rRound2);
            else
              rYR = -(rYA - rYEM + rRound2);
            rXYR = rXR * rXR + rYR * rYR;
            if (rXYR >= (r2 = rRound2 * rRound2)) {
              var r;
              r = Math.sqrt(2 * rXYR);
              rXR /= r;
              rYR /= r;
              iEmbossMode = 3;
            }
          }
          var col = new Col(this.color.r, this.color.g, this.color.b);
          col.ChangeBrightness((rXN + rYN) * 128 * this.specular.val / 100 + lumi);
          if (iEmbossMode) {
            var a, r;
            rTZ = (1.0 / ROOT2);
            if (this.emboss.val > 0)
              r = rXR * rLX + rYR * rLY + rTZ * rLZ;
            else
              r = -rXR * rLX - rYR * rLY + rTZ * rLZ;
            if (r < 0)
              r = 0;
            var colE = new Col(this.color.r, this.color.g, this.color.b);
            colE.ChangeBrightness(r * 255 - 128);
            if (iEmbossMode == 1) {
              a = (255 * (rXA - rXEM) / (rXE - rXEM));
              a = Math.min(255, Math.max(0, Math.abs(a)));
              col.BlendTo(colE.r, colE.g, colE.b, a);
            }
            else if (iEmbossMode == 2) {
              a = (255 * (rYA - rYEM) / (rYE - rYEM));
              a = Math.min(255, Math.max(0, Math.abs(a)));
              col.BlendTo(colE.r, colE.g, colE.b, a);
            }
            else if (iEmbossMode == 3) {
              a = (255 * (Math.sqrt(rXYR) - rRound2) / (rXE - rXEM));
              a = Math.min(255, Math.max(0, Math.abs(a)));
              col.BlendTo(colE.r, colE.g, colE.b, a);
            }
          }
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderWaveCircle = function() {
      var x, y;
      var rCX, rCY, rPX, rPY, rX, rY, rAX, rAY, rD;
      var rTh, rR, rMax, rMax2, rMax2M;
      var alpha;
      var rCos;
      var lumi = 0;
      var rStep, rDepth;
      rStep = 180 / this.anglestep.val;
      rDepth = this.width.val*.01;
      rCX = prefs.width *0.5;
      rCY = prefs.height *0.5;
      rAX = rAY = 1.0;
      if (this.aspect.val > 0)
        rAX = (100 - Math.min(this.aspect.val, 99)) *0.01;
      if (this.aspect.val < 0)
        rAY = (100 + Math.max(this.aspect.val, -99)) *0.01;
      rMax = Math.sqrt(Math.min(rCX, rCY) * Math.min(rCX, rCY));
      rD = 1.0 - this.diffuse.val * 0.01;
      p = 0;
      var txd=this.texturedepth.val*0.01;
      for (y = 0; y < prefs.height; ++y) {
        rPY = y - rCY + 0.5;
        rY = rPY / rAY;
        for (x = 0; x < prefs.width; ++x) {
          rPX = x - rCX + 0.5;
          var pix=128;
          alpha=255;
          if(this.tex) {
            pix=this.tex.Get(rPX,rPY,this.texturezoom.val);
            lumi=((pix&0xff)-128)*txd;
            alpha=255 - ((255-((pix>>24)&0xff))*txd);
          }
          else
            lumi=0;

/*
          if (this.tex) {
            var txd = this.tex.Get(rPX, rPY, this.texturezoom.val);
            lumi = ((txd&0xff) - 128) * this.texturedepth.val *0.01;
          }
          else
            lumi = 0;
*/
          rX = rPX / rAX;
          rTh = Math.abs(Math.atan2(rX, rY));
          rCos = Math.abs(Math.sin(rTh * rStep));
          rR = Math.sqrt(rX * rX + rY * rY);
          rMax2 = rMax * (1.0 - rCos * rDepth);
          var col = new Col(this.color.r, this.color.g, this.color.b);
          col.ChangeBrightness((-rX / rCX - rY / rCY) * 128 * this.specular.val *0.01 + lumi);
          if (rR < rMax2) {
            rMax2M = (rMax2 - 1) * rD;
//                        alpha = 255;
            if (rR >= rMax2M)
              alpha -= (rR - rMax2M) * 255 / (rMax2 - rMax2M);
          }
          else
            alpha = 0;
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderCircle = function() {
      var x, y;
      var rCX, rCY;
      var dRW, dRW2, dRD1, dRD12, dRC, dRD2;
      var rAX, rAY;
      var rX, rY, rPX, rPY, rXM, rYM, rXC, rYC, rXE, rYE, rXEM, rYEM;
      var rXD1, rYD1, rXD2, rYD2;
      var r, rM, rC, rE, rEM, rD1, rD2, rY2, rYM2, rYC2, rYEM2, rYD12, rYD22, rYE2;
      var rMinSize;
      var alpha;
      var col = new Col(0, 0, 0);
      rCX = prefs.width * 0.5;
      rCY = prefs.height * 0.5;
      rMinSize = Math.min(rCX, rCY) * this.width.val * 0.01;
      dRW = 1.0 - this.width.val * 0.01;
      dRW2 = dRW * dRW;
      dRC = (dRW + 1.0) * 0.5;
      dRD1 = 1.0 - (1.0 - dRC) * this.diffuse.val * 0.01;
      dRD12 = dRD1 * dRD1;
      dRD2 = dRW + (dRC - dRW) * this.diffuse.val * 0.01;
      rAX = rAY = 1;
      if (this.aspect.val > 0)
        rAX = (100 / (100 - Math.min(this.aspect.val, 99)));
      if (this.aspect.val < 0)
        rAY = (100 / (100 + Math.max(this.aspect.val, -99)));
      p = 0;
      for (y = 0; y < prefs.height; ++y) {
        rPY = -(y + 0.5 - rCY) * rAY;
        rY = rPY / rCY; rY2 = rY * rY;
        rYM = rPY / (rCY - rAY); rYM2 = rYM * rYM;
        rYC = rPY / Math.max(0.1, rCY - rMinSize * 0.5 * rAY); rYC2 = rYC * rYC;
        rYEM = rPY / Math.max(0.1, rCY - rMinSize * rAY + rAY); rYEM2 = rYEM * rYEM;
        rYD1 = rPY / Math.max(0.1, rCY - rMinSize * 0.5 * this.diffuse.val / 100 * rAY); rYD12 = rYD1 * rYD1;
        rYD2 = rPY / Math.max(0.1, rCY - (rMinSize * rAY) + (rMinSize * 0.5) * this.diffuse.val / 100 * rAY); rYD22 = rYD2 * rYD2;
        rYE = rPY / Math.max(0.1, rCY - rMinSize * rAY);
        rYE2 = rYE * rYE;
        for (x = 0; x < prefs.width; ++x) {
          rPX = -(x + 0.5 - rCX) * rAX;
          rX = rPX / rCX;
          rXM = rPX / (rCX - rAX);
          rXC = rPX / Math.max(0.1, rCX - rMinSize * 0.5 * rAX);
          rXEM = rPX / Math.max(0.1, rCX - rMinSize * rAX + rAX);
          rXE = rPX / Math.max(0.1, rCX - rMinSize * rAX);
          rXD1 = rPX / Math.max(0.1, rCX - rMinSize * 0.5 * this.diffuse.val *0.01 * rAX);
          rXD2 = rPX / Math.max(0.1, rCX - (rMinSize * rAX) + (rMinSize * 0.5) * this.diffuse.val *0.01 * rAX);
          r = rX * rX + rY2;
          rM = rXM * rXM + rYM2;
          rC = rXC * rXC + rYC2;
          rEM = rXEM * rXEM + rYEM2;
          rE = rXE * rXE + rYE2;
          rD1 = rXD1 * rXD1 + rYD12;
          rD2 = rXD2 * rXD2 + rYD22;
          col.r = this.color.r;
          col.g = this.color.g;
          col.b = this.color.b;
          alpha = 255;
          if (rE < 1 || r > 1)
            alpha = 0;
          else {
            if (rE >= 1 && rEM <= 1)
              alpha *= (1 - rE) / (rEM - rE);
            if (r < 1 && rM >= 1)
              alpha *= (1 - r) / (rM - r);
            if (rD1 >= 1 && r < 1)
              alpha *= (1 - r) / (rD1 - r);
            else if (rE >= 1 && rD2 < 1)
              alpha *= (rE - 1) / (rE - rD2) * (rE - 1) / (rE - rD2);
            if (this.specular.val) {
              var v1 = 1 / Math.sqrt(r);
              var v2 = 1 / Math.sqrt(rE);
              v = 2 * (1 - v2) / (v1 - v2);
              if (v > 1)
                v = 2 - v;
              v *= this.specular.val * 2.55;
              col.ChangeBrightness(v);
            }
          }
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderCircleFill = function(spec) {
      ax = cx = prefs.width / 2;
      ay = cy = prefs.height / 2;
      if (this.aspect.val > 0)
        ax = (100 - Math.min(this.aspect.val, 99)) / 100 * cx;
      if (this.aspect.val < 0)
        ay = (100 + Math.max(this.aspect.val, -99)) / 100 * cy;
      p = 0;
      rthick = Math.abs(this.emboss.val) / 100;
      if (rthick == 1)
        rthick = 0.99;
      rEmbossEdge = (100 - this.embossdiffuse.val) / 100;
      rD = 1.0 - this.diffuse.val / 100;
      rD2 = rD * rD;
      rMin = Math.min(ax, ay);
      rLX = rLY = rLZ = Math.sqrt(1.0 / 3);
      rTZ = (1.0 / Math.sqrt(2));
      iMetalAmbient = this.ambient.val * 255 / 100;
      iMetalSpecular = this.specular.val * 255 / 100;
      if (this.specularwidth.val == 0)
        dMetalSpecularWidth = iMetalSpecular = 0;
      else
        dMetalSpecularWidth = Math.pow(1.0 / (this.specularwidth.val * .01), 3.0);
      rSX = rSY = -this.lightdir.val;
      rSZ = 50;
      a = Math.sqrt(rSX * rSX + rSY * rSY + rSZ * rSZ);
      rSX /= a;
      rSY /= a;
      rSZ /= a;
      for (var y = 0; y < prefs.height; ++y) {
        py = y - cy + 0.5;
        ry = py / (ay + 0.5);
        rym = py / (ay - 0.5);
        rye = py / (ay + 0.5 - (rMin * rthick) * rEmbossEdge);
        ryem = py / (ay - rMin * rthick);
        var txd=this.texturedepth.val*0.01;
        for (var x = 0; x < prefs.width; ++x) {
          px = x - cx + 0.5;
          rx = px / (ax + 0.5);
          rxy = rx * rx + ry * ry;
          rxm = px / (ax - 0.5);
          rxym = rxm * rxm + rym * rym;
          rxe = px / (ax + 0.5 - (rMin * rthick) * rEmbossEdge);
          rxem = px / (ax - rMin * rthick);
          rxye = rxe * rxe + rye * rye;
          rxyem = rxem * rxem + ryem * ryem;
          col = new Col(this.color.r, this.color.g, this.color.b);
          var pix=128;
          alpha=255;
          if(this.tex) {
            pix=this.tex.Get(px,py,this.texturezoom.val);
            lumi=((pix&0xff)-128)*txd;
            alpha=255 - ((255-((pix>>24)&0xff))*txd);
          }
          else
            lumi=0;
          var a, th, b, d, d2;
          if (rxye < 1.0) {
            switch (spec) {
              case 0:
                col.ChangeBrightness((-rx - ry) * 128 * this.specular.val / 100 + lumi);
                break;
              case 1:
                th = Math.atan2(ry, rx);
                d = Math.sin(th * 2);
                d2 = Math.pow((d + 1.0) * .5, dMetalSpecularWidth);
                a = (d + 1) * .5 * (255 - iMetalAmbient) + iMetalAmbient + d2 * iMetalSpecular + lumi;
                col.ChangeBrightness(a - 256);
                break;
              case 2:
                rZ = Math.sqrt(1.0 - rxy);
                d = -rx * rSX - ry * rSY + rZ * rSZ;
                a = iMetalAmbient + (255 - iMetalAmbient) * d;
                d = (2 * rZ * d - rSZ);
                if (d <= 0)
                  d = 0;
                else
                  d = Math.exp(Math.log(d) * (110 - this.specularwidth.val) / 10);
                a += lumi;
                b = iMetalSpecular * d;
                if (b < 0)
                  b = 0;
                col.Bright(a);
                col.ChangeBrightness(b);
                break;
            }
          }
          if (rxyem >= 1.0) {
            rR2 = Math.sqrt(2 * rxy);
            rTX = -rx / rR2;
            rTY = -ry / rR2;
            colE = new Col(this.color.r, this.color.g, this.color.b);
            if (this.emboss.val > 0) {
              r = (rTX * rLX + rTY * rLY + rTZ * rLZ);
              colE.ChangeBrightness(r * 255 - 128);
            }
            else if (this.emboss.val < 0) {
              r = (-rTX * rLX - rTY * rLY + rTZ * rLZ);
              colE.ChangeBrightness(r * 255 - 128);
            }
            a = Math.min(255, (Math.max(0, 255 * Math.abs((1.0 - rxyem) / (rxye - rxyem)))));
            if (rxye < 1.0)
              col.BlendTo(colE.r, colE.g, colE.b, a);
            else
              col.Copy(colE);
          }
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          if (rxy > 1)
            alpha = 0;
          if (rD2 < 1.0 && rxy > rD2)
            alpha = (alpha * (1.0 - (rxy - rD2) / (1.0 - rD2)));
          if (rxym >= 1.0) {
            alpha = (((1.0 - rxy) / (rxym - rxy)) * alpha);
          }
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderTriangle = function() {
      var x, y;
      var rYLen, rWidth, rX, rCX, rCY, rPX, rPY, rXLine, rXLine2, rD;
      var alpha, iA, lumi;
      rCX = prefs.width *0.5;
      rCY = prefs.height *0.5;
      rYLen = prefs.height * this.length.val *0.01;
      rWidth = prefs.width * this.width.val *0.005;
      rD = 1 - this.diffuse.val *0.01;
      p = 0;
      var txd=this.texturedepth.val*0.01;
      for (y = 0; y < prefs.height; ++y) {
        rPY = y - rCY + 0.5;
        for (x = 0; x < prefs.width; ++x) {
          rPX = x - rCX + 0.5;
          var pix=128;
          alpha=255;
          if(this.tex) {
            pix=this.tex.Get(rPX,rPY,this.texturezoom.val);
            lumi=((pix&0xff)-128)*txd;
            alpha=255 - ((255-((pix>>24)&0xff))*txd);
          }
          else
            lumi=0;

/*
          if (this.tex) {
            var txd=this.tex.Get(rPX, rPY, this.texturezoom.val);
            lumi = ((txd&0xff) - 128) * this.texturedepth.val *0.01;
          }
          else
            lumi = 0;
*/
          var col = new Col(this.color.r, this.color.g, this.color.b);
          if (y > rYLen) {
            alpha = 0;
          }
          else {
            rX = Math.abs(x + 0.5 - rCX);
            rXLine = rWidth * y / rYLen + 1;
            rXLine2 = (rXLine - 1) * rD;
            if (rX < rXLine2)
              ;
            else if (rX < rXLine)
              alpha = ((1.0 - (rX - rXLine2) / (rXLine - rXLine2)) * alpha);
            else
              alpha = 0;
            if (rXLine == 0)
              iA = 255;
            else
              iA = ((255 - rX / rXLine * 255) * this.specular.val *0.01);
            iA += lumi;
            iA = Math.min(254, Math.max(0, iA));
            col.ChangeBrightness(iA);
          }
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderLine = function() {
      var x, y;
      var rX, rY, rXC, rDX, rDY, rD;
      var rXP, rYP;
      var rDistance, rWidth, rWidth2;
      var alpha;
      var colBase = new Col(this.color.r, this.color.g, this.color.b);
      var col = new Col(0, 0, 0);
      rWidth = prefs.width * this.width.val / 400;
      var rLenY = prefs.height * this.length.val / 100 - rWidth;
      if (rLenY < rWidth)
        rLenY = rWidth;
      rXC = prefs.width / 2;
      rD = 1.0 - this.diffuse.val / 100;
      rWidth2 = (rWidth - 1) * rD;
      p = 0;
      for (y = 0; y < prefs.height; ++y) {
        rY = y + 0.5;
        if (rY < rWidth)
          rYP = rWidth;
        else if (rY < rLenY)
          rYP = rY;
        else
          rYP = rLenY;
        rDY = rY - rYP;
        for (x = 0; x < prefs.width; ++x) {
          rX = x + 0.5;
          rXP = rXC;
          rDX = rX - rXP;
          rDistance = Math.sqrt(rDX * rDX + rDY * rDY);
          if (rDistance >= rWidth) {
            col.Copy(colBase);
            alpha = 0;
          }
          else {
            var iA;
            alpha = 255;
            iA = (255 - rDistance / rWidth * 255) * this.specular.val / 100;
            iA = Math.max(0, Math.min(255, iA));
            col.Copy(colBase);
            col.ChangeBrightness(iA);
            if (rDistance >= rWidth2) {
              alpha = 255 - (255 * (rDistance - rWidth2) / (rWidth - rWidth2));
            }
          }
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderRadiateLine = function() {
      var iTh;
      var x, y;
      var alpha;
      var rD, rWidth, rWidth2, rLenY;
      if (prefs.width == 0 || prefs.height == 0 || this.anglestep.val == 0)
        return;
      vC = new Vector(prefs.width / 2, prefs.height / 2);
      vP = new Vector(0, 0);
      rWidth = vC.x * this.width.val / 200 + 1;
      rD = 1.0 - this.diffuse.val / 100;
      rWidth2 = (rWidth - 1) * rD;
      rLenY = prefs.height * this.length.val / 200;
      if (rLenY < rWidth)
        rLenY = rWidth;
      vAspect = new Vector(1.0, 1.0);
      vSize = new Vector(prefs.width, prefs.height);
      vP1 = new Vector(0.0, -vC.y + rWidth);
      vP2 = new Vector(0.0, -vC.y + rLenY);
      vTC1 = new Vector(0, 0);
      vTC2 = new Vector(0, 0);
      vT1 = new Vector(0, 0);
      vT2 = new Vector(0, 0);

      if (this.aspect.val > 0)
        vAspect.x = ((100.0 - Math.min(this.aspect.val, 99)) / 100.0);
      if (this.aspect.val < 0)
        vAspect.y = ((100.0 + Math.max(this.aspect.val, -99)) / 100.0);
      vAspect.x *= prefs.width / prefs.height;

      vTC1.Set(vP1), vTC2.Set(vP2);
      vTC1.Mul(vAspect);
      vTC2.Mul(vAspect);
      vTC1.Add(vC);
      vTC2.Add(vC);
      p = 0;
      for (y = 0; y < prefs.height; ++y) {
        for (x = 0; x < prefs.width; ++x) {
          var d, d2;
          vv = new Vector(0, 0);
          vP.x = x + 0.5; vP.y = y + 0.5;
          d = this.LinePoint(vTC1.x, vTC1.y, vTC2.x, vTC2.y, vP.x, vP.y);
          for (iTh = this.anglestep.val; iTh <= 180; iTh += this.anglestep.val) {
            vT1.Set(vP1); vT2.Set(vP2);
            vT1.Rotate(iTh);
            vT2.Rotate(iTh);
            vT1.Mul(vAspect);
            vT2.Mul(vAspect);
            vT1.Add(vC);
            vT2.Add(vC);
            d2 = this.LinePoint(vT1.x, vT1.y, vT2.x, vT2.y, vP.x, vP.y);
            d = Math.min(d, d2);
            vT1.Set(vP1); vT2.Set(vP2);
            vT1.Rotate(-iTh);
            vT2.Rotate(-iTh);
            vT1.Mul(vAspect);
            vT2.Mul(vAspect);
            vT1.Add(vC);
            vT2.Add(vC);
            d2 = this.LinePoint(vT1.x, vT1.y, vT2.x, vT2.y, vP.x, vP.y);
            d = Math.min(d, d2);
          }
          var col = new Col(this.color.r, this.color.g, this.color.b);
          if (d < rWidth) {
            col.ChangeBrightness(((rWidth - d) / rWidth * 255) * this.specular.val / 100);
            if (d < rWidth2)
              alpha = 255;
            else
              alpha = 255 - ((d - rWidth2) / (rWidth - rWidth2) * 255);
          }
          else
            alpha = 0;
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.LinePoint = function(x0, y0, x1, y1, px, py) {
      var x, y, dx, dy, a, b, t;
      dx = x1 - x0;
      dy = y1 - y0;
      a = dx * dx + dy * dy;
      if (a == 0)
        return Math.sqrt((x0 - px) * (x0 - px) + (y0 - py) * (y0 - py));
      b = dx * (x0 - px) + dy * (y0 - py);
      t = -(b / a);
      if (t < 0.0)
        t = 0.0;
      if (t >= 1.0)
        t = 1.0;
      x = t * dx + x0;
      y = t * dy + y0;
      return Math.sqrt((x - px) * (x - px) + (y - py) * (y - py));
    }
    this.RenderHLines = function() {
      var x, y;
      var rX, rY, rXA, rYA, rCX, rCY, rAX, rAY;
      var rWidth, rWidth2, rMin;
      var rLen, rYArea;
      var alpha;
      rCX = prefs.width / 2;
      rCY = prefs.height / 2;
      rAX = rAY = 1.0;
      if (this.aspect.val > 0)
        rAX = (100.0 / (100 - Math.min(this.aspect.val, 99)));
      if (this.aspect.val < 0)
        rAY = (100.0 / (100 + Math.max(this.aspect.val, -99)));
      rLen = rCX / rAX * this.length.val / 100;
      rYArea = rCY / rAY;
      rWidth = rYArea * this.width.val / 200 + 1;
      rWidth2 = (rWidth - 1) * (1.0 - this.diffuse.val / 100);
      if (prefs.width == 0 || prefs.height == 0)
        return;
      p = 0;
      for (y = 0; y < prefs.height; ++y) {
        rY = -(y + 0.5 - rCY);
        rYA = Math.abs(rY);
        for (x = 0; x < prefs.width; ++x) {
          rX = x + 0.5 - rCX;
          rXA = Math.abs(rX);
          rMin = 1.0;
          if (rYA < rYArea) {
            var yy;
            rMin = 100000;
            for (yy = 0; yy <= 100; yy += this.step.val) {
              var r;
              if (rXA < rLen) {
                r = yy * (rYArea - rWidth) / 100;
                r = Math.abs(r - rYA);
              }
              else {
                var yyy;
                yyy = yy * (rYArea - rWidth) / 100;
                r = Math.sqrt((rXA - rLen) * (rXA - rLen) + (rYA - yyy) * (rYA - yyy));
              }
              if (r < rMin)
                rMin = r;
              if (this.step.val == 0)
                break;
            }
            if (rMin < rWidth) {
              if (rMin < rWidth2)
                alpha = 255;
              else
                alpha = 255 - ((rMin - rWidth2) / (rWidth - rWidth2) * 255);
            }
            else
              alpha = 0;
          }
          else
            alpha = 0;
          var col = new Col(this.color.r, this.color.g, this.color.b);
          col.ChangeBrightness(((1.0 - (rMin / rWidth)) * 255 * this.specular.val / 100));
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.RenderVLines = function() {
      var x, y;
      var rX, rY, rXA, rYA, rCX, rCY, rAX, rAY;
      var rWidth, rWidth2, rMin;
      var rLen, rXArea;
      var alpha;
      rCX = prefs.width / 2;
      rCY = prefs.height / 2;
      rAX = rAY = 1.0;
      if (this.aspect.val > 0)
        rAX = (100.0 / (100 - Math.min(this.aspect.val, 99)));
      if (this.aspect.val < 0)
        rAY = (100.0 / (100 + Math.max(this.aspect.val, -99)));
      rLen = rCY / rAY * this.length.val / 100;
      rXArea = rCX / rAX;
      rWidth = rXArea * this.width.val / 200 + 1;
      rWidth2 = (rWidth - 1) * (1.0 - this.diffuse.val / 100);
      if (prefs.width == 0 || prefs.height == 0)
        return;
      p = 0;
      for (y = 0; y < prefs.height; ++y) {
        rY = -(y + 0.5 - rCY);
        rYA = Math.abs(rY);
        for (x = 0; x < prefs.width; ++x) {
          rX = x + 0.5 - rCX;
          rXA = Math.abs(rX);
          rMin = 1.0;
          if (rXA < rXArea) {
            var xx;
            rMin = 100000;
            for (xx = 0; xx <= 100; xx += this.step.val) {
              var r;
              if (rYA < rLen) {
                r = xx * (rXArea - rWidth) / 100;
                r = Math.abs(r - rXA);
              }
              else {
                var xxx;
                xxx = xx * (rXArea - rWidth) / 100;
                r = Math.sqrt((rYA - rLen) * (rYA - rLen) + (rXA - xxx) * (rXA - xxx));
              }
              if (r < rMin)
                rMin = r;
              if (this.step.val == 0)
                break;
            }
            if (rMin < rWidth) {
              if (rMin < rWidth2)
                alpha = 255;
              else
                alpha = 255 - ((rMin - rWidth2) / (rWidth - rWidth2) * 255);
            }
            else
              alpha = 0;
          }
          else
            alpha = 0;
          var col = new Col(this.color.r, this.color.g, this.color.b);
          col.ChangeBrightness(((1.0 - (rMin / rWidth)) * 255 * this.specular.val / 100));
          this.imgdat.data[p] = col.r;
          this.imgdat.data[p + 1] = col.g;
          this.imgdat.data[p + 2] = col.b;
          this.imgdat.data[p + 3] = alpha;
          p += 4;
        }
      }
    }
    this.Render = function(frame,total) {
      switch (this.type.val) {
        case 0:
          for (var p = 0; p < 64 * 64 * 4; ++p) {
            this.imgdat.data[p] = 0;
          }
          break;
        case 1:
          this.RenderImage();
          break;
        case 2:
          this.RenderCircle();
          break;
        case 3:
          this.RenderCircleFill(0);
          break;
        case 4:
          this.RenderCircleFill(1);
          break;
        case 5:
          this.RenderWaveCircle();
          break;
        case 6:
          this.RenderCircleFill(2);
          break;
        case 7:
          this.RenderRect();
          break;
        case 8:
          this.RenderRectFill();
          break;
        case 9:
          this.RenderTriangle();
          break;
        case 10:
          this.RenderLine();
          break;
        case 11:
          this.RenderRadiateLine();
          break;
        case 12:
          this.RenderHLines();
          break;
        case 13:
          this.RenderVLines();
          break;
        case 14:
          this.RenderText(frame,total);
          break;
        case 15:
          this.RenderShape();
          break;
      }
    }
  }
  function Thumbnail() {
//        var cvWork3 = document.getElementById("canvaswork3");
    cvWork3.width = prefs.width;
    cvWork3.height = prefs.height;
    var ctxWork3 = cvWork3.getContext("2d");
    var img = ctxWork3.createImageData(prefs.width, prefs.height);
    for (var i = 0; i < layers.length; ++i) {
      if (layers[i].visible) {
        layers[i].RenderFrame(img, 0, 0, i, 0, prefs.framesrender.val - 1);
      }
    }
    ctxWork3.putImageData(img, 0, 0);
    var daturl = cvWork3.toDataURL();
    return B64Dec(daturl.substr(daturl.indexOf(",") + 1));
  }
  async function Render() {
    if(renderframe == -3){
      if(curLayer >= 0)
        layers[curLayer].prim.Render();
      ++renderframe;
    }
    else if(renderframe == -2){
      ctxPrevFrom.fillStyle = "#808080";
      ctxPrevFrom.fillRect(0, 0, 128, 128);
      if(curLayer >= 0){
        layers[curLayer].RenderFrame(layers[curLayer].imgprevf, 0, 0, 0, 0, 1);
        ctxWork.putImageData(layers[curLayer].imgprevf, 0, 0);
        ctxPrevFrom.imageSmoothingEnabled = false;
        ctxPrevFrom.drawImage(cvWork, 0, 0, prefs.width, prefs.height, 0, 0, cvPrevFrom.width, cvPrevFrom.height);
      }
      ++renderframe;
    }
    else if(renderframe == -1){
      ctxPrevTo.fillStyle = "#808080";
      ctxPrevTo.fillRect(0, 0, 128, 128);
      if(curLayer >= 0){
        layers[curLayer].RenderFrame(layers[curLayer].imgprevt, 0, 0, 0, 1, 1);
        ctxWork2.putImageData(layers[curLayer].imgprevt, 0, 0);
        ctxPrevTo.imageSmoothingEnabled = false;
        ctxPrevTo.drawImage(cvWork2, 0, 0, prefs.width, prefs.height, 0, 0, cvPrevTo.width, cvPrevTo.height);
      }
      ++renderframe;
    }
    else if(renderframe>=0){
      if(renderlayer < layers.length) {
        if (layers[renderlayer].visible) {
          if(exporting && document.getElementById("exportas").selectedIndex == 0 && document.getElementById("orientation").selectedIndex==1)
            layers[renderlayer].RenderFrame(imgRender, prefs.width * renderframe,0, renderinit, renderframe, prefs.frames -1);
          else
            layers[renderlayer].RenderFrame(imgRender, 0, prefs.height * renderframe, renderinit, renderframe, prefs.frames - 1);
          renderinit = 1;
        }
        ++renderlayer;
      }
      else{
        renderinit = 0;
        renderlayer = 0;
        if(exporting) {
          document.getElementById("rendermsg").innerHTML = "Now Rendering...("+renderframe+"/"+prefs.frames+")";
          if((renderframe&0x7)==0)
            document.getElementById("renderimage").src = cvRender.toDataURL();
        }
        if (++renderframe >= prefs.frames) {
          ctxRender.putImageData(imgRender, 0, 0);
          if (exporting) {
            let fname=document.menu.filename.value;
            if(fname=="")
              fname="temp.png";
            if(fname.toLowerCase().substring(fname.length-5)==".knob")
              fname=fname.substring(0,fname.length-5);
            fname +=".png";

            if(document.getElementById("exportas").selectedIndex == 1){
              console.log(prefs.width, prefs.height, prefs.frames)
              cvWork3.width = prefs.width;
              cvWork3.height = prefs.height;
              const ctx = cvWork3.getContext("2d");
              apb = new APNGBuilder();
              for(let f=0;f<prefs.frames;++f){
                ctx.putImageData(imgRender, 0, -prefs.height * f);
                await apb.addFrame(cvWork3);
              }
              if(document.getElementById("shuttle").checked){
                for(let f=prefs.frames - 2; f > 0; --f){
                  ctx.putImageData(imgRender, 0, -prefs.height * f);
                  await apb.addFrame(cvWork3);
                }
              }
              apb.setDelay(document.getElementById("duration").value/1000);
              const blob = await apb.getAPng();
              console.log(blob)
              document.getElementById("renderimage").src=URL.createObjectURL(blob);
              document.getElementById("renderpaneframe").style.display = "block";
              document.getElementById("rendermsg").innerHTML = "Save the image below as a PNG file";
              const alink = document.createElement("a");
              alink.download = fname;
              alink.href= document.getElementById("renderimage").src;
              alink.dataset.downloadurl = ["text/plain", alink.download, alink.href].join(":");
              alink.click();
              exporting = 0;
              prefs.frames = prefs.framesprev.val;
              RedrawRender();
            }
            else {
              cvRender.toBlob((png)=>{
                document.getElementById("renderimage").src=URL.createObjectURL(png);
                document.getElementById("renderpaneframe").style.display = "block";
                document.getElementById("rendermsg").innerHTML = "Save the image below as a PNG file";
                const alink = document.createElement("a");
                alink.download = fname;
                alink.href= document.getElementById("renderimage").src;
                alink.dataset.downloadurl = ["text/plain", alink.download, alink.href].join(":");
                alink.click();
                exporting = 0;
                prefs.frames = prefs.framesprev.val;
                RedrawRender();
              }, "image/png");
            }
          }
          renderframe = -4;
          timeoutId=setTimeout(Render,1000);
          return;
        }
        ctxRender.putImageData(imgRender, 0, 0);
      }
    }
    if(dragType=="")
      timeoutId=setTimeout(Render,20);
    else
      timeoutId=setTimeout(Render,100);
  }
  function Layer() {
    this.visible = 1;
    this.prim = new Primitive();
    this.eff = new Eff();
    this.imgprevf = ctxWork.createImageData(prefs.width, prefs.height);
    this.imgprevt = ctxWork2.createImageData(prefs.width, prefs.height);
    this.SetSize = function(m) {
      this.imgprevf = ctxWork.createImageData(prefs.width, prefs.height);
      this.imgprevt = ctxWork2.createImageData(prefs.width, prefs.height);
      this.prim.SetSize();
      this.prim.Render();
      if(m)
        this.Draw();
    }
    this.Diffuse = function(imgDest, diff) {
      var wx, wy, x, y, xx, yy, xxx, yyy, yyy2, r2;
      var a, a1, a2;
      var imgTemp = ctxRender.createImageData(prefs.width, prefs.height);
      c = new Col(0, 0, 0);
      wx = Math.floor((prefs.width / 8) * diff / 100);
      for (y = 0; y < prefs.height; ++y) {
        for (x = 0; x < prefs.width; ++x) {
          c.Reset();
          for (xx = x - wx; xx <= x + wx; ++xx) {
            if (xx >= 0 && xx < prefs.width)
              c.AddVal(imgDest, xx, y);
          }
          c.SetAve(imgTemp, x, y);
        }
      }
      for (x = 0; x < prefs.width; ++x) {
        for (y = 0; y < prefs.height; ++y) {
          c.Reset();
          for (yy = y - wx; yy <= y + wx; ++yy) {
            if (yy >= 0 && yy < prefs.height)
              c.AddVal(imgTemp, x, yy);
          }
          c.SetAve(imgDest, x, y);
        }
      }
    }
    this.MakeShadow = function(imgDst, imgSrc, inside, type, fShadowGradate, fOffset, fOffX, fOffY, iSD, colDef) {
      var x, y, xx, yy, i;
      var fYY, fXX, fV0, fV1, fVal, fValMax;
      var iV00, iV01, iV10, iV11, iLoop;
      fOffX *= fOffset;
      fOffY *= fOffset;
      if (type == 0)
        iLoop = 1;
      else
        iLoop = fOffset;
      if (iLoop == 0)
        iLoop = 1;
      iSizeX = imgSrc.width;
      iSizeY = prefs.height;
      for (y = 0; y < iSizeY; ++y) {
        for (x = 0; x < iSizeX; ++x) {
          fValMax = 0;
          for (i = 1; i <= iLoop; ++i) {
            fYY = y - fOffY * i / iLoop;
            yy = Math.floor(fYY);
            fYY -= yy;
            fXX = x - fOffX * i / iLoop;
            xx = Math.floor(fXX);
            fXX -= xx;
            iV00 = iV01 = iV10 = iV11 = 0;
            if (xx >= 0 && xx < iSizeX && yy >= 0 && yy < iSizeY)
              iV00 = imgSrc.data[(yy * iSizeX + xx) * 4 + 3];
            ++xx;
            if (xx >= 0 && xx < iSizeX && yy >= 0 && yy < iSizeY)
              iV01 = imgSrc.data[(yy * iSizeX + xx) * 4 + 3];
            --xx; ++yy;
            if (xx >= 0 && xx < iSizeX && yy >= 0 && yy < iSizeY)
              iV10 = imgSrc.data[(yy * iSizeX + xx) * 4 + 3];
            ++xx;
            if (xx >= 0 && xx < iSizeX && yy >= 0 && yy < iSizeY)
              iV11 = imgSrc.data[(yy * iSizeX + xx) * 4 + 3];
            fV0 = iV00 + (iV01 - iV00) * fXX;
            fV1 = iV10 + (iV11 - iV10) * fXX;
            fVal = fV0 + (fV1 - fV0) * fYY;
            fVal = fVal * (fShadowGradate * (iLoop - i + 1) / iLoop + (100 - fShadowGradate)) * .01;
            if (fVal > fValMax)
              fValMax = fVal;

          }
          p = (y * iSizeX + x) * 4;
          if (inside) {
            fValMax = 255 - fValMax;
          }
          colDef.a = fValMax * iSD / 100;
          colDef.SetPix(imgDst, p);
        }
      }
    }
    this.MaskWipe = function(iType, x, y, xDest, yDest, fStart, fStop, iGradation, iGradDir) {
      var fTemp;
      var xx, yy, c, rc;
      var rGrad, rGrad2;
      var rStart, rStop;
      var a, aStart, aStop, aMin, aMax;
      var iDir, alpha;
      if (fStart == fStop)
        return 0;
      iDir = 0;
      if (fStart > fStop)
        fTemp = fStart, fStart = fStop, fStop = fTemp, iDir = 1;
      switch (iType) {
        case 0:
          if (fStop - fStart >= 360)
            return 255;
          xx = x - (xDest * 0.5);
          yy = y - (yDest * 0.5);
          c = Math.sqrt(xx * xx + yy * yy);
          if (c == 0)
            return 255;
          rc = 1.0 / c;
          a = Math.atan2(xx, -yy) - (2 * Math.PI);
          aStart = fStart * Math.PI / 180;
          aStop = fStop * Math.PI / 180;
          aMin = Math.min(aStart, aStop);
          aMax = Math.max(aStart, aStop);
          while (a < aMin - rc)
            a += 2 * Math.PI;
          while (a > aMax + rc)
            a -= 2 * Math.PI;
          alpha = 255;
          if (a >= aMin - rc && a <= aMax + rc) {
            if (a < aMin)
              alpha = alpha * (a - (aMin - rc)) / rc;
            if (a > aMax)
              alpha = alpha * (aMax + rc - a) / rc;
          }
          else
            return 0;
          if (iGradDir) {
            rGrad = (a - aMin + rc) / ((aMax - aMin + 2 * rc) * iGradation / 100);
            rGrad2 = (a - aMax - rc) / ((aMin - aMax) * iGradation / 100);
            rGrad = Math.min(rGrad, rGrad2);
          }
          else if (iDir == 0)
            rGrad = (a - aMin + rc) / ((aMax - aMin + 2 * rc) * iGradation / 100);
          else
            rGrad = (a - aMax - rc) / ((aMin - aMax) * iGradation / 100);
          if (rGrad < 0)
            rGrad = 0;
          if (rGrad > 1.0)
            rGrad = 1.0;
          return alpha * rGrad;
        case 1:
          rStart = fStart * (Math.min(yDest, xDest)) / 200;
          rStop = fStop * (Math.min(yDest, xDest)) / 200;
          xx = x - (xDest / 2);
          yy = y - (yDest / 2);
          c = Math.sqrt(xx * xx + yy * yy);
          alpha = 255;
          if (c < rStart)
            alpha = 0;
          if (c < rStart + 1)
            alpha = ((c - rStart) * alpha);
          if (c > rStop)
            alpha = 0;
          if (c > rStop - 1)
            alpha = ((rStop - c) * alpha);
          if (iGradation == 0)
            return alpha;
          if (iGradDir) {
            rGrad = ((c - rStart) / ((rStop - rStart) * iGradation / 100));
            rGrad2 = ((c - rStop) / ((rStart - rStop) * iGradation / 100));
            rGrad = Math.min(rGrad, rGrad2);
          }
          else if (iDir == 0)
            rGrad = ((c - rStart) / ((rStop - rStart) * iGradation / 100));
          else
            rGrad = ((c - rStop) / ((rStart - rStop) * iGradation / 100));
          if (rGrad < 0)
            rGrad = 0;
          if (rGrad > 1.0)
            rGrad = 1.0;
          return (alpha * rGrad);
        case 2:
          rStart = (fStart + 100) * xDest / 200;
          rStop = (fStop + 100) * xDest / 200;
          alpha = 255;
          if (x < rStart - 1)
            return 0;
          if (x < rStart)
            alpha = (alpha * (x - (rStart - 1)));
          if (x > rStop + 1)
            return 0;
          if (x > rStop)
            alpha = (alpha * (rStop + 1 - x));
          if (iGradation == 0)
            return alpha;
          if (iGradDir) {
            rGrad = (x - rStart) / ((rStop - rStart) * iGradation / 100);
            rGrad2 = (x - rStop) / ((rStart - rStop) * iGradation / 100);
            rGrad = Math.min(rGrad, rGrad2);
          }
          else if (iDir == 0)
            rGrad = (x - rStart) / ((rStop - rStart) * iGradation / 100);
          else
            rGrad = (x - rStop) / ((rStart - rStop) * iGradation / 100);
          if (rGrad < 0)
            rGrad = 0;
          if (rGrad > 1.0)
            rGrad = 1.0;
          return (alpha * rGrad);
        case 3:
          rStop = (-fStart + 100) * yDest / 200;
          rStart = (-fStop + 100) * yDest / 200;
          alpha = 255;
          if (y < rStart - 1)
            return 0;
          if (y < rStart)
            alpha = (alpha * (y - (rStart - 1)));
          if (y > rStop + 1)
            return 0;
          if (y > rStop)
            alpha = (alpha * (rStop + 1 - y));
          if (iGradation == 0)
            return alpha;
          if (iGradDir) {
            rGrad = (y - rStart) / ((rStop - rStart) * iGradation / 100);
            rGrad2 = (y - rStop) / ((rStart - rStop) * iGradation / 100);
            rGrad = Math.min(rGrad, rGrad2);
          }
          else if (iDir == 1)
            rGrad = (y - rStart) / ((rStop - rStart) * iGradation / 100);
          else
            rGrad = (y - rStop) / ((rStart - rStop) * iGradation / 100);
          if (rGrad < 0)
            rGrad = 0;
          if (rGrad > 1.0)
            rGrad = 1.0;
          return alpha * rGrad;
      }
      return 255;
    }
    this.Rot = function(imgSrc, imgDest, dx, dy, mode, zoomx, zoomy, offx, offy, angle,
       alpha, bright, cont, sat, hue, mask1start, mask1stop, mask2start, mask2stop,
       slightdir, sden, dlightdir, doff, dden, ddiff, ilightdir, ioff, iden, idiff, elightdir, eoff, eden) {
      var rX, rY, rLX, rLY;
      if (zoomx != 0 && zoomy != 0) {
        dZoomX = 1.0 / zoomx;
        dZoomY = 1.0 / zoomy;
      }
      else
        return;
      imgTemp = ctxRender.createImageData(prefs.width, prefs.height);
      imgShadow = ctxRender.createImageData(prefs.width, prefs.height);
      imgShadow2 = ctxRender.createImageData(prefs.width, prefs.height);
      var mx = new XYMatrix();
      mx.RotateAt(angle, (this.eff.centerx.val + 50) * .01 * prefs.width, (50 - this.eff.centery.val) * .01 * prefs.height);
      mx.Translate(-offx * .01 * prefs.width, offy * .01 * prefs.height);
      if (this.eff.keepdir.val)
        mx.RotateAt(-angle, prefs.width * 0.5, prefs.height * 0.5);
      mx.ScaleAt(dZoomX * 100.0, dZoomY * 100.0, imgSrc.width * 0.5, imgSrc.height * 0.5);
      var pos = new Array(2);
      var coldef = new Col(this.prim.color.r, this.prim.color.g, this.prim.color.b);
      coldef.a = 0;
      var col00 = new Col(0, 0, 0);
      var col01 = new Col(0, 0, 0);
      var col10 = new Col(0, 0, 0);
      var col11 = new Col(0, 0, 0);
      function GetCol(c, img, x, y) {
        var p = (y * img.width + x) * 4;
        c.r = img.data[p];
        c.g = img.data[p + 1];
        c.b = img.data[p + 2];
        c.a = img.data[p + 3];
      }
      p = 0;
      for (var y = 0; y < prefs.height; ++y) {
        pD = ((dy + y) * imgDest.width + dx) * 4;
        for (var x = 0; x < prefs.width; ++x) {
          pos[0] = x + 0.5;
          pos[1] = y + 0.5;
          mx.Transform(pos);
          pos[0] -= 0.5;
          pos[1] -= 0.5;
          px = Math.floor(pos[0]), py = Math.floor(pos[1]);
          if (px < 0 || py < 0 || px >= imgSrc.width || py >= imgSrc.height)
            col00.Copy(coldef);
          else
            GetCol(col00, imgSrc, px, py);
          ++px;
          if (px < 0 || py < 0 || px >= imgSrc.width || py >= imgSrc.height)
            col01.Copy(coldef);
          else
            GetCol(col01, imgSrc, px, py);
          --px; ++py;
          if (px < 0 || py < 0 || px >= imgSrc.width || py >= imgSrc.height)
            col10.Copy(coldef);
          else
            GetCol(col10, imgSrc, px, py);
          ++px;
          if (px < 0 || py < 0 || px >= imgSrc.width || py >= imgSrc.height)
            col11.Copy(coldef);
          else
            GetCol(col11, imgSrc, px, py);
          --px; --py;
          col00.Blend4(col01, col10, col11, pos[0] - px, pos[1] - py);
          col00.Conv(bright, cont, sat, hue);
          col00.a *= alpha * 0.01;

          dX = x + 0.5 - this.eff.centerx.val * prefs.width / 100;
          dY = y + 0.5 + this.eff.centery.val * prefs.height / 100;
          if (this.eff.antialias.val == 0)
            col00.a = (col00.a >= 128) ? 255 : 0;

          iMask1 = 255;
          if (this.eff.mask1ena.val)
            iMask1 = this.MaskWipe(this.eff.mask1type.val, dX, dY, prefs.width, prefs.height, mask1start, mask1stop, this.eff.mask1grad.val, this.eff.mask1graddir.val);
          if (this.eff.mask2ena.val) {
            iMask2 = this.MaskWipe(this.eff.mask2type.val, dX, dY, prefs.width, prefs.height, mask2start, mask2stop, this.eff.mask2grad.val, this.eff.mask2graddir.val);
            if(this.eff.mask2op.val==0)
              iMask1=iMask1*iMask2/255;
            else
              iMask1=Math.max(iMask1,iMask2);
          }
          col00.a = col00.a * iMask1 / 255;
          col00.SetPix(imgTemp, p);
          if (mode == 0)
            imgDest.data[pD + 3] = 0;
          p += 4;
          pD += 4;
        }
      }

      LightFilter(prefs.width, prefs.height, slightdir, sden, elightdir, eoff, eden, imgTemp);
      rLX = -Math.sin(slightdir * Math.PI / 180);
      rLY = Math.cos(slightdir * Math.PI / 180);
      if (dden != 0) {
        var colDef = new Col(0, 0, 0);
        if (dden < 0)
          colDef.r = colDef.g = colDef.b = 255;
        rLXD = rLX, rLYD = rLY;
        if (this.eff.dlightdirena.val) {
          rLXD = -Math.sin(dlightdir * Math.PI / 180);
          rLYD = Math.cos(dlightdir * Math.PI / 180);
        }
        iSD = Math.abs(dden);
        doff *= Math.min(prefs.width, prefs.height) / 100;
        this.MakeShadow(imgShadow, imgTemp, 0, this.eff.dstype.val, this.eff.dsgrad.val, doff, rLXD, rLYD, iSD, colDef);
        this.Diffuse(imgShadow, ddiff);
      }
//            console.log("Rot.iden != 0");

      if (iden != 0) {
        var colDef = new Col(0, 0, 0);
        if (iden < 0)
          colDef.r = colDef.g = colDef.b = 255;
        rLXD = rLX, rLYD = rLY;
        if (this.eff.ilightdirena.val) {
          rLXD = -Math.sin(ilightdir * Math.PI / 180);
          rLYD = Math.cos(ilightdir * Math.PI / 180);
        }
        iSD = Math.abs(iden);
        ioff *= Math.min(prefs.width, prefs.height) / 100;
        this.MakeShadow(imgShadow2, imgTemp, 1, 0, 0, ioff, rLXD, rLYD, iSD, colDef);
        this.Diffuse(imgShadow2, idiff);
      }

//            console.log("for y=0");
      for (var y = 0; y < prefs.height; ++y) {

        if (dden != 0) {
          pD = ((dy + y) * imgDest.width + dx) * 4;
          for (var x = 0; x < prefs.width; ++x) {
            GetCol(col00, imgShadow, x, y);
            col00.AddPix(imgDest, pD);
            pD += 4;
          }
        }

        pD = ((dy + y) * imgDest.width + dx) * 4;
        for (var x = 0; x < prefs.width; ++x) {
          GetCol(col00, imgTemp, x, y);
          col00.AddPix(imgDest, pD);
          pD += 4;
        }

        if (iden != 0) {
          pD = ((dy + y) * imgDest.width + dx) * 4;
          pM = (y * imgTemp.width) * 4;
          for (var x = 0; x < prefs.width; ++x) {
            GetCol(col00, imgShadow2, x, y);
            col00.MulAddPix(imgDest, imgTemp, pD,pM);
            pD += 4;
            pM += 4;
          }
        }

      }
    }
    this.Anim = function(from, to, ratio, curve) {
      switch (curve) {
        case 0:
          return from;
        case 1:
          return from + (to - from) * ratio;
        default:
          var r=from + (to - from) * animcurve[curve - 2].GetVal(ratio);
          return r;
      }
    }
    this.RenderFrame = function(imgDest, dx, dy, mode, frame, total) {
      var r;
      if (this.eff.fmaskena.val == 1) {
        var f;
        if (total > 0)
          f = (frame * 100) / total;
        else
          f = 0;
        if (f < this.eff.fmaskstart.val || f > this.eff.fmaskstop.val) {
          if (mode == 0) {
            var col = new Col(0, 0, 0);
            col.a = 0;
            for (var y = 0; y < prefs.height; ++y) {
              p = ((y + dy) * prefs.width + dx) * 4;
              for (var x = 0; x < prefs.width; ++x) {
                col.SetPix(imgDest, p);
                p += 4;
              }
            }
          }
          return;
        }
      }
      if (this.eff.fmaskena.val == 2){
        var fmb = ""+this.eff.fmaskbits.val;
        var l = fmb.length;
        var p = (frame / total * l)|0;
        if(p >= l) p = l - 1;
//                console.log(bt,p,frame,total, bt[p|0], bt.length);
        if(p >= 0 && fmb[p] == "0"){
          var col = new Col(0, 0, 0);
          col.a = 0;
          for (var y = 0; y < prefs.height; ++y) {
            p = ((y + dy) * prefs.width + dx) * 4;
            for (var x = 0; x < prefs.width; ++x) {
              col.SetPix(imgDest, p);
              p += 4;
            }
          }
          return;
        }
      }
      if (this.eff.unfold.val) {
        if (this.eff.animstep.val == 0) {
          totalFrame = total + 1;
          startFrame = 0;
          endFrame = total;
        }
        else {
          totalFrame = this.eff.animstep.val;
          startFrame = 0;
          endFrame = this.eff.animstep.val - 1;
        }
      }
      else {
        if (this.eff.animstep.val == 0) {
          totalFrame = total + 1;
          startFrame = endFrame = frame;
        }
        else {
          totalFrame = this.eff.animstep.val;
          if (total > 0)
            startFrame = endFrame = Math.floor(frame * (this.eff.animstep.val - 1) / total);
          else
            startFrame = endFrame = 0;
        }
      }
//            console.log("RenderFrame_2");
      for (frame = startFrame; frame <= endFrame; ++frame) {
        if (this.prim.type.val == 14)
          this.prim.Render(frame, totalFrame);
        if (totalFrame <= 1)
          r = 0;
        else
          r = frame / (totalFrame - 1);
        var zoomx = this.Anim(this.eff.zoomxf.val, this.eff.zoomxt.val, r, this.eff.zoomxanim.val);
        var zoomy = this.Anim(this.eff.zoomyf.val, this.eff.zoomyt.val, r, this.eff.zoomyanim.val);
        if (this.eff.zoomxysepa.val == 0)
          zoomy = zoomx;
        var offx = this.Anim(this.eff.offxf.val, this.eff.offxt.val, r, this.eff.offxanim.val);
        var offy = this.Anim(this.eff.offyf.val, this.eff.offyt.val, r, this.eff.offyanim.val);
        var angle = this.Anim(this.eff.anglef.val, this.eff.anglet.val, r, this.eff.angleanim.val);
        var alpha = this.Anim(this.eff.alphaf.val, this.eff.alphat.val, r, this.eff.alphaanim.val);
        var bright = this.Anim(this.eff.brightf.val, this.eff.brightt.val, r, this.eff.brightanim.val);
        var cont = this.Anim(this.eff.contrastf.val, this.eff.contrastt.val, r, this.eff.contrastanim.val);
        var sat = this.Anim(this.eff.saturationf.val, this.eff.saturationt.val, r, this.eff.saturationanim.val);
        var hue = this.Anim(this.eff.huef.val, this.eff.huet.val, r, this.eff.hueanim.val);
        var mask1start = this.Anim(this.eff.mask1startf.val, this.eff.mask1startt.val, r, this.eff.mask1startanim.val);
        var mask1stop = this.Anim(this.eff.mask1stopf.val, this.eff.mask1stopt.val, r, this.eff.mask1stopanim.val);
        var mask2start = this.Anim(this.eff.mask2startf.val, this.eff.mask2startt.val, r, this.eff.mask2startanim.val);
        var mask2stop = this.Anim(this.eff.mask2stopf.val, this.eff.mask2stopt.val, r, this.eff.mask2stopanim.val);
        var slightdir = this.Anim(this.eff.slightdirf.val, this.eff.slightdirt.val, r, this.eff.slightdiranim.val);
        var sden = this.Anim(this.eff.sdensityf.val, this.eff.sdensityt.val, r, this.eff.sdensityanim.val);
        var dlightdir = this.Anim(this.eff.dlightdirf.val, this.eff.dlightdirt.val, r, this.eff.dlightdiranim.val);
        var doff = this.Anim(this.eff.doffsetf.val, this.eff.doffsett.val, r, this.eff.doffsetanim.val);
        var dden = this.Anim(this.eff.ddensityf.val, this.eff.ddensityt.val, r, this.eff.ddensityanim.val);
        var ddiff = this.Anim(this.eff.ddiffusef.val, this.eff.ddiffuset.val, r, this.eff.ddiffuseanim.val);
        var ilightdir = this.Anim(this.eff.ilightdirf.val, this.eff.ilightdirt.val, r, this.eff.ilightdiranim.val);
        var ioff = this.Anim(this.eff.ioffsetf.val, this.eff.ioffsett.val, r, this.eff.ioffsetanim.val);
        var iden = this.Anim(this.eff.idensityf.val, this.eff.idensityt.val, r, this.eff.idensityanim.val);
        var idiff = this.Anim(this.eff.idiffusef.val, this.eff.idiffuset.val, r, this.eff.idiffuseanim.val);
        var elightdir = this.Anim(this.eff.elightdirf.val, this.eff.elightdirt.val, r, this.eff.elightdiranim.val);
        var eoff = this.Anim(this.eff.eoffsetf.val, this.eff.eoffsett.val, r, this.eff.eoffsetanim.val);
        var eden = this.Anim(this.eff.edensityf.val, this.eff.edensityt.val, r, this.eff.edensityanim.val);


        this.Rot(this.prim.imgdat, imgDest, dx, dy, mode, zoomx, zoomy, offx, offy, angle, alpha, bright, cont, sat, hue,
            mask1start, mask1stop, mask2start, mask2stop,
            slightdir, sden, dlightdir, doff, dden, ddiff, ilightdir, ioff, iden, idiff, elightdir, eoff, eden);


        mode = 1;
      }
    }
    this.Draw = function() {
      ctxPrevFrom.fillStyle = "#808080";
      ctxPrevFrom.fillRect(0, 0, 128, 128);
      ctxPrevTo.fillStyle = "#808080";
      ctxPrevTo.fillRect(0, 0, 128, 128);
      this.RenderFrame(this.imgprevf, 0, 0, 0, 0, 1);
      ctxWork.putImageData(this.imgprevf, 0, 0);
      ctxPrevFrom.drawImage(cvWork, 0, 0, prefs.width, prefs.height, 0, 0, cvPrevFrom.width, cvPrevFrom.height);
      this.RenderFrame(this.imgprevt, 0, 0, 0, 1, 1);
      ctxWork2.putImageData(this.imgprevt, 0, 0);
      ctxPrevTo.drawImage(cvWork2, 0, 0, prefs.width, prefs.height, 0, 0, cvPrevTo.width, cvPrevTo.height);
    }
  }
  function Init() {
    DDInit();
    if (CheckFileApi())
      fileapi = 1;
    prefs = new Prefs();
    animcurve = Array();
    for (var i = 0; i < 8; ++i)
      animcurve[i] = new AnimCurve();
    shapeeditor = new ShapeEditor();
    curveeditor=new CurveEditor();
    cvPrevFrom = document.getElementById("canvasprevfrom");
    ctxPrevFrom = cvPrevFrom.getContext("2d");
    cvPrevTo = document.getElementById("canvasprevto");
    ctxPrevTo = cvPrevTo.getContext("2d");
    cvRender = document.getElementById("canvasrender");
    ctxRender = cvRender.getContext("2d");
    imgRender = ctxRender.createImageData(prefs.width, prefs.height * prefs.framesprev.val);
    cvWork = document.getElementById("canvaswork");
    ctxWork = cvWork.getContext("2d");
    cvWork2 = document.getElementById("canvaswork2");
    ctxWork2 = cvWork2.getContext("2d");
    cvWork3 = document.getElementById("canvaswork3");

    colorMap = new ColorMapControl(document.getElementById("primcolor"));
    document.getElementById("primcolor").onchange=(ev)=>{
      if(curLayer>=0){
        layers[curLayer].prim.color.SetRgb(colorMap.col.r,colorMap.col.g,colorMap.col.b);
        RedrawLayer(1);
      }
    };
    var vals=document.getElementsByClassName("valedit");
    for(let i=0;i<vals.length;++i){
      vals[i].onkeydown = EditV;
      vals[i].onblur = EditV;//(ev)=>{ev.target.style.backgroundColor="#fff";}
    }
/*
    cvColorMap = document.getElementById("colormap");
    cvColorMap.onmousedown = ColorMapDown;
    cvColorMap.onmousemove = ColorMapMove;
    cvColorMap.onmouseup = ColorMapUp;
    ctxColorMap = cvColorMap.getContext("2d");
    imgdatColorMap = ctxColorMap.getImageData(0, 0, 120, 120);
    col = new Col(0, 0, 0);
    p = 0;
    for (var y = 0; y < 120; ++y) {
      for (var x = 0; x < 120; ++x) {
        col.SetHls(x * 2, 120, 238 - y * 2);
        imgdatColorMap.data[p] = col.r;
        imgdatColorMap.data[p + 1] = col.g;
        imgdatColorMap.data[p + 2] = col.b;
        imgdatColorMap.data[p + 3] = 255;
        p += 4;
      }
    }
    ctxColorMap.putImageData(imgdatColorMap, 0, 0);
    imgColorbar = ctxColorMap.getImageData(130, 0, 10, 120);
*/
    curLayer = 0;
    layers = new Array();
    layers[0] = new Layer();
    layers[1] = new Layer();
    layers[2] = new Layer();
    DispPrimParams();
//        ColorBar(layers[0].prim.color);
    prefs.Init();
    Render();
    var qs = window.location.search.substring(1).split("&");
    console.log(qs)
    for (var i = 0; i < qs.length; ++i) {
      if (qs[i].indexOf("f=") == 0) {
        q = qs[i].substring(2);
        document.menu.filename.value = q.substring(q.lastIndexOf("/") + 1);
      }
      if (qs[i].indexOf("v=") == 0 || qs[i].indexOf("n=") == 0) {
        LoadExecFile("./get.php?t=b64&" + qs[i]);
        document.getElementById("thumbimg").src="./get.php?t=img&"+qs[i];
        console.log("get:"+document.getElementById("thumbimg").src);
      }
      if (qs[i].indexOf("m=") == 0)
        easy=1;
      else
        easy=0;
    }
    if(easy) {
      document.getElementById("title").innerHTML="WebKnobMan Easy Renderer ver. 0.96";
      document.getElementById("preference").style.height="300px";
      document.getElementById("preference").style.display="block";
      document.getElementById("menupane").style.display="none";
      document.getElementById("exportexec").style.display="block";
      document.getElementById("prevframes").style.display="none";
//			document.getElementById("mask").style.height="360px";
//            document.getElementById("knobup").style.display="none";
      document.getElementById("thumb").style.display="block";
      document.getElementById("thumbname").innerHTML=document.menu.filename.value;
      SelLayer(-1);
    }
    else {
      document.getElementById("title").innerHTML="WebKnobMan ver. 0.96";
      document.getElementById("layerpane").style.display="block";
      document.getElementById("primitive").style.display="block";
      document.getElementById("effects").style.display="block";
      document.getElementById("renderpane").style.display="block";
      SelLayer(0);
    }
  }
/*
  function ColorBar(c) {
    var h = c.h;
    var s = c.s;
    var col = new Col(0, 0, 0);
    var p = 0;
    for (var y = 0; y < 120; ++y) {
      col.SetHls(h, (119 - y) * 2, s);
      for (var x = 0; x < 10; ++x) {
        imgColorbar.data[p] = col.r;
        imgColorbar.data[p + 1] = col.g;
        imgColorbar.data[p + 2] = col.b;
        imgColorbar.data[p + 3] = 255;
        p += 4;
      }
    }
    ctxColorMap.putImageData(imgColorbar, 130, 0);
  }
*/
  function fillarc(c, x, y, r) {
    c.beginPath();
    c.arc(x, y, r, 0, Math.PI * 2, true);
    c.fill();
  }
  function Tree(name) {
    menu = document.all[name].style;
    if (menu.display == "none") menu.display = "block";
    else menu.display = "none";
  }
  function OpenColor() {
    cm = document.getElementById("colmap");
    if (cm.style.display == "none")
      cm.style.display = "block";
    else
      cm.style.display = "none";
  }
  function SetFont(){
    if(curLayer < 0)
      return;
    layers[curLayer].prim.font.Set();
    const f=layers[curLayer].prim.font.form;
    let s=f.options[f.selectedIndex].value;
    if(s[0]=="(")
      s=s.substring(1,s.length-2);
    layers[curLayer].prim.fontname=s;
    layers[curLayer].prim.Render();
    RedrawLayer(1);
  }
  function SetTexture() {
    if (curLayer < 0)
      return;
    layers[curLayer].prim.texturefile.Set();
    layers[curLayer].prim.texturename = document.getElementById("texturesel").value;
    if (layers[curLayer].prim.texturename=="" || layers[curLayer].prim.texturename[0] == "(")
      layers[curLayer].prim.tex = layers[curLayer].prim.tex0;
    else
      layers[curLayer].prim.tex = new Tex(layers[curLayer].prim.texturename);
    layers[curLayer].prim.Render();
    RedrawLayer(1);
  }
  function SetPrimType() {
    if (curLayer < 0)
      return;
    layers[curLayer].prim.type.Set();
    SetIcon();
    layers[curLayer].prim.Render();
    DispPrimParams();
    RedrawLayer(1);
  }
  var primparamids = ["primaspect", "primround", "primwidth","primlength", "primstep","primanglestep",
    "primemboss", "primembossdiffuse", "primambient", "primlightdir",
    "primspecular", "primspecularwidth", "primtexturefile", "primtexturedepth", "primtexturezoom",
    "primdiffuse",  "primfile", "primcolor","primtext","primshape","primfont","primfontsize","primbold","primitalic","primalign"];
  var primparams = new Array();
  primparams[0] =  new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  primparams[1] =  new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0);
  primparams[2] =  new Array(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[3] =  new Array(1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[4] =  new Array(1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[5] =  new Array(1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[6] =  new Array(1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[7] =  new Array(1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[8] =  new Array(1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[9] =  new Array(0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[10] = new Array(0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[11] = new Array(1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[12] = new Array(1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[13] = new Array(1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0);
  primparams[14] = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1);
  primparams[15] = new Array(0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0);
  function DispPrimParams() {
    if (curLayer < 0)
      return;
    var t = layers[curLayer].prim.type.val;
    for (var i = 0; i < primparamids.length; ++i) {
      document.getElementById(primparamids[i]).style.display = (primparams[t][i] ? "flex" : "none");
    }
  }
  function RedrawRender() {
    renderframe = -3;
    renderlayer = 0;
    renderinit = 0;
  }
  function RedrawLayer(r) {
    if (curLayer < 0)
      return;
    if(r == 0){
      layers[curLayer].prim.Render();
      layers[curLayer].Draw();
      return;
    }
    renderframe = -3;
    renderlayer = 0;
    renderinit = 0;
    return;

    layers[curLayer].prim.Render();
    layers[curLayer].Draw();
    if(r){
      RedrawRender();
    }
  }
  function SetupPrefs() {
    prefs.paramwidth.val = prefs.width;
    prefs.paramheight.val = prefs.height;
    prefs.paramwidth.Disp();
    prefs.paramheight.Disp();
    prefs.framesprev.Disp();
    prefs.framesrender.Disp();
  }
  function EditV(ev){
//        console.log(ev)
    var elm=ev.target;
    if(ev.type=="blur"){
      elm.style.backgroundColor="#fff";
    }
    else if(ev.type=="keydown" && elm.param){
      console.log(event.code)
      switch(event.code){
      case "ArrowUp":
        if(event.shiftKey)
          elm.param.val = elm.param.val + 0.01;
        else
          elm.param.val = elm.param.val + 1;
        elm.param.Disp();
        elm.style.backgroundColor="#ff0";
        event.preventDefault();
        break;
      case "ArrowDown":
        if(event.shiftKey)
          elm.param.val = elm.param.val - 0.01;
        else
          elm.param.val = elm.param.val - 1;
        elm.param.Disp();
        elm.style.backgroundColor="#ff0";
        event.preventDefault();
        break;
      case "Enter":
        elm.style.backgroundColor="#fff";
        break;
      case "ShiftLeft":
      case "ShiftRight":
      case "ControlLeft":
      case "ControlRight":
      case "AltLeft":
      case "AltRight":
        break;
      default:
        elm.style.backgroundColor="#ff0";
        break;
      }
    }
  }
  function EditPrefs(r) {
    if (exporting)
      return;
    if (document.getElementById("imgxylink").checked) {
      prefs.paramwidth.Set();
      prefs.paramheight.val = prefs.paramwidth.val;
      prefs.paramheight.Disp();
    }
    else {
      prefs.paramwidth.Set();
      prefs.paramheight.Set();
    }
    console.log("EditPRefs")
    switch(document.getElementById("exportas").selectedIndex){
    case 0:
//            document.getElementById("orientationrow").style.display = "block";
//            document.getElementById("durationrow").style.display = "none";
//            document.getElementById("shuttlerow").style.display = "none";
      document.getElementById("orientation").disabled = false;
      document.getElementById("duration").disabled = true;
      document.getElementById("shuttle").disabled = true;
      break;
    case 1:
//            document.getElementById("orientationrow").style.display = "none";
//            document.getElementById("durationrow").style.display = "block";
//            document.getElementById("shuttlerow").style.display = "block";
      document.getElementById("orientation").disabled = true;
      document.getElementById("duration").disabled = false;
      document.getElementById("shuttle").disabled = false;
      break;
    }
    prefs.framesprev.Set();
    prefs.framesrender.Set();
    prefs.bkcolr.Set();
    prefs.bkcolg.Set();
    prefs.bkcolb.Set();
    prefs.alignhorz = document.getElementById("orientation").selectedIndex;
//        if(document.getElementById("alignhorz").checked)
//            prefs.alignhorz=1;
//        else
//            prefs.alignhorz=0;
    prefs.bkcolor = new Col(prefs.bkcolr.val, prefs.bkcolg.val, prefs.bkcolb.val);
    document.getElementById("renderpane").style.background = prefs.bkcolor.GetColStr();
//        document.getElementById("renderpaneframe").style.background = prefs.bkcolor.GetColStr();
    if (r == 2) {
      prefs.frames = prefs.framesprev.val;
      prefs.width = prefs.paramwidth.val;
      prefs.height = prefs.paramheight.val;
      c = document.getElementById("canvasrender");
      if(exporting && document.getElementById("orientation").selectedIndex==1 && document.getElementById("exportas").selectedIndex==0) {
        c.width = prefs.width*prefs.frames;
        c.height = prefs.height;
        imgRender=ctxRender.createImageData(prefs.width * prefs.frames, prefs.height);
      }
      else {
        c.width = prefs.width;
        c.height = prefs.height*prefs.frames;
        imgRender = ctxRender.createImageData(prefs.width, prefs.height * prefs.frames);
      }
      for (var i = 0; i < layers.length; ++i) {
        layers[i].SetSize(1);
      }
      RedrawRender();
    }
  }
  function EditEff(r) {
    if (curLayer < 0 || exporting)
      return;
    const eff = layers[curLayer].eff;
    eff.antialias.Set();
    eff.unfold.Set();
    eff.animstep.Set();
    eff.zoomxysepa.Set();
    eff.zoomxf.Set();
    eff.zoomxt.Set();
    eff.zoomxanim.Set();
    eff.zoomyf.Set();
    eff.zoomyt.Set();
    eff.zoomyanim.Set();
    eff.offxf.Set();
    eff.offxt.Set();
    eff.offxanim.Set();
    eff.offyf.Set();
    eff.offyt.Set();
    eff.offyanim.Set();
    eff.keepdir.Set();
    eff.centerx.Set();
    eff.centery.Set();
    eff.anglef.Set();
    eff.anglet.Set();
    eff.angleanim.Set();
    eff.alphaf.Set();
    eff.alphat.Set();
    eff.alphaanim.Set();
    eff.brightf.Set();
    eff.brightt.Set();
    eff.brightanim.Set();
    eff.contrastf.Set();
    eff.contrastt.Set();
    eff.contrastanim.Set();
    eff.saturationf.Set();
    eff.saturationt.Set();
    eff.saturationanim.Set();
    eff.huef.Set();
    eff.huet.Set();
    eff.hueanim.Set();
    eff.mask1ena.Set();
    eff.mask1type.Set();
    eff.mask1grad.Set();
    eff.mask1graddir.Set();
    eff.mask1startf.Set();
    eff.mask1startt.Set();
    eff.mask1startanim.Set();
    eff.mask1stopf.Set();
    eff.mask1stopt.Set();
    eff.mask1stopanim.Set();
    eff.mask2ena.Set();
    eff.mask2op.Set();
    eff.mask2type.Set();
    eff.mask2grad.Set();
    eff.mask2graddir.Set();
    eff.mask2startf.Set();
    eff.mask2startt.Set();
    eff.mask2startanim.Set();
    eff.mask2stopf.Set();
    eff.mask2stopt.Set();
    eff.mask2stopanim.Set();
    eff.fmaskena.Set();
    eff.fmaskstart.Set();
    eff.fmaskstop.Set();
    eff.fmaskbits.Set();
    eff.slightdirf.Set();
    eff.slightdirt.Set();
    eff.slightdiranim.Set();
    eff.sdensityf.Set();
    eff.sdensityt.Set();
    eff.sdensityanim.Set();
    eff.dlightdirena.Set();
    eff.dlightdirf.Set();
    eff.dlightdirt.Set();
    eff.dlightdiranim.Set();
    eff.doffsetf.Set();
    eff.doffsett.Set();
    eff.doffsetanim.Set();
    eff.ddensityf.Set();
    eff.ddensityt.Set();
    eff.ddensityanim.Set();
    eff.ddiffusef.Set();
    eff.ddiffuset.Set();
    eff.ddiffuseanim.Set();
    eff.dstype.Set();
    eff.dsgrad.Set();
    eff.ilightdirena.Set();
    eff.ilightdirf.Set();
    eff.ilightdirt.Set();
    eff.ilightdiranim.Set();
    eff.ioffsetf.Set();
    eff.ioffsett.Set();
    eff.ioffsetanim.Set();
    eff.idensityf.Set();
    eff.idensityt.Set();
    eff.idensityanim.Set();
    eff.idiffusef.Set();
    eff.idiffuset.Set();
    eff.idiffuseanim.Set();
    eff.elightdirena.Set();
    eff.elightdirf.Set();
    eff.elightdirt.Set();
    eff.elightdiranim.Set();
    eff.eoffsetf.Set();
    eff.eoffsett.Set();
    eff.eoffsetanim.Set();
    eff.edensityf.Set();
    eff.edensityt.Set();
    eff.edensityanim.Set();
    if (r) {
      RedrawLayer(1);
    }
  }
  function SetupForm() {
    if (curLayer < 0)
      return;
    DispPrimParams();
    const pr = layers[curLayer].prim;
    const eff = layers[curLayer].eff;
    pr.type.Disp();
    pr.aspect.Disp();
    pr.round.Disp();
    pr.width.Disp();
    pr.length.Disp();
    pr.step.Disp();
    pr.anglestep.Disp();
    pr.emboss.Disp();
    pr.embossdiffuse.Disp();
    pr.ambient.Disp();
    pr.lightdir.Disp();
    pr.specular.Disp();
    pr.specularwidth.Disp();
//        layers[curLayer].prim.texturefile.form.options[0].text = "("+layers[curLayer].prim.texturename+")";
    const op = document.getElementById("textureopt0");
    op.innerHTML = "("+pr.texturename+")";
//        console.log("tex0",layers[curLayer].prim.tex0.img);
    if(pr.tex0.img)
      op.insertBefore(pr.tex0.img, op.firstChild);
    pr.texturefile.Disp();
    pr.texturedepth.Disp();
    pr.texturezoom.Disp();
    pr.diffuse.Disp();
    pr.text.Disp();
    pr.font.form.options[0].text = "("+layers[curLayer].prim.fontname+")";
    pr.font.Disp();
    pr.fontsize.Disp();
    pr.bold.Disp();
    pr.italic.Disp();
    pr.textalign.Disp();
    pr.shape.Disp();
    pr.fill.Disp();
//        ColorBar(pr.color);
    SetupColorVal(pr.color);
    eff.antialias.Disp();
    eff.unfold.Disp();
    eff.animstep.Disp();
    eff.zoomxysepa.Disp();
    eff.zoomxf.Disp();
    eff.zoomxt.Disp();
    eff.zoomxanim.Disp();
    eff.zoomyf.Disp();
    eff.zoomyt.Disp();
    eff.zoomyanim.Disp();
    eff.offxf.Disp();
    eff.offxt.Disp();
    eff.offxanim.Disp();
    eff.offyf.Disp();
    eff.offyt.Disp();
    eff.offyanim.Disp();
    eff.keepdir.Disp();
    eff.centerx.Disp();
    eff.centery.Disp();
    eff.anglef.Disp();
    eff.anglet.Disp();
    eff.angleanim.Disp();
    eff.alphaf.Disp();
    eff.alphat.Disp();
    eff.alphaanim.Disp();
    eff.brightf.Disp();
    eff.brightt.Disp();
    eff.brightanim.Disp();
    eff.contrastf.Disp();
    eff.contrastt.Disp();
    eff.contrastanim.Disp();
    eff.saturationf.Disp();
    eff.saturationt.Disp();
    eff.saturationanim.Disp();
    eff.huef.Disp();
    eff.huet.Disp();
    eff.hueanim.Disp();
    eff.mask1ena.Disp();
    eff.mask1type.Disp();
    eff.mask1grad.Disp();
    eff.mask1graddir.Disp();
    eff.mask1startf.Disp();
    eff.mask1startt.Disp();
    eff.mask1startanim.Disp();
    eff.mask1stopf.Disp();
    eff.mask1stopt.Disp();
    eff.mask1stopanim.Disp();
    eff.mask2ena.Disp();
    eff.mask2op.Disp();
    eff.mask2type.Disp();
    eff.mask2grad.Disp();
    eff.mask2graddir.Disp();
    eff.mask2startf.Disp();
    eff.mask2startt.Disp();
    eff.mask2startanim.Disp();
    eff.mask2stopf.Disp();
    eff.mask2stopt.Disp();
    eff.mask2stopanim.Disp();
    eff.fmaskena.Disp();
    eff.fmaskstart.Disp();
    eff.fmaskstop.Disp();
    eff.fmaskbits.Disp();
    eff.slightdirf.Disp();
    eff.slightdirt.Disp();
    eff.slightdiranim.Disp();
    eff.sdensityf.Disp();
    eff.sdensityt.Disp();
    eff.sdensityanim.Disp();
    eff.dlightdirena.Disp();
    eff.dlightdirf.Disp();
    eff.dlightdirt.Disp();
    eff.dlightdiranim.Disp();
    eff.doffsetf.Disp();
    eff.doffsett.Disp();
    eff.doffsetanim.Disp();
    eff.ddensityf.Disp();
    eff.ddensityt.Disp();
    eff.ddensityanim.Disp();
    eff.ddiffusef.Disp();
    eff.ddiffuset.Disp();
    eff.ddiffuseanim.Disp();
    eff.dstype.Disp();
    eff.dsgrad.Disp();
    eff.ilightdirena.Disp();
    eff.ilightdirf.Disp();
    eff.ilightdirt.Disp();
    eff.ilightdiranim.Disp();
    eff.ioffsetf.Disp();
    eff.ioffsett.Disp();
    eff.ioffsetanim.Disp();
    eff.idensityf.Disp();
    eff.idensityt.Disp();
    eff.idensityanim.Disp();
    eff.idiffusef.Disp();
    eff.idiffuset.Disp();
    eff.idiffuseanim.Disp();
    eff.elightdirena.Disp();
    eff.elightdirf.Disp();
    eff.elightdirt.Disp();
    eff.elightdiranim.Disp();
    eff.eoffsetf.Disp();
    eff.eoffsett.Disp();
    eff.eoffsetanim.Disp();
    eff.edensityf.Disp();
    eff.edensityt.Disp();
    eff.edensityanim.Disp();
  }
  function EditPrim(r) {
    if (curLayer < 0 || exporting)
      return;
    const prim = layers[curLayer].prim;
    prim.aspect.Set();
    prim.round.Set();
    prim.width.Set();
    prim.length.Set();
    prim.step.Set();
    prim.anglestep.Set();
    prim.emboss.Set();
    prim.embossdiffuse.Set();
    prim.ambient.Set();
    prim.lightdir.Set();
    prim.specular.Set();
    prim.specularwidth.Set();
    prim.texturefile.Set();
    prim.texturedepth.Set();
    prim.texturezoom.Set();
    prim.diffuse.Set();
    prim.text.Set();
    prim.font.Set();
    prim.fontsize.Set();
    prim.bold.Set();
    prim.italic.Set();
    prim.textalign.Set();
    prim.shape.Set();
    prim.fill.Set();
    prim.color.SetColStr(colorMap.col.GetColStr());
    EditRgb();
    if (r)
      RedrawLayer(1);
  }
  function SelPal(r, g, b) {
/*
    layers[curLayer].prim.color.SetRgb(r,g,b);
    ColorBar(layers[curLayer].prim.color);
    SetupColorVal(layers[curLayer].prim.color);
  */
  }
  function EditRgb() {
/*
    layers[curLayer].prim.colr.Set();
    layers[curLayer].prim.colg.Set();
    layers[curLayer].prim.colb.Set();
    layers[curLayer].prim.color.SetRgb(layers[curLayer].prim.colr.val, layers[curLayer].prim.colg.val, layers[curLayer].prim.colb.val);
    ColorBar(layers[curLayer].prim.color);
    SetupColorVal(layers[curLayer].prim.color);
*/        
  }
  function EditHls() {
/*
    layers[curLayer].prim.colh.Set();
    layers[curLayer].prim.coll.Set();
    layers[curLayer].prim.cols.Set();
    layers[curLayer].prim.color.SetHls(layers[curLayer].prim.colh.val, layers[curLayer].prim.coll.val, layers[curLayer].prim.cols.val);
    ColorBar(layers[curLayer].prim.color);
    SetupColorVal(layers[curLayer].prim.color);
*/
  }
  function showSlider(ev) {
    target = document.getElementById("slider");
    if(!ev)
      ev = window.event;
    if (!ev.pageX)
      px = ev.clientX + document.body.scrollLeft;
    else
      px = ev.pageX;
    if (!ev.pageY)
      py = ev.clientY + document.body.scrollTop;
    else
      py = ev.pageY;

    target.style.left = px + 10 + "px";
    target.style.top = py + 5 + "px";
    target.style.visibility = "visible";
  }
/*
  function ColorMapSel() {
  }
*/
  function SelLayer(n) {
//        console.log("SelLayer:"+n);
    curLayer = n;
    for (n = 0; n <= MAXLAYER; ++n) {
      i = document.getElementById("layer" + n);
      if (n > layers.length)
        i.style.display = "none";
      else {
        i.style.display = "block";
        if (n == curLayer + 1) {
          i.style.border = "1px solid #808080";
          i.style.background = "#c0c0c0";
        }
        else {
          i.style.border = "1px solid #ffffff";
          i.style.background = "#ffffff";
        }
      }
    }
    if (curLayer < 0) {
      if(easy==0) {
        document.getElementById("preference").style.display = "block";
        document.getElementById("primitive").style.display = "none";
        document.getElementById("effects").style.display = "none";
      }
    }
    else {
      if(easy==0) {
        document.getElementById("preference").style.display = "none";
        document.getElementById("primitive").style.display = "block";
        document.getElementById("effects").style.display = "block";
      }
      SetupForm();
//            console.log("RedrawLayer(0)")
      RedrawLayer(0);
    }
  }
  function SetIcon() {
    var img;
    for (var i = 0; i < layers.length; ++i) {
      img = document.getElementById("icon" + (i + 1));
      img.src = ["./img/none.png", "./img/image.png", "./img/circle.png", "./img/circlefill.png", "./img/metalcircle.png"
      , "./img/wavecircle.png", "./img/sphere.png", "./img/rect.png", "./img/rectfill.png", "./img/triangle.png"
      , "./img/line.png", "./img/radiateline.png", "./img/hlines.png", "./img/vlines.png", "./img/text.png", "./img/shape.png"][layers[i].prim.type.val];
      const v = document.getElementById("lv" + (i + 1));
      if (layers[i].visible)
        v.checked = true;
      else
        v.checked = false;
      const name = document.getElementById("name" + (i + 1));
      if(layers[i].name)
        name.innerText = layers[i].name;
      else
        name.innerText = "Layer" + (i + 1);
    }
  }
  function New() {
    if (window.confirm("New File, OK?")) {
      prefs.Init();
      layers.length = 0;
      layers[0] = new Layer();
      layers[1] = new Layer();
      layers[2] = new Layer();
      SelLayer(0);
      SetIcon();
      RedrawRender();
      document.menu.filename.value="";
    }
  }
  function LoadExec(str) {
    console.log("LoadExec");
    function ReadAnim(ppr, anim, curve) {
      if (ppr.ReadVal(anim, 0) == 0)
        return 0;
      return ppr.ReadVal(curve, 1) + 1;
    }
    PopupMsg("Loading...");
    setTimeout(()=>{
    var ppr = new ProfileReader(str);
    if(ppr.err){
      PopupMsg("");
      alert("File format error");
      return;
    }
    ppr.FindSection("Prefs");
    var l = ppr.ReadVal("Layers", 1);
    layers.length = 0;
    for (var i = 0; i < l; ++i) {
      layers.push(new Layer());
    }
    prefs.width = ppr.ReadVal("OutputSizeX", 32);
    prefs.height = ppr.ReadVal("OutputSizeY", 32);
    prefs.alignhorz = ppr.ReadVal("AlignHorizontal",0);
    document.getElementById("orientation").selectedIndex = prefs.alignhorz;
//        if(prefs.alignhorz) {
//            document.getElementById("alignvert").checked=0;
//            document.getElementById("alignhorz").checked=1;
//        }
//        else {
//            document.getElementById("alignvert").checked=1;
//            document.getElementById("alignhorz").checked=0;
//        }
    if (prefs.width == prefs.height) {
      document.getElementById("imgxylink").checked = true;
    }
    else {
      document.getElementById("imgxylink").checked = false;
    }
    prefs.framesprev.val = prefs.framesrender.val = ppr.ReadVal("NumOfImage", 0);
    if (prefs.framesprev.val <= 0) {
      prefs.framesrender.val = ppr.ReadVal("RenderFrames", 31);
      prefs.framesprev.val = ppr.ReadVal("PreviewFrames", 5);
    }
    prefs.bkcolr.val=prefs.bkcolor.r = ppr.ReadVal("BkColorR", 255);
    prefs.bkcolg.val=prefs.bkcolor.g = ppr.ReadVal("BkColorG", 255);
    prefs.bkcolb.val=prefs.bkcolor.b = ppr.ReadVal("BkColorB", 255);
    prefs.bkcolr.Disp();
    prefs.bkcolg.Disp();
    prefs.bkcolb.Disp();

    document.getElementById("renderpane").style.background = prefs.bkcolor.GetColStr();

    for (var i = 0; i < 8; ++i) {
      console.log("Layer:"+i);
      var ii = i + 1;
      animcurve[i].lv[0] = ppr.ReadVal("Curve" + ii + "L0", 0);
      for (var j = 1; j < 5; ++j) {
        animcurve[i].tm[j] = ppr.ReadVal("Curve" + ii + "T" + j, -1);
        animcurve[i].lv[j] = ppr.ReadVal("Curve" + ii + "L" + j, -1);
      }
      animcurve[i].lv[5] = ppr.ReadVal("Curve" + ii + "L5", 100);
      animcurve[i].tm[0] = 0;
      animcurve[i].lv[5] = 100;
      animcurve[i].stepreso = ppr.ReadVal("Curve" + ii + "StepReso", 0);
    }

    for (var i = 0; i < layers.length; ++i) {
      layers[i].visible = ppr.ReadVal("Visible1_" + i, -1);
    }
    SetupPrefs();
    for (var i = 0; i < layers.length; ++i) {
      var sec = "Layer" + (i + 1);
      ppr.FindSection(sec);
      if(layers[i].visible<0)
        layers[i].visible = ppr.ReadVal("Visible", 1);
      switch (ppr.ReadString("Primitive", "None")) {
        case "None": layers[i].prim.type.val = 0; break;
        case "Image": layers[i].prim.type.val = 1; break;
        case "Circle": layers[i].prim.type.val = 2; break;
        case "CircleFill": layers[i].prim.type.val = 3; break;
        case "MetalCircle": layers[i].prim.type.val = 4; break;
        case "WaveCircle": layers[i].prim.type.val = 5; break;
        case "Sphere": layers[i].prim.type.val = 6; break;
        case "Rect": layers[i].prim.type.val = 7; break;
        case "RectFill": layers[i].prim.type.val = 8; break;
        case "Triangle": layers[i].prim.type.val = 9; break;
        case "Line": layers[i].prim.type.val = 10; break;
        case "RadiateLine": layers[i].prim.type.val = 11; break;
        case "H-Lines": layers[i].prim.type.val = 12; break;
        case "V-Lines": layers[i].prim.type.val = 13; break;
        case "Text": layers[i].prim.type.val = 14; break;
        case "Shape": layers[i].prim.type.val = 15; break;
      }
      layers[i].name = ppr.ReadString("Name", "Layer"+(i+1));
      layers[i].prim.color.r = ppr.ReadVal("ColR", 255);
      layers[i].prim.color.g = ppr.ReadVal("ColG", 0);
      layers[i].prim.color.b = ppr.ReadVal("ColB", 0);
      layers[i].prim.color.rgbtohls();
      layers[i].prim.aspect.val = ppr.ReadVal("PrimAspect", 0);
      layers[i].prim.round.val = ppr.ReadVal("PrimRound", 0);
      layers[i].prim.width.val = ppr.ReadVal("PrimWidth", 10);
      layers[i].prim.length.val = ppr.ReadVal("PrimLength", 50);
      layers[i].prim.step.val = ppr.ReadVal("PrimStep", 20);
      layers[i].prim.anglestep.val = ppr.ReadVal("PrimAngleStep", 45);
      layers[i].prim.emboss.val = ppr.ReadVal("PrimEmboss", 0);
      layers[i].prim.embossdiffuse.val = ppr.ReadVal("PrimEmbossDiffuse", 0);
      layers[i].prim.ambient.val = ppr.ReadVal("PrimAmbient", 50);
      layers[i].prim.lightdir.val = ppr.ReadVal("PrimLightDir", -50);
      layers[i].prim.specular.val = ppr.ReadVal("PrimSpecular", 0);
      layers[i].prim.specularwidth.val = ppr.ReadVal("PrimSpecWidth", 50);
      layers[i].prim.texturename = ppr.ReadString("PrimTextureFile", "");
      layers[i].prim.texturedepth.val = ppr.ReadVal("PrimTexture", 0);
      layers[i].prim.texturezoom.val = ppr.ReadVal("PrimTexZoom", 100);
      layers[i].prim.diffuse.val = ppr.ReadVal("PrimDiffuse", 0);
      layers[i].prim.text.val = ppr.ReadString("PrimText", "");
      layers[i].prim.fontname = ppr.ReadString("PrimFont", "");
      console.log("Font : "+layers[i].prim.fontname);
      layers[i].prim.file = ppr.ReadString("PrimFile","");
      layers[i].prim.fontsize.val = ppr.ReadVal("PrimSize", 50);
      layers[i].prim.bold.val = ppr.ReadVal("PrimBold", 0);
      layers[i].prim.italic.val = ppr.ReadVal("PrimItalic", 0);
      layers[i].prim.textalign.val = ppr.ReadVal("PrimTextAlign", 0);
      layers[i].prim.shape.val = ppr.ReadString("PrimShape", "");
      layers[i].prim.fill.val = ppr.ReadVal("PrimFill", 1);
      layers[i].eff.antialias.val = ppr.ReadVal("Antialias", 1);
      layers[i].eff.unfold.val = ppr.ReadVal("Unfold", 0);
      layers[i].eff.animstep.val = ppr.ReadVal("AnimStep", 0);
      layers[i].eff.zoomxysepa.val = ppr.ReadVal("ZoomXYSepa", 0);
      layers[i].eff.zoomxf.val = ppr.ReadVal("Zoom1", 100);
      layers[i].eff.zoomxt.val = ppr.ReadVal("Zoom2", 100);
      layers[i].eff.zoomxanim.val = ReadAnim(ppr, "AnimateZoom", "ZoomCurve");
      layers[i].eff.zoomyf.val = ppr.ReadVal("ZoomY1", 100);
      layers[i].eff.zoomyt.val = ppr.ReadVal("ZoomY2", 100);
      layers[i].eff.zoomyanim.val = ReadAnim(ppr,"AnimateZoomY", "ZoomYCurve");
      layers[i].eff.offxf.val = ppr.ReadVal("LayerOffsetX1", 0);
      layers[i].eff.offxt.val = ppr.ReadVal("LayerOffsetX2", 0);
      layers[i].eff.offxanim.val = ReadAnim(ppr,"AnimateLayerOffsetX", "LayerOffsetXCurve");
      layers[i].eff.offyf.val = ppr.ReadVal("LayerOffsetY1", 0);
      layers[i].eff.offyt.val = ppr.ReadVal("LayerOffsetY2", 0);
      layers[i].eff.offyanim.val = ReadAnim(ppr,"AnimateLayerOffsetY", "LayerOffsetYCurve");
      layers[i].eff.keepdir.val = ppr.ReadVal("KeepDir", 0);
      layers[i].eff.centerx.val = ppr.ReadVal("RotCenterX1", 0);
      layers[i].eff.centery.val = ppr.ReadVal("RotCenterY1", 0);
      layers[i].eff.anglef.val = ppr.ReadVal("Angle1", 0);
      layers[i].eff.anglet.val = ppr.ReadVal("Angle2", 0);
      layers[i].eff.angleanim.val = ReadAnim(ppr,"AnimateAngle", "AngleCurve");
      layers[i].eff.alphaf.val = ppr.ReadVal("Alpha1", 100);
      layers[i].eff.alphat.val = ppr.ReadVal("Alpha2", 100);
      layers[i].eff.alphaanim.val = ReadAnim(ppr,"AnimateAlpha", "AlphaCurve");
      layers[i].eff.brightf.val = ppr.ReadVal("Brightness1", 0);
      layers[i].eff.brightt.val = ppr.ReadVal("Brightness2", 0);
      layers[i].eff.brightanim.val = ReadAnim(ppr,"AnimateBrightness", "BrightnessCurve");
      layers[i].eff.contrastf.val = ppr.ReadVal("Contrast1", 0);
      layers[i].eff.contrastt.val = ppr.ReadVal("Contrast2", 0);
      layers[i].eff.contrastanim.val = ReadAnim(ppr,"AnimateContrast", "ContrastCurve");
      layers[i].eff.saturationf.val = ppr.ReadVal("Saturation1", 0);
      layers[i].eff.saturationt.val = ppr.ReadVal("Saturation2", 0);
      layers[i].eff.saturationanim.val = ReadAnim(ppr,"AnimateSaturation", "SaturationCurve");
      layers[i].eff.huef.val = ppr.ReadVal("Hue1", 0);
      layers[i].eff.huet.val = ppr.ReadVal("Hue2", 0);
      layers[i].eff.hueanim.val = ReadAnim(ppr,"AnimateHue", "HueCurve");
      layers[i].eff.mask1ena.val = ppr.ReadVal("UseMask", 0);
      layers[i].eff.mask1type.val = ppr.ReadVal("MaskType", 0);
      layers[i].eff.mask1grad.val = ppr.ReadVal("MaskGradation", 0);
      layers[i].eff.mask1graddir.val = ppr.ReadVal("MaskGradDir", 0);
      layers[i].eff.mask1startf.val = ppr.ReadVal("MaskStart1", -140);
      layers[i].eff.mask1startt.val = ppr.ReadVal("MaskStart2", -140);
      layers[i].eff.mask1startanim.val = ReadAnim(ppr,"AnimateMaskStart", "MaskStartCurve");
      layers[i].eff.mask1stopf.val = ppr.ReadVal("MaskStop1", 140);
      layers[i].eff.mask1stopt.val = ppr.ReadVal("MaskStop2", 140);
      layers[i].eff.mask1stopanim.val = ReadAnim(ppr,"AnimateMaskStop", "MaskStopCurve");
      layers[i].eff.mask2ena.val = ppr.ReadVal("UseMask2", 0);
      layers[i].eff.mask2op.val = ppr.ReadVal("Mask2Operation", 0);
      layers[i].eff.mask2type.val = ppr.ReadVal("Mask2Type", 0);
      layers[i].eff.mask2grad.val = ppr.ReadVal("Mask2Gradation", 0);
      layers[i].eff.mask2graddir.val = ppr.ReadVal("Mask2GradDir", 0);
      layers[i].eff.mask2startf.val = ppr.ReadVal("Mask2Start1", -140);
      layers[i].eff.mask2startt.val = ppr.ReadVal("Mask2Start2", -140);
      layers[i].eff.mask2startanim.val = ReadAnim(ppr,"AnimateMask2Start", "Mask2StartCurve");
      layers[i].eff.mask2stopf.val = ppr.ReadVal("Mask2Stop1", 140);
      layers[i].eff.mask2stopt.val = ppr.ReadVal("Mask2Stop2", 140);
      layers[i].eff.mask2stopanim.val = ReadAnim(ppr,"AnimateMask2Stop", "Mask2StopCurve");
      layers[i].eff.fmaskbits.val = ppr.ReadVal("FMaskBits", "11111");
      layers[i].eff.fmaskena.val = ppr.ReadVal("UseFMask", 0);
      layers[i].eff.fmaskstart.val = ppr.ReadVal("FMaskStart", 0);
      layers[i].eff.fmaskstop.val = ppr.ReadVal("FMaskStop", 0);
      layers[i].eff.slightdirf.val = ppr.ReadVal("LightDir", -45);
      layers[i].eff.slightdirt.val = ppr.ReadVal("LightDir2", -45);
      layers[i].eff.slightdiranim.val = ReadAnim(ppr,"AnimateLightDir", "LightDirCurve");
      layers[i].eff.sdensityf.val = ppr.ReadVal("Lighting", 0);
      layers[i].eff.sdensityt.val = ppr.ReadVal("Lighting2", 0);
      layers[i].eff.sdensityanim.val = ReadAnim(ppr,"AnimateLighting", "LightingCurve");
      layers[i].eff.dlightdirena.val = ppr.ReadVal("LightDirDEn", 0);
      layers[i].eff.dlightdirf.val = ppr.ReadVal("LightDirD", -45);
      layers[i].eff.dlightdirt.val = ppr.ReadVal("LightDirD2", -45);
      layers[i].eff.dlightdiranim.val = ReadAnim(ppr, "AnimateLightDirD", "LightDirDCurve");
      layers[i].eff.doffsetf.val = ppr.ReadVal("ShadowOffset1", 5);
      layers[i].eff.doffsett.val = ppr.ReadVal("ShadowOffset2", 5);
      layers[i].eff.doffsetanim.val = ReadAnim(ppr,"AnimateShadowOffset", "ShadowOffsetCurve");
      layers[i].eff.ddensityf.val = ppr.ReadVal("ShadowDensity1", 0);
      layers[i].eff.ddensityt.val = ppr.ReadVal("ShadowDensity2", 0);
      layers[i].eff.ddensityanim.val = ReadAnim(ppr,"AnimateShadowDensity", "ShadowDensityCurve");
      layers[i].eff.ddiffusef.val = ppr.ReadVal("ShadowDiffuse1", 0);
      layers[i].eff.ddiffuset.val = ppr.ReadVal("ShadowDiffuse2", 0);
      layers[i].eff.ddiffuseanim.val = ReadAnim(ppr,"AnimateShadowDiffuse", "ShadowDiffuseCurve");
      layers[i].eff.dstype.val = ppr.ReadVal("ShadowType", 0);
      layers[i].eff.dsgrad.val = ppr.ReadVal("ShadowGradate", 100);
      layers[i].eff.ilightdirena.val = ppr.ReadVal("LightDirIEn", 0);
      layers[i].eff.ilightdirf.val = ppr.ReadVal("LightDirI", -45);
      layers[i].eff.ilightdirt.val = ppr.ReadVal("LightDirI2", -45);
      layers[i].eff.ilightdiranim.val = ReadAnim(ppr,"AnimateLightDirI", "LightDirICurve");
      layers[i].eff.ioffsetf.val = ppr.ReadVal("IShadowOffset1", 5);
      layers[i].eff.ioffsett.val = ppr.ReadVal("IShadowOffset2", 5);
      layers[i].eff.ioffsetanim.val = ReadAnim(ppr,"AnimateIShadowOffset", "IShadowOffsetCurve");
      layers[i].eff.idensityf.val = ppr.ReadVal("IShadowDensity1", 0);
      layers[i].eff.idensityt.val = ppr.ReadVal("IShadowDensity2", 0);
      layers[i].eff.idensityanim.val = ReadAnim(ppr,"AnimateIShadowDensity", "IShadowDensityCurve");
      layers[i].eff.idiffusef.val = ppr.ReadVal("IShadowDiffuse1", 20);
      layers[i].eff.idiffuset.val = ppr.ReadVal("IShadowDiffuse2", 20);
      layers[i].eff.idiffuseanim.val = ReadAnim(ppr,"AnimateIShadowDiffuse", "IShadowDiffuseCurve");
      layers[i].eff.elightdirena.val = ppr.ReadVal("LightDirEEn", 0);
      layers[i].eff.elightdirf.val = ppr.ReadVal("LightDirE", -45);
      layers[i].eff.elightdirt.val = ppr.ReadVal("LightDirE2", -45);
      layers[i].eff.elightdiranim.val = ReadAnim(ppr,"AnimateLightDirE", "LightDirECurve");
      layers[i].eff.eoffsetf.val = ppr.ReadVal("HilightOffset1", 0);
      layers[i].eff.eoffsett.val = ppr.ReadVal("HilightOffset2", 0);
      layers[i].eff.eoffsetanim.val = ReadAnim(ppr,"AnimateHilightOffset", "HilightOffsetCurve");
      layers[i].eff.edensityf.val = ppr.ReadVal("HilightDensity1", 0);
      layers[i].eff.edensityt.val = ppr.ReadVal("HilightDensity2", 0);
      layers[i].eff.edensityanim.val = ReadAnim(ppr,"AnimateHilightDensity", "HilightDensityCurve");

      var ii;
      for(ii=0;ii<i;++ii) {
        if(layers[i].prim.texturename.length>0 && layers[i].prim.texturename==layers[ii].prim.texturename) {
          loadingtex[i] = new Image();
          if(loadingtex[ii]) {
            loadingtex[i].i = i;
            loadingtex[i].onload = function(ev) {
              i=ev.target.i;
              layers[i].prim.tex0 = new Tex("");
              layers[i].prim.tex0.img = loadingtex[i];
              layers[i].prim.tex = layers[i].prim.tex0;
              layers[i].SetSize(0);
              RedrawRender();
              SelLayer(0);
            }
            loadingtex[i].src = loadingtex[ii].src;
          }
          else
            ii=i;
          break;
        }
      }
      if(ii==i) {
        var t = ppr.ExtractFile("TexBmp");
        if (t.length > 0) {
          loadingtex[i] = new Image();
          loadingtex[i].i = i;
          loadingtex[i].onload = function(ev) {
            i = ev.target.i;
            layers[i].prim.tex0 = new Tex("");
            layers[i].prim.tex0.img = loadingtex[i];
            layers[i].prim.tex = layers[i].prim.tex0;
            layers[i].SetSize(0);
            RedrawRender();
            SelLayer(0);
          }
          loadingtex[i].src = "data:" + Mime(t) + ";base64," + B64(t);
        }
      }
      for(ii=0;ii<i;++ii) {
        if(layers[i].prim.file.length>0 && layers[i].prim.file==layers[ii].prim.file) {
          if(loadingimg[ii]) {
            loadingimg[i] = new Image();
            loadingimg[i].i = i;
            loadingimg[i].onload = function(ev) {
              i = ev.target.i;
              layers[i].prim.image = loadingimg[i];
              layers[i].SetSize(0);
              RedrawRender();
              SelLayer(0);
            }
            loadingimg[i].src = loadingimg[ii].src;
          }
          else
            ii=i;
          break;
        }
      }
      if(ii==i) {
        t = ppr.ExtractFile("ImgBmp");
        if (t.length > 0) {
          loadingimg[i] = new Image();
          loadingimg[i].i = i;
          loadingimg[i].onload = function(ev) {
            i = ev.target.i;
            layers[i].prim.image = loadingimg[i];
            layers[i].SetSize(0);
            RedrawRender();
            SelLayer(0);
          }
          loadingimg[i].src = "data:" + Mime(t) + ";base64," + B64(t);
        }
      }
    }
    SetIcon();
    EditPrefs(2);
    SelLayer(0);
    RedrawRender();
    PopupMsg("");
    },100);
  }
  function LoadExecFile(s) {
    PopupMsg("Loading...");
    var xhr = new XMLHttpRequest();
    xhr.open("GET", s, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        var bin = B64Dec(xhr.responseText);
        LoadExec(bin);
      }
    }
    xhr.send("");
  }
  function OpenFile(file) {
    console.log("OpenFile");
    document.menu.filename.value = file.name;
//        var f = document.menu.openfilename;
//        var n = f.value.lastIndexOf("\\");
//        var fn = f.value.substr(Math.max(0, n + 1));
//        n = fn.lastIndexOf("/");
//        fn = fn.substr(Math.max(0, n + 1));
//        document.menu.filename.value = fn;
    if (fileapi) {
      var reader = new FileReader();
      reader.onload = function(e) {
        LoadExec(reader.result);
      }
      reader.onerror = function(e) {
      }
      reader.readAsBinaryString(file);
    }
  }
  function AddLayer() {
    if (curLayer < 0) {
      curLayer=0;
    }
    layers.splice(curLayer, 0, new Layer());
    SelLayer(curLayer);
    SetIcon();
  }
  function DelLayer() {
    if (curLayer < 0)
      return;
    if (window.confirm("Delete Layer, OK?")) {
      layers.splice(curLayer, 1);
      if (curLayer >= layers.length)
        curLayer = layers.length - 1;
      SelLayer(curLayer);
      SetIcon();
      RedrawRender();
    }
  }
  function DupLayer() {
    if (curLayer < 0)
      return;
    layers.splice(curLayer, 0, new Layer());
    SetPrimType();
    EditPrim(0);
    EditEff(0);

    SelLayer(curLayer);
    SetIcon();
  }
  function MoveFore() {
    if (curLayer < 0||curLayer>=layers.length-1)
      return;
    layers.splice(curLayer, 2,layers[curLayer+1],layers[curLayer]);
    SelLayer(curLayer + 1);
    SetIcon();
    RedrawRender();
  }
  function MoveBack() {
    if (curLayer < 1)
      return;
    layers.splice(curLayer-1, 2, layers[curLayer], layers[curLayer-1]);
    SelLayer(curLayer-1);
    SetIcon();
    RedrawRender();
  }
  function RenameLayer(){
    if(curLayer < 0)
      return;
    const ret = prompt("Rename layer");
    if(ret == null)
      ;
    else if(ret == "")
      layers[curLayer].name = "";
    else
      layers[curLayer].name = ret;
    SetIcon();
  }
  function OpenImage() {
    var f = document.prim.file;
    if (fileapi) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var s = reader.result;
        var im = new Image();
        im.src = s;
        im.onload = function() {
          layers[curLayer].prim.image = im;
          EditPrim(1);
        }
      }
      reader.onerror = function(e) {
      }
      reader.readAsDataURL(f.files[0]);
    }
  }
  function OpenTex() {
    var f = document.prim.usertex;
    if (fileapi) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var s = reader.result;
        var im = new Image();
        im.src = s;
        im.onload = function() {
          layers[curLayer].prim.image = im;
          EditPrim(1);
        }
      }
      reader.onerror = function(e) {
      }
      reader.readAsDataURL(f.files[0]);
    }
  }
  function Export() {
//		document.getElementById("mask").style.display="block";
    exporting = 1;
    c = document.getElementById("canvasrender");
    if(document.getElementById("orientation").selectedIndex==1 && document.getElementById("exportas")==0){
      c.width = prefs.width*prefs.framesrender.val;
      c.height = prefs.height;
      imgRender = ctxRender.createImageData(prefs.width * prefs.framesrender.val, prefs.height);
    }
    else{
      c.width = prefs.width;
      c.height = prefs.height * prefs.framesrender.val;
      imgRender = ctxRender.createImageData(prefs.width, prefs.height * prefs.framesrender.val);
    }
/*        if(document.getElementById("alignvert").checked) {
      c.width = prefs.width;
      c.height = prefs.height * prefs.framesrender.val;
      imgRender = ctxRender.createImageData(prefs.width, prefs.height * prefs.framesrender.val);
    }
    else {
      c.width = prefs.width*prefs.framesrender.val;
      c.height = prefs.height;
      imgRender = ctxRender.createImageData(prefs.width * prefs.framesrender.val, prefs.height);
    }
*/
    prefs.frames = prefs.framesrender.val;
    document.getElementById("renderpaneframe").style.display = "block";
    var o = document.getElementById("renderimage");
    o.src = "img/none.png";
    document.getElementById("rendermsg").innerHTML = "Now Rendering...";
//        PopupMsg("NowRendering...");
    RedrawRender();
  }
  function PopupMsg(str) {
    console.log(str);
    if(str) {
      document.getElementById("popupmask").style.display="block";
      document.getElementById("popupmsg").innerHTML = str;
    }
    else {
      document.getElementById("popupmask").style.display="none";
      document.getElementById("popupmsg").innerHTML="";
    }
  }
  function CloseRender() {
    var o = document.getElementById("renderpaneframe");
    o.style.display = "none";
    EditPrefs(2);
    RedrawRender();
  }
  function ElemDisp(id,s) {
    document.getElementById(id).style.display = s;
  }
  function ElemToggle(id) {
    var el = document.getElementById(id);
    if (el.style.display == "none")
      el.style.display = "block";
    else
      el.style.display = "none";
  }
  function Dummy() {
  }
  function SetVisible(n) {
    var c = document.getElementById("lv" + (n + 1));
    layers[n].visible = c.checked ? 1 : 0;
    RedrawRender();
  }
  function SetLi(n) {
    if(n==0) {
      document.upload.ccsa.disabled=true;
      document.upload.ccnd.disabled=true;
      document.upload.ccnc.disabled=true;
    }
    else {
      document.upload.ccsa.disabled=false;
      document.upload.ccnd.disabled=false;
      document.upload.ccnc.disabled=false;
    }
  }
  function SetCC(n) {
    if(n==1 && document.upload.ccsa.checked && document.upload.ccnd.checked)
      document.upload.ccnd.checked=false;
    if(n==2 && document.upload.ccnd.checked && document.upload.ccsa.checked)
      document.upload.ccsa.checked=false;
    var flg=0;
    if(document.upload.ccsa.checked)
      flg|=1;
    if(document.upload.ccnd.checked)
      flg|=2;
    if(document.upload.ccnc.checked)
      flg|=4;
    document.getElementById("ccmark").src="./img/"+["CC-BY-4.0.png","CC-BY-SA-4.0.png","CC-BY-ND-4.0.png","","CC-BY-NC-4.0.png","CC-BY-NC-SA-4.0.png","CC-BY-NC-NC-4.0.png",""][flg];
  }
  function Save(mode) {
    function WriteAnimParam(s1, s2, s3, s4, paramFrom, paramTo, paramAnim) {
      ppw.WriteFloat(s1, paramFrom.val);
      ppw.WriteFloat(s2, paramTo.val);
      ppw.WriteInt(s3, paramAnim.val ? 1 : 0);
      ppw.WriteInt(s4, Math.max(0, paramAnim.val - 1));
    }
    var thumb = Thumbnail();
    var ppw = new ProfileWriter();
    ppw.WriteHeader(thumb);
    ppw.Section("Prefs");
    ppw.WriteStr("Version", "1490");
    ppw.WriteInt("Layers", layers.length);
    ppw.WriteInt("CurrentLayer", 1);
    ppw.WriteInt("Styles", 1);
    ppw.WriteInt("CurrentStyle", 0);
    ppw.WriteInt("OutputSizeX", prefs.width);
    ppw.WriteInt("OutputSizeX1", prefs.width);
    ppw.WriteInt("OutputSizeY", prefs.height);
    ppw.WriteInt("OutputSizeY1", prefs.height);
    ppw.WriteInt("RenderFrames", prefs.framesrender.val);
    ppw.WriteInt("PreviewFrames", prefs.framesprev.val);
    ppw.WriteInt("AlignHorizontal",prefs.alignhorz);
    ppw.WriteInt("BkColorR", prefs.bkcolor.r);
    ppw.WriteInt("BkColorG", prefs.bkcolor.g);
    ppw.WriteInt("BkColorB", prefs.bkcolor.b);
    for (var i = 0; i < layers.length; ++i) {
      ppw.WriteInt("Visible1_" + i, layers[i].visible);
    }
    for (var i = 1; i < 8; ++i) {
      ppw.WriteInt("Curve" + i + "L0", animcurve[i - 1].lv[0]);
      for (j = 1; j <= 4; ++j) {
        ppw.WriteInt("Curve" + i + "T" + j, animcurve[i - 1].tm[j]);
        ppw.WriteInt("Curve" + i + "L" + j, animcurve[i - 1].lv[j]);
      }
      ppw.WriteInt("Curve" + i + "L5", animcurve[i - 1].lv[5]);
      ppw.WriteInt("Curve" + i + "StepReso", animcurve[i - 1].stepreso);
    }
    for (var i = 0; i < layers.length; ++i) {
      ppw.Section("Layer" + (i + 1));
      if(layers[i].name){
        ppw.WriteStr("Name", layers[i].name);
      }
      ppw.WriteInt("ColR", layers[i].prim.color.r);
      ppw.WriteInt("ColG", layers[i].prim.color.g);
      ppw.WriteInt("ColB", layers[i].prim.color.b);
      ppw.WriteStr("Primitive", ["None", "Image", "Circle", "CircleFill", "MetalCircle", "WaveCircle", "Sphere", "Rect", "RectFill", "Triangle", "Line", "RadiateLine", "H-Lines", "V-Lines", "Text", "Shape"][layers[i].prim.type.val]);
      ppw.WriteInt("PrimFill", layers[i].prim.fill.val);
      ppw.WriteFloat("PrimAspect", layers[i].prim.aspect.val);
      ppw.WriteFloat("PrimWidth", layers[i].prim.width.val);
      ppw.WriteFloat("PrimRound", layers[i].prim.round.val);
      ppw.WriteFloat("PrimLength", layers[i].prim.length.val);
      ppw.WriteFloat("PrimStep", layers[i].prim.step.val);
      ppw.WriteFloat("PrimAngleStep", layers[i].prim.anglestep.val);
      ppw.WriteFloat("PrimEmboss", layers[i].prim.emboss.val);
      ppw.WriteFloat("PrimEmbossDiffuse", layers[i].prim.embossdiffuse.val);
      ppw.WriteStr("PrimTextureFile", layers[i].prim.texturename);
      ppw.WriteFloat("PrimTexture", layers[i].prim.texturedepth.val);
      ppw.WriteFloat("PrimTexZoom", layers[i].prim.texturezoom.val);
      ppw.WriteFloat("PrimDiffuse", layers[i].prim.diffuse.val);
      ppw.WriteFloat("PrimAmbient", layers[i].prim.ambient.val);
      ppw.WriteFloat("PrimSpecWidth", layers[i].prim.specularwidth.val);
      ppw.WriteFloat("PrimSpecular", layers[i].prim.specular.val);
      ppw.WriteFloat("PrimLightDir", layers[i].prim.lightdir.val);
      ppw.WriteFloat("PrimSize", layers[i].prim.fontsize.val);
      ppw.WriteInt("PrimBold", layers[i].prim.bold.val);
      ppw.WriteInt("PrimItalic", layers[i].prim.italic.val);
      ppw.WriteInt("PrimTextAlign", layers[i].prim.textalign.val);
      ppw.WriteStr("PrimText", layers[i].prim.text.val);
      ppw.WriteStr("PrimFont", layers[i].prim.fontname);
      ppw.WriteStr("PrimFile", layers[i].prim.file);
      ppw.WriteStr("PrimShape", layers[i].prim.shape.val);
      /*    ppw.WriteInt(L"Transparent",pp.iTransparent);
      ppw.WriteInt(L"AutoFit",pp.bAutoFit);
      ppw.WriteInt(L"IntelliAlpha",pp.iPrimIntelliAlpha);
      ppw.WriteInt(L"PrimFrames",pp.iPrimFrames);
      ppw.WriteInt(L"PrimAlign",pp.iPrimAlign);
      */
      ppw.WriteInt("Antialias", layers[i].eff.antialias.val);
      ppw.WriteInt("Unfold", layers[i].eff.unfold.val);
      ppw.WriteInt("KeepDir", layers[i].eff.keepdir.val);
      ppw.WriteInt("AnimStep", layers[i].eff.animstep.val);
      ppw.WriteFloat("Angle1", layers[i].eff.anglef.val);
      ppw.WriteFloat("Angle2", layers[i].eff.anglet.val);
      ppw.WriteInt("AnimateAngle", layers[i].eff.angleanim.val ? 1 : 0);
      ppw.WriteInt("AngleCurve", Math.max(0, layers[i].eff.angleanim.val - 1));
      ppw.WriteInt("ZoomXYSepa", layers[i].eff.zoomxysepa.val);

      WriteAnimParam("Zoom1", "Zoom2", "AnimateZoom", "ZoomCurve", layers[i].eff.zoomxf, layers[i].eff.zoomxt, layers[i].eff.zoomxanim);
      WriteAnimParam("ZoomY1", "ZoomY2", "AnimateZoomY", "ZoomYCurve", layers[i].eff.zoomyf, layers[i].eff.zoomyt, layers[i].eff.zoomyanim);
      ppw.WriteFloat("RotCenterX1", layers[i].eff.centerx.val);
      ppw.WriteFloat("RotCenterY1", layers[i].eff.centery.val);
      WriteAnimParam("LayerOffsetX1", "LayerOffsetX2", "AnimateLayerOffsetX", "LayerOffsetXCurve", layers[i].eff.offxf, layers[i].eff.offxt, layers[i].eff.offxanim);
      WriteAnimParam("LayerOffsetY1", "LayerOffsetY2", "AnimateLayerOffsetY", "LayerOffsetYCurve", layers[i].eff.offyf, layers[i].eff.offyt, layers[i].eff.offyanim);
      WriteAnimParam("Alpha1", "Alpha2", "AnimateAlpha", "AlphaCurve", layers[i].eff.alphaf, layers[i].eff.alphat, layers[i].eff.alphaanim);
      WriteAnimParam("Brightness1", "Brightness2", "AnimateBrightness", "BrightnessCurve", layers[i].eff.brightf, layers[i].eff.brightt, layers[i].eff.brightanim);
      WriteAnimParam("Contrast1", "Contrast2", "AnimateContrast", "ContrastCurve", layers[i].eff.contrastf, layers[i].eff.contrastt, layers[i].eff.contrastanim);
      WriteAnimParam("Saturation1", "Saturation2", "AnimateSaturation", "SaturationCurve", layers[i].eff.saturationf, layers[i].eff.saturationt, layers[i].eff.saturationanim);
      WriteAnimParam("Hue1", "Hue2", "AnimateHue", "HueCurve", layers[i].eff.huef, layers[i].eff.huet, layers[i].eff.hueanim);
      ppw.WriteInt("UseMask", layers[i].eff.mask1ena.val);
      ppw.WriteInt("MaskType", layers[i].eff.mask1type.val);
      ppw.WriteFloat("MaskGradation", layers[i].eff.mask1grad.val);
      ppw.WriteInt("MaskGradDir", layers[i].eff.mask1graddir.val);
      WriteAnimParam("MaskStart1", "MaskStart2", "AnimateMaskStart", "MaskStartCurve", layers[i].eff.mask1startf, layers[i].eff.mask1startt, layers[i].eff.mask1startanim);
      WriteAnimParam("MaskStop1", "MaskStop2", "AnimateMaskStop", "MaskStopCurve", layers[i].eff.mask1stopf, layers[i].eff.mask1stopt, layers[i].eff.mask1stopanim);
      ppw.WriteInt("UseMask2", layers[i].eff.mask2ena.val);
      ppw.WriteInt("Mask2Operation", layers[i].eff.mask2op.val);
      ppw.WriteInt("Mask2Type", layers[i].eff.mask2type.val);
      ppw.WriteFloat("Mask2Gradation", layers[i].eff.mask2grad.val);
      ppw.WriteInt("Mask2GradDir", layers[i].eff.mask2graddir.val);
      WriteAnimParam("Mask2Start1", "Mask2Start2", "AnimateMask2Start", "Mask2StartCurve", layers[i].eff.mask2startf, layers[i].eff.mask2startt, layers[i].eff.mask2startanim);
      WriteAnimParam("Mask2Stop1", "Mask2Stop2", "AnimateMask2Stop", "Mask2StopCurve", layers[i].eff.mask2stopf, layers[i].eff.mask2stopt, layers[i].eff.mask2stopanim);
      ppw.WriteInt("UseFMask", layers[i].eff.fmaskena.val);
      ppw.WriteFloat("FMaskStart", layers[i].eff.fmaskstart.val);
      ppw.WriteFloat("FMaskStop", layers[i].eff.fmaskstop.val);
      ppw.WriteStr("FMaskBits", layers[i].eff.fmaskbits.val);
      WriteAnimParam("LightDir", "LightDir2", "AnimateLightDir", "LightDirCurve", layers[i].eff.slightdirf, layers[i].eff.slightdirt, layers[i].eff.slightdiranim);
      WriteAnimParam("Lighting", "Lighting2", "AnimateLighting", "LightingCurve", layers[i].eff.sdensityf, layers[i].eff.sdensityt, layers[i].eff.sdensityanim);

      ppw.WriteInt("LightDirDEn", layers[i].eff.dlightdirena.val);
      WriteAnimParam("LightDirD", "LightDirD2", "AnimateLightDirD", "LightDirDCurve", layers[i].eff.dlightdirf, layers[i].eff.dlightdirt, layers[i].eff.dlightdiranim);
      WriteAnimParam("ShadowOffset1", "ShadowOffset2", "AnimateShadowOffset", "ShadowOffsetCurve", layers[i].eff.doffsetf, layers[i].eff.doffsett, layers[i].eff.doffsetanim);
      WriteAnimParam("ShadowDensity1", "ShadowDensity2", "AnimateShadowDensity", "ShadowDensityCurve", layers[i].eff.ddensityf, layers[i].eff.ddensityt, layers[i].eff.ddensityanim);
      WriteAnimParam("ShadowDiffuse1", "ShadowDiffuse2", "AnimateShadowDiffuse", "ShadowDiffuseCurve", layers[i].eff.ddiffusef, layers[i].eff.ddiffuset, layers[i].eff.ddiffuseanim);
      ppw.WriteInt("ShadowType", layers[i].eff.dstype.val);
      ppw.WriteFloat("ShadowGradate", layers[i].eff.dsgrad.val);
      ppw.WriteInt("LightDirIEn", layers[i].eff.ilightdirena.val);
      WriteAnimParam("LightDirI", "LightDirI2", "AnimateLightDirI", "LightDirICurve", layers[i].eff.ilightdirf, layers[i].eff.ilightdirt, layers[i].eff.ilightdiranim);
      WriteAnimParam("IShadowOffset1", "IShadowOffset2", "AnimateIShadowOffset", "IShadowOffsetCurve", layers[i].eff.ioffsetf, layers[i].eff.ioffsett, layers[i].eff.ioffsetanim);
      WriteAnimParam("IShadowDensity1", "IShadowDensity2", "AnimateIShadowDensity", "IShadowDensityCurve", layers[i].eff.idensityf, layers[i].eff.idensityt, layers[i].eff.idensityanim);
      WriteAnimParam("IShadowDiffuse1", "IShadowDiffuse2", "AnimateIShadowDiffuse", "IShadowDiffuseCurve", layers[i].eff.idiffusef, layers[i].eff.idiffuset, layers[i].eff.idiffuseanim);
      ppw.WriteInt("LightDirEEn", layers[i].eff.elightdirena.val);
      WriteAnimParam("LightDirE", "LightDirE2", "AnimateLightDirE", "LightDirECurve", layers[i].eff.elightdirf, layers[i].eff.elightdirt, layers[i].eff.elightdiranim);
      WriteAnimParam("HilightOffset1", "HilightOffset2", "AnimateHilightOffset", "HilightOffsetCurve", layers[i].eff.eoffsetf, layers[i].eff.eoffsett, layers[i].eff.eoffsetanim);
      WriteAnimParam("HilightDensity1", "HilightDensity2", "AnimateHilightDensity", "HilightDensityCurve", layers[i].eff.edensityf, layers[i].eff.edensityt, layers[i].eff.edensityanim);
      if (layers[i].prim.texturedepth.val) {
        var png = ImageToPng(layers[i].prim.tex.img);
        ppw.EmbedFile("TexBmp", B64Dec(png.substr(png.indexOf(",") + 1)));
      }
      if (layers[i].prim.type.val == 1) {
        var png = ImageToPng(layers[i].prim.image);
        ppw.EmbedFile("ImgBmp", B64Dec(png.substr(png.indexOf(",") + 1)));
      }
    }
    var xhr = new XMLHttpRequest();
    if (mode == 0) {
      let fname = document.menu.filename.value;
      if(fname=="")
        fname = "temp.knob";
      console.log("Save : "+fname);
      const blob = new Blob([new Uint8Array(ppw.info)],{"type" : "application/octet-stream"});
      const alink = document.createElement("a");
      alink.download = fname;
      alink.href = URL.createObjectURL(blob);
      alink.dataset.downloadurl = ["text/plain", alink.download, alink.href].join(":");
      alink.click();
    }
/*
    else {
      xhr.open("POST", "./gallery.php", true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          location.href = "./gallery.php";
        }
      }
      name = document.upload.fn.value;
      if (name == "")
        name = "temp.knob";
      if (name.indexOf(".knob") < 0)
        name += ".knob";
      var li = (document.upload.li[1].checked ? 3 : 33)|(document.upload.ccsa.checked?4:0)|(document.upload.ccnd.checked?8:0)|(document.upload.ccnc.checked?16:0);
    var ty=document.upload.ty.options[document.upload.ty.selectedIndex].value;
      data = "m=pu&fn=" + B64Url(name)
      + "&li=" + li
    + "&ty=" +ty
    + "&tag="+ B64Url(document.upload.tags.value)
      + "&au=" + B64Url(document.upload.au.value)
      + "&co=" + B64Url(document.upload.co.value)
      + "&de=" + B64Url(document.upload.de.value)
      + "&d=" + B64Url(ppw.info);
      xhr.send(data);
    }
*/
  }
  function Open() {
    const f=document.createElement("input");
    f.type="file";
    f.value=null;
    f.onchange = (ev)=>{
      OpenFile(ev.target.files[0]);
    };
    f.click();
  }
  function Share() {
    ElemToggle('bar_share');
    document.upload.fn.value = document.menu.filename.value;
  }
  Getxy = function(e) {
    var rc = e.target.getBoundingClientRect();
    mouseX = Math.floor(e.clientX - rc.left);
    mouseY = Math.floor(e.clientY - rc.top);
  }
  function CurveEditor() {
    this.canvas=document.getElementById("canvascurve");
    ctxCurve = this.canvas.getContext("2d");
    this.drag=-1;
    this.cur=0;
    this.lv=Array(6);
    this.tm=Array(6);
    for(var i=0;i<6;++i)
      this.lv[i]=this.tm[i]=-1;
    this.tm[0]=0;
    this.tm[5]=100;
    this.canvas.onmousedown=function(e) {
      Getxy(e);
      var t = curveeditor.HitTest({x:mouseX, y:mouseY});
      if((t|0)!=t) {
        if(curveeditor.tm[4]<0) {
          for(var i=4;i>(t|0);--i) {
            curveeditor.tm[i]=curveeditor.tm[i-1];
            curveeditor.lv[i]=curveeditor.lv[i-1];
          }
          curveeditor.drag=(t|0)+1;
        }
      }
      else
        curveeditor.drag=t|0;
    }
    this.canvas.onmouseup=function() {
      if(curveeditor.drag>=0) {
        for(var i=1;i<4;++i) {
          if(curveeditor.tm[i]<0) {
            var t=curveeditor.tm[i];
            curveeditor.tm[i]=curveeditor.tm[i+1];
            curveeditor.tm[i+1]=t;
            t=curveeditor.lv[i];
            curveeditor.lv[i]=curveeditor.lv[i+1];
            curveeditor.lv[i+1]=t;
          }
        }
        curveeditor.Draw();
      }
      curveeditor.drag=-1;
    }
    this.canvas.onmousemove=function(e) {
      Getxy(e);
      if(curveeditor.drag>=0) {
        var x=((mouseX-50)/3)|0;
        var y=100-((mouseY-50)/3|0);
        if(y<0 || y>100 || x<=0 || x>=100) {
          curveeditor.tm[curveeditor.drag]=-1;
          curveeditor.lv[curveeditor.drag]=-1;
        }
        else {
          curveeditor.lv[curveeditor.drag]=y;
          if(curveeditor.drag!=0 && curveeditor.drag!=5) {
            curveeditor.tm[curveeditor.drag]=x;
            if(curveeditor.tm[curveeditor.drag+1]>=0 && x>curveeditor.tm[curveeditor.drag+1]) {
              curveeditor.tm[curveeditor.drag]=curveeditor.tm[curveeditor.drag+1];
              curveeditor.tm[curveeditor.drag+1]=x;
              var t=curveeditor.lv[curveeditor.drag];
              curveeditor.lv[curveeditor.drag]=curveeditor.lv[curveeditor.drag+1];
              curveeditor.lv[curveeditor.drag+1]=t;
              curveeditor.drag=curveeditor.drag+1;
            }
            if(x<curveeditor.tm[curveeditor.drag-1]) {
              curveeditor.tm[curveeditor.drag]=curveeditor.tm[curveeditor.drag-1];
              curveeditor.tm[curveeditor.drag-1]=x;
              var t=curveeditor.lv[curveeditor.drag];
              curveeditor.lv[curveeditor.drag]=curveeditor.lv[curveeditor.drag-1];
              curveeditor.lv[curveeditor.drag-1]=t;
              curveeditor.drag=curveeditor.drag-1;
            }
          }
        }
        curveeditor.Draw();
      }
    }
    this.Open=function(n) {
      this.cur=n;
      document.getElementById("curveeditorpane").style.display="block";
      this.lv[0]=animcurve[n].lv[0];
      this.tm[1]=animcurve[n].tm[1];
      this.lv[1]=animcurve[n].lv[1];
      this.tm[2]=animcurve[n].tm[2];
      this.lv[2]=animcurve[n].lv[2];
      this.tm[3]=animcurve[n].tm[3];
      this.lv[3]=animcurve[n].lv[3];
      this.tm[4]=animcurve[n].tm[4];
      this.lv[4]=animcurve[n].lv[4];
      this.lv[5]=animcurve[n].tm[5];
      this.Draw();
    }
    this.Apply=function() {
      for(var i=0;i<6;++i) {
        animcurve[this.cur].lv[i]=this.lv[i];
        animcurve[this.cur].tm[i]=this.tm[i];
      }
      EditEff(1);
    }
    this.Close=function() {
      this.Apply();
      document.getElementById("curveeditorpane").style.display="none";
    }
    this.HitTest=function(x,y) {
      x=(x-50)/3;
      y=100-(y-50)/3;
      for(var i=0;i<6;++i) {
        if(Math.abs(this.tm[i]-x)+Math.abs(this.lv[i]-y)<8)
          return i;
      }
      var lx=0;
      var lv=this.lv[0];
      var li=0;
      for(var i=1;i<6;++i) {
        if(this.tm[i]>=0) {
          if(x>lx && x<this.tm[i]) {
            if(Math.abs(lv+(this.lv[i]-lv)*(x-lx)/(this.tm[i]-lx)-y)<8) {
              return li+0.5;
            }
          }
          li=i;
          lx=this.tm[i];
          lv=this.lv[i];
        }
      }
      return -1;
    }
    this.Draw=function() {
      document.curve.L0.value=this.lv[0];
      document.curve.L1.value=this.lv[1];
      document.curve.L2.value=this.lv[2];
      document.curve.L3.value=this.lv[3];
      document.curve.L4.value=this.lv[4];
      document.curve.L5.value=this.lv[5];
      document.curve.T1.value=this.tm[1];
      document.curve.T2.value=this.tm[2];
      document.curve.T3.value=this.tm[3];
      document.curve.T4.value=this.tm[4];
      ctxCurve.fillStyle="#c0c0c0";
      ctxCurve.fillRect(0,0,400,400);
      ctxCurve.fillStyle="#ffffff";
      ctxCurve.fillRect(50,50,300,300);
      ctxCurve.fillStyle="#000000";
      for(var i=0;i<6;++i) {
        if(this.tm[i]>=0)
          ctxCurve.fillRect(50+this.tm[i]*3-3,350-this.lv[i]*3-3,6,6);
      }
      ctxCurve.beginPath();
      ctxCurve.moveTo(50,350-this.lv[0]*3);
      for(var i=1;i<6;++i) {
        if(this.tm[i]>=0)
          ctxCurve.lineTo(50+this.tm[i]*3,350-this.lv[i]*3);
      }
      ctxCurve.stroke();
    }
  }
  function ShapeEditor() {
    this.zoom = 1;
    this.curline = 0;
    this.curvtx = 2;
    this.drag = 0;
    this.vtx = new Array();
    this.canvas= document.getElementById("canvasshape");
    this.canvas.setAttribute("width",512);
    this.canvas.setAttribute("height",512);
    this.grid = 16;
    this.SetZoom = function(x){
//            console.log(this.canvas.parentNode.scrollTop);
//            console.log(this.canvas.style.clientX);
      switch(x){
      case 0:
        this.zoom = 1;
        this.canvas.style.width = (this.zoom * 512)+"px";
        this.canvas.style.height = (this.zoom * 512)+"px";
        this.canvas.parentNode.scrollTop = 0;
        this.canvas.parentNode.scrollLeft = 0;
        break;
      case -1:
        if(this.zoom > 1){
          const z = this.zoom;
          this.zoom = this.zoom / 1.5;
          if(this.zoom < 1)
            this.zoom = 1;
          this.canvas.style.width = (this.zoom * 512)+"px";
          this.canvas.style.height = (this.zoom * 512)+"px";
          this.canvas.parentNode.scrollTop += (this.zoom -z) * 256;
          this.canvas.parentNode.scrollLeft += (this.zoom -z) * 256;
        }
        break;
      case 1:
        if(this.zoom < 8){
          const z = this.zoom;
          this.zoom *= 1.5;
          this.canvas.style.width = (this.zoom * 512)+"px";
          this.canvas.style.height = (this.zoom * 512)+"px";
          this.canvas.parentNode.scrollTop += (this.zoom - z) * 256;
          this.canvas.parentNode.scrollLeft += (this.zoom -z) * 256;
        }
        break;
      }
      this.Draw(0);
    }
    this.AdjustGrid = function(p){
      if(this.grid==0)
        return p;
      return {x:((p.x / this.grid + 0.5) | 0) * this.grid, y:((p.y / this.grid + 0.5) | 0) * this.grid};
    }
    this.scr2log = function(p){
      return {x:p.x / this.zoom, y:p.y / this.zoom};
    }
    this.canvas.onmouseup = function(e) {
      shapeeditor.drag = 0;
    }
    this.canvas.onmousemove = function(e) {
      Getxy(e);
      if (shapeeditor.drag) {
        const p = shapeeditor.AdjustGrid(shapeeditor.scr2log({x:mouseX, y:mouseY}));
        var dx = p.x - shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx];
        var dy = p.y - shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 1];
        shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx] = p.x;
        shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 1] = p.y;
        if (shapeeditor.curvtx % 6 == 2) {
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx - 2] += dx;
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx - 1] += dy;
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 2] += dx;
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 3] += dy;
        }
        else if (shapeeditor.curvtx % 6 == 0) {
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 4] = shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 2] * 2 - p.x;
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 5] = shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx + 3] * 2 - p.y;
        }
        else {
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx - 4] = shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx - 2] * 2 - p.x;
          shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx - 3] = shapeeditor.vtx[shapeeditor.curline][shapeeditor.curvtx - 1] * 2 - p.y;
        }
        shapeeditor.Draw(0);
      }
      else{
        if(shapeeditor.HitTest(shapeeditor.scr2log({x:mouseX, y:mouseY}))>=0)
          shapeeditor.canvas.style.cursor="pointer";
        else
          shapeeditor.canvas.style.cursor="default";
      }
    }
    this.canvas.onmousedown = function(e) {
      Getxy(e);
      var h = shapeeditor.HitTest(shapeeditor.scr2log({x:mouseX, y:mouseY}));
      if (h >= 0) {
        l = h >> 8;
        v = h & 0xff;
        if ((v % 6) == 2 || (l == shapeeditor.curline && ((v / 6)|0) == ((shapeeditor.curvtx / 6)|0))) {
          shapeeditor.curline = l;
          shapeeditor.curvtx = v;
          shapeeditor.drag = 1;
          shapeeditor.Draw(0);
        }
      }
      else {
        shapeeditor.AddPoint(shapeeditor.AdjustGrid(shapeeditor.scr2log({x:mouseX, y:mouseY})));
      }
    }
    this.HitTest = function(p) {
      var r = -1;
      for (var i = 0; i < this.vtx.length; ++i) {
        for (var j = 0; j < this.vtx[i].length; j += 2) {
          if (Math.abs(p.x - this.vtx[i][j]) + Math.abs(p.y - this.vtx[i][j + 1]) < 5) {
            r = (i << 8) + j;
            if (shiftkey==0 && (j % 6 == 2))
              return r;
          }
        }
      }
      return r;
    }
    this.Open = function() {
      document.getElementById("shapeeditorpane").style.display = "block";
      this.Draw(1);
    }
    this.Close=function() {
      document.getElementById("shapestr").value=this.GetStr();
      document.getElementById("shapeeditorpane").style.display = "none";
      EditPrim(1);
    }
    this.SetGrid=function(x){
      this.grid = x;
      this.Draw();
    }
    this.DelPoint=function() {
      this.vtx[this.curline].splice((this.curvtx/6|0)*6,6);
      this.Draw(0);
    }
    this.AddPoint=function(p) {
      var i=(this.curvtx/6|0)*6;
      if(document.getElementById("newpath").checked==true) {
        if(this.vtx[this.curline].length>0){
          this.curline++;
          this.curvtx=2;
        }
      }
      if(!this.vtx[this.curline])
        this.vtx[this.curline]=[p.x, p.y, p.x, p.y, p.x, p.y];
      else {
        this.vtx[this.curline].splice(i+6, 0, p.x, p.y, p.x, p.y, p.x, p.y);
        this.curvtx=(i+1)*6+2;
      }
      document.getElementById("newpath").checked=false;
      this.Draw(0);
    }
    this.DupPoint=function() {
      var i=(this.curvtx/6|0)*6;
      c=this.vtx[this.curline].slice(i,i+6);
      if(document.getElementById("newpath").checked==true) {
        this.vtx.splice(this.curline,0,c);
        this.curline++;
        this.curvtx=2;
      }
      else {
        this.vtx[this.curline].splice(i,0,c[0],c[1],c[2],c[3],c[4],c[5]);
        this.curvtx=(i+1)*6+2;
      }
      document.getElementById("newpath").checked=false;
      this.Draw(0);
    }
    this.GetVertex = function(str) {
      var vtx = new Array();
      var pstr = str.split("/");
      pstr.shift();
      for (var i = 0; i < pstr.length; ++i) {
        vtx[i] = new Array();
        var ppstr = pstr[i].split(":");
        for (var j = 0; j < ppstr.length; ++j) {
          var pppstr = ppstr[j].split(",");
          for (var k = 0; k < 6; ++k)
            vtx[i].push(parseInt(pppstr[k], 10));
        }
      }
      return vtx;
    }
    this.GetStr = function() {
      var str="";
      for (var i = 0; i < this.vtx.length; ++i) {
        for (var j = 0; j + 5 < this.vtx[i].length; j += 6) {
          if(j==0)
            str+="/";
          else
            str+=":";
          str+=this.vtx[i][j]+","+this.vtx[i][j+1]+","+this.vtx[i][j+2]+","+this.vtx[i][j+3]+","+this.vtx[i][j+4]+","+this.vtx[i][j+5];
        }
      }
      return str;
    }
    this.MakePath = function(ctx, str, f, scale, i) {
      function scalex(x) {
        return (x - 128) / 256 * prefs.width;
      }
      function scaley(y) {
        return (y - 128) / 256 * prefs.height;
      }
      if (str != "")
        this.vtx = this.GetVertex(str);
      ctx.beginPath();
      if (scale) {
        if(!this.vtx)
          return 0;
        if(i==-1) {
          for (i = 0; i < this.vtx.length; ++i) {
            for (var j = 0; j + 5 < this.vtx[i].length; j += 6) {
              if (j == 0)
                ctx.moveTo(scalex(this.vtx[i][j + 2]), scaley(this.vtx[i][j + 3]));
              else
                ctx.bezierCurveTo(scalex(this.vtx[i][j - 2]), scaley(this.vtx[i][j - 1]), scalex(this.vtx[i][j]), scaley(this.vtx[i][j + 1]), scalex(this.vtx[i][j + 2]), scaley(this.vtx[i][j + 3]));
            }
            if (f)
              ctx.bezierCurveTo(scalex(this.vtx[i][j - 2]), scaley(this.vtx[i][j - 1]), scalex(this.vtx[i][0]), scaley(this.vtx[i][1]), scalex(this.vtx[i][2]), scaley(this.vtx[i][3]));
          }
          return 0;
        }
        else {
          if(!this.vtx[i])
            return 0;
          for (var j = 0; j + 5 < this.vtx[i].length; j += 6) {
            if (j == 0)
              ctx.moveTo(scalex(this.vtx[i][j + 2]), scaley(this.vtx[i][j + 3]));
            else
              ctx.bezierCurveTo(scalex(this.vtx[i][j - 2]), scaley(this.vtx[i][j - 1]), scalex(this.vtx[i][j]), scaley(this.vtx[i][j + 1]), scalex(this.vtx[i][j + 2]), scaley(this.vtx[i][j + 3]));
          }
          if (f)
            ctx.bezierCurveTo(scalex(this.vtx[i][j - 2]), scaley(this.vtx[i][j - 1]), scalex(this.vtx[i][0]), scaley(this.vtx[i][1]), scalex(this.vtx[i][2]), scaley(this.vtx[i][3]));
          if(i+1<this.vtx.length)
            return i+1;
          return 0;
        }
      }
      else {
        if(i==-1) {
          for (i = 0; i < this.vtx.length; ++i) {
            for (var j = 0; j + 5 < this.vtx[i].length; j += 6) {
              if (j == 0)
                ctx.moveTo(this.vtx[i][j + 2], this.vtx[i][j + 3]);
              else
                ctx.bezierCurveTo(this.vtx[i][j - 2], this.vtx[i][j - 1], this.vtx[i][j], this.vtx[i][j + 1], this.vtx[i][j + 2], this.vtx[i][j + 3]);
            }
            if (f)
              ctx.bezierCurveTo(this.vtx[i][j - 2], this.vtx[i][j - 1], this.vtx[i][0], this.vtx[i][1], this.vtx[i][2], this.vtx[i][3]);
          }
          return 0;
        }
        else {
          for (var j = 0; j + 5 < this.vtx[i].length; j += 6) {
            if (j == 0)
              ctx.moveTo(this.vtx[i][j + 2], this.vtx[i][j + 3]);
            else
              ctx.bezierCurveTo(this.vtx[i][j - 2], this.vtx[i][j - 1], this.vtx[i][j], this.vtx[i][j + 1], this.vtx[i][j + 2], this.vtx[i][j + 3]);
          }
          if (f)
            ctx.bezierCurveTo(this.vtx[i][j - 2], this.vtx[i][j - 1], this.vtx[i][0], this.vtx[i][1], this.vtx[i][2], this.vtx[i][3]);
          if(i+1<this.vtx.length)
            return i+1;
          return 0;
        }
      }
    }
    this.DrawHandle = function(vtx,i, j, t,c) {
      if (t == 0) {
        ctxShape.fillStyle = c;
        ctxShape.fillRect(vtx[i][j] - 4, vtx[i][j + 1] - 4, 8, 8);
        ctxShape.fillStyle = "#ffffff";
        ctxShape.fillRect(vtx[i][j] - 2, vtx[i][j + 1] - 2, 4, 4);
      }
      else {
        ctxShape.fillStyle = c;
        ctxShape.beginPath();
        ctxShape.arc(vtx[i][j], vtx[i][j + 1], 4, 0, Math.PI * 2, true);
        ctxShape.fill();
        ctxShape.beginPath();
        ctxShape.fillStyle = "#ffffff";
        ctxShape.arc(vtx[i][j], vtx[i][j + 1], 2, 0, Math.PI * 2, true);
        ctxShape.fill();
      }
    }
    this.Draw = function(fromstr) {
      ctxShape = this.canvas.getContext("2d");
      ctxShape.fillStyle = "#f0f0f0";
      ctxShape.fillRect(0, 0, 512, 512);
      ctxShape.fillStyle = "#ffffff"; 
      ctxShape.strokeStyle = "#000000";
      ctxShape.lineWidth = 1;
      ctxShape.fillRect(128, 128, 256, 256);
      ctxShape.strokeRect(128, 128, 256, 256);
      ctxShape.beginPath();
      ctxShape.arc(256, 256, 128, 0, 2 * Math.PI, true);
      ctxShape.stroke();
      if (fromstr)
        this.MakePath(ctxShape, layers[curLayer].prim.shape.val, layers[curLayer].prim.fill.val, 0,-1);
      else
        this.MakePath(ctxShape, "", layers[curLayer].prim.fill.val, 0,-1);
      if (layers[curLayer].prim.fill.val) {
        ctxShape.fillStyle = "#ffc0c0";
        ctxShape.fill("evenodd");
      }
      ctxShape.strokeStyle = "#000080";
      ctxShape.lineWidth = 1;
      ctxShape.stroke();
      for (var i = 0; i < this.vtx.length; ++i) {
        for (var j = 2; j < this.vtx[i].length; j += 6) {
          if (i == this.curline && ((j / 6) | 0) == ((this.curvtx / 6) | 0)) {
            ctxShape.strokeStyle = "#ff0000";
            ctxShape.lineWidth = 2;
            ctxShape.beginPath();
            ctxShape.moveTo(this.vtx[i][j - 2], this.vtx[i][j - 1]);
            ctxShape.lineTo(this.vtx[i][j], this.vtx[i][j + 1]);
            ctxShape.lineTo(this.vtx[i][j + 2], this.vtx[i][j + 3]);
            ctxShape.stroke();
            this.DrawHandle(this.vtx, i, j - 2, 1, "#ff0000");
            this.DrawHandle(this.vtx, i, j + 2, 1, "#ff0000");
            if (j == 2)
              this.DrawHandle(this.vtx, i, j, 0, "#ff0000");
            else
              this.DrawHandle(this.vtx, i, j, 1, "#ff0000");
          }
          else {
            if (j == 2)
              this.DrawHandle(this.vtx, i, j, 0, "#000080");
            else
              this.DrawHandle(this.vtx, i, j, 1, "#000080");
          }
        }
      }
      ctxShape.fillStyle = "#000000";
      if(this.grid >=4){
        for (var x = 0; x < 512; x += this.grid) {
          for (var y = 0; y < 512; y += this.grid) {
            ctxShape.fillRect(x, y, 1, 1);
          }
        }
      }
    }
  }
</script>

</head>
<body onload="Init()">
<div id="container">
<div id="header" style="display:flex">
  <div id="logo"><a href="https://www.g200kg.com/" target="_blank"><img src="https://www.g200kg.com/image/logo/g200kg160x80.png"/></a><img style="width:70px;margin-left:20px" src="img/JKnobMan.png"/>
  </div>
  <div id="titlediv">
  <h1 id="title"></h1>
  <div>WebApp version of the KnobMan, Animation knob designer.</div>
  </div>
  <div style="clear:both"></div>
</div>
<div id="ad"><script type="text/javascript">
google_ad_client = "pub-5618328583582553";
/* 728x90,  11/08/21 */
google_ad_slot = "6176235247";
google_ad_width = 728;
google_ad_height = 90;
</script>
<script type="text/javascript"
src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="gallerybuttons">
  <div><a href="./gallery.php"><img src="./img/knobgallery.png"/></a></div>
  <!--<div id="knobup"><input type="image" src="./img/knobup.png" onclick="Share()"/></div>-->
</div>
<div style="clear:both" ></div>
<div id="bar_share" style="background:#223344;margin:3px;padding:3px;display:none">
  <form name="upload">
    <div style="margin-bottom:10px">
    <table style="border:1px solid #404080;background:#f0f0e0">
    <tr><td colspan="2" style="background:#c0c0ff"><b>Knob File Upload to KnobGallery</b></td></tr>
    <tr><td>Filename : </td><td><input type="text" name="fn"/></td></tr>
    <tr><td>Author : </td><td><input type="text" name="au" size="30"/></td></tr>
    <tr><td>Comment : </td><td><input type="text" name="co" size="60"/></td></tr>
    <tr><td>Type : </td><td><select name="ty"><option value="" selected></option><option value="knob">Knob</option><option value="slider">Slider</option><option value="switch">Switch</option><option vlaue="meter">Meter</option><option value="other">Other</option></select></td></tr>
    <tr><td>Tags (Comma separated words): </td><td><input type="text" name="tags" size=40/></td></tr>
    <tr><td>License : </td><td>
    <div style="float:left;margin-right:10px"><div style="float:left"><input type="radio" name="li" value="33" onclick="SetLi(0)" checked/></div><div style="float:left;font-size:x-small"><img src="img/CC0.png"/><br/><a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CC0 : Public Domain</a></div></div>
    <div style="float:left"><div style="float:left"><input type="radio" name="li" value="3" onclick="SetLi(1)"/></div><div style="float:left;font-size:x-small"><img id="ccmark" src="img/CC-BY-4.0.png"/><br/><a rel="license" href="https://creativecommons.org/licenses/" target="_blank">Creative Commons</a></div></div>
    <div style="float:left;font-size:small">
    <div><input name="ccsa" type="checkbox" value=1 onclick="SetCC(1)" disabled/>Share Alike</div>
    <div><input name="ccnd" type="checkbox" value=1 onclick="SetCC(2)" disabled/>No Derivs</div>
    <div><input name="ccnc" type="checkbox" value=1 onclick="SetCC(4)" disabled/>Non Commercial</div>
    </div>
    </td></tr>
    <tr><td>Del Pass: </td><td><input type="text" name="de" size="8"/> (required when delete)<input type="hidden" name="m" value="up"/></td></tr>
    </table>
    </div>
  </form>
<button onclick="Save(1)">Upload</button>
</div>
<hr/>
<div id="editor">
<form name="menu" action="javascript:Dummy()">
Filename: <input disabled name="filename" type="text" size="30" />
<div  id="menupane" style="background:#000033;margin:3px;padding:3px">
<span style="display:inline-block;width:40px;text-align:right"> File:</span>
<button style="width:60px;height:24px" title="New File" onclick="New()">New</button>
<button style="width:60px;height:24px" title="Open File" onclick="Open()">Open</button>
<button style="width:120px;height:24px" title="Save As .knob" onclick="Save(0)">SaveAs .knob</button>
<button style="width:120px;height:24px" title="Export As PNG" onclick="Export()">ExportTo .png</button>
<span style="display:inline-block;width:60px;text-align:right"> Layer:</span>
<button style="float:none;width:60px;height:24px" title="Add Layer" onclick="AddLayer()">Add</button>
<button style="width:60px;height:24px" title="Duplicate Layer" onclick="DupLayer()">Dup</button>
<button style="width:60px;height:24px" title="Delete Layer" onclick="DelLayer()">Del</button>
<button style="width:60px;height:24px" title="Move Layer to Background" onclick="MoveBack()">Back</button>
<button style="width:60px;height:24px" title="Move Layer to Foreground" onclick="MoveFore()">Fore</button>
<button style="width:60px;height:24px" title="Rename" onclick="RenameLayer()">Renam</button>
<br/><span style="width:60px;text-align:right"> AnimCurve:</span>
<button style="width:35px;height:24px" title="Curve1" onclick="curveeditor.Open(0)">1&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve2" onclick="curveeditor.Open(1)">2&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve3" onclick="curveeditor.Open(2)">3&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve4" onclick="curveeditor.Open(3)">4&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve5" onclick="curveeditor.Open(4)">5&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve6" onclick="curveeditor.Open(5)">6&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve7" onclick="curveeditor.Open(6)">7&#x25b6;</button>
<button style="width:35px;height:24px" title="Curve8" onclick="curveeditor.Open(7)">8&#x25b6;</button>
</div>

<div style="background:#c0c0c0;margin:3px;padding:3px;display:none" id="bar_open_fileapi">
  Local .knob File:<input type="file" id="openfilename" name="openfilename" onchange="OpenFile()"/>
</div>
</form>

<div style="background:#c0c0c0;margin:3px;padding:3px;display:none" id="bar_open_post">
  <form action="./tmpup.php" method="POST" enctype="multipart/form-data">
  <input type="hidden" name="m" value="r" />
  <input type="hidden" name="n" value="temp" />
  Local .knob File:<input type="file" name="d"/><input type="submit" value=" Go "/>
  </form>
</div>

<div id="curveeditorpane" style="border:1px solid #000000;width:950px;height:540px;display:none">
  <canvas id="canvascurve" width="400" height="400" style="border:1px solid"></canvas>
  <br/>
  <div><form name="curve">
  <table>
  <tr><td></td><td></td><td>T1</td><td><input type="text" name="T1" size="10"/></td>
  <td>T2</td><td><input type="text" name="T2" size="10"/></td>
  <td>T3</td><td><input type="text" name="T3" size="10"/></td>
  <td>T4</td><td><input type="text" name="T4" size="10"/></td>
  </tr>
  <tr><td>L0</td><td><input type="text" name="L0" size="10"/></td>
  <td>L1</td><td><input type="text" name="L1" size="10"/></td>
  <td>L2</td><td><input type="text" name="L2" size="10"/></td>
  <td>L3</td><td><input type="text" name="L3" size="10"/></td>
  <td>L4</td><td><input type="text" name="L4" size="10"/></td>
  <td>L5</td><td><input type="text" name="L5" size="10"/></td>
  </tr>
  </table><br/>
  <div id="stepreso"><div style="float:left;width:100px">StepReso:</div><div style="float:left"><input type="text" name="stepreso" value="0" size="10" onchange="curveeditor.EditStepReso()" /><button class="spin" onmousedown="EditValue(document.curve.stepreso,1)"><img src="img/spin.png"/></button></div><br /></div>
  </form>
  </div>
  <button onclick="curveeditor.Apply()">Apply</button> <button onclick="curveeditor.Close()">Close</button>
</div>
<div id="shapeeditorpane" style="border:1px solid #000000;width:950px;height:540px;display:none">
  <div style="float:left;width:512px;height:512px;overflow:scroll">
    <canvas id="canvasshape" width="512" height="512"></canvas>
  </div>
  <div style="float:left;margin-left:5px">
  Zoom : <button onclick="shapeeditor.SetZoom(-1)" style="width:50px"> - </button> <button onclick="shapeeditor.SetZoom(0)" style="width:50px">1 : 1</button> <button onclick="shapeeditor.SetZoom(1)" style="width:50px"> +</button><br/>
  Grid : <select id="grid" onchange="shapeeditor.SetGrid([0,2,4,8,16][this.selectedIndex])"><option>None</option><option>2</option><option>4</option><option>8</option><option selected>16</option></select><br/>
  <input id="newpath" type="checkbox"/>New Path<br/>
  <button onclick="shapeeditor.DupPoint()" style="width:120px">Dup Point</button><br/>
  <button onclick="shapeeditor.DelPoint()" style="width:120px">Del Point</button><br/>
  <input id="shapefill" type="checkbox" name="fill"  onchange="EditPrim(1)"/>Fill<br/>
  <p>Shift + Drag to grab control handle.</p>
  <button onclick="shapeeditor.Close()" style="width:120px">Close</button>
  </div>
</div>
<div style="clear:both"></div>
<div id="popupmask" style="width:965px; height:700px; background-color:#808080; opacity:0.8; position:absolute;display:none;z-index:2;top:0;left:0">
  <br/><br/><div id="popupmsg" style="text-align:center; margin:0 auto; width:300px;color:#800000;background-color:#ffffff;opacity:1.0">Rendering...</div>
</div>
<div id="layerpane" style="float:left;width:130px;height:600px;overflow:auto;border:1px solid;margin:5px;padding:5px;display:none">
<div id="layer0" style="padding-left:25px" onclick="SelLayer(-1)">Preference</div>
<div id="layer1" onclick="SelLayer(0)"><input type="checkbox" id="lv1" onchange="SetVisible(0)" checked/><img id="icon1" src="./img/none.png" /> <span id="name1">Layer1</span></div>
<div id="layer2" onclick="SelLayer(1)"><input type="checkbox" id="lv2" onchange="SetVisible(1)" checked/><img id="icon2" src="./img/none.png" /> <span id="name2">Layer2</span></div>
<div id="layer3" onclick="SelLayer(2)"><input type="checkbox" id="lv3" onchange="SetVisible(2)" checked/><img id="icon3" src="./img/none.png" /> <span id="name3">Layer3</span></div>
<div id="layer4" onclick="SelLayer(3)"><input type="checkbox" id="lv4" onchange="SetVisible(3)" checked/><img id="icon4" src="./img/none.png" /> <span id="name4">Layer4</span></div>
<div id="layer5" onclick="SelLayer(4)"><input type="checkbox" id="lv5" onchange="SetVisible(4)" checked/><img id="icon5" src="./img/none.png" /> <span id="name5">Layer5</span></div>
<div id="layer6" onclick="SelLayer(5)"><input type="checkbox" id="lv6" onchange="SetVisible(5)" checked/><img id="icon6" src="./img/none.png" /> <span id="name6">Layer6</span></div>
<div id="layer7" onclick="SelLayer(6)"><input type="checkbox" id="lv7" onchange="SetVisible(6)" checked/><img id="icon7" src="./img/none.png" /> <span id="name7">Layer7</span></div>
<div id="layer8" onclick="SelLayer(7)"><input type="checkbox" id="lv8" onchange="SetVisible(7)" checked/><img id="icon8" src="./img/none.png" /> <span id="name8">Layer8</span></div>
<div id="layer9" onclick="SelLayer(8)"><input type="checkbox" id="lv9" onchange="SetVisible(8)" checked/><img id="icon9" src="./img/none.png" /> <span id="name9">Layer9</span></div>
<div id="layer10" onclick="SelLayer(9)"><input type="checkbox" id="lv10" onchange="SetVisible(9)" checked/><img id="icon10" src="./img/none.png" /> <span id="name10">Layer10</span></div>
<div id="layer11" onclick="SelLayer(10)"><input type="checkbox" id="lv11" onchange="SetVisible(10)" checked/><img id="icon11" src="./img/none.png" /> <span id="name11">Layer11</span></div>
<div id="layer12" onclick="SelLayer(11)"><input type="checkbox" id="lv12" onchange="SetVisible(11)" checked/><img id="icon12" src="./img/none.png" /> <span id="name12">Layer12</span></div>
<div id="layer13" onclick="SelLayer(12)"><input type="checkbox" id="lv13" onchange="SetVisible(12)" checked/><img id="icon13" src="./img/none.png" /> <span id="name13">Layer13</span></div>
<div id="layer14" onclick="SelLayer(13)"><input type="checkbox" id="lv14" onchange="SetVisible(13)" checked/><img id="icon14" src="./img/none.png" /> <span id="name14">Layer14</span></div>
<div id="layer15" onclick="SelLayer(14)"><input type="checkbox" id="lv15" onchange="SetVisible(14)" checked/><img id="icon15" src="./img/none.png" /> <span id="name15">Layer15</span></div>
<div id="layer16" onclick="SelLayer(15)"><input type="checkbox" id="lv16" onchange="SetVisible(15)" checked/><img id="icon16" src="./img/none.png" /> <span id="name16">Layer16</span></div>
<div id="layer17" onclick="SelLayer(16)"><input type="checkbox" id="lv17" onchange="SetVisible(16)" checked/><img id="icon17" src="./img/none.png" /> <span id="name17">Layer17</span></div>
<div id="layer18" onclick="SelLayer(17)"><input type="checkbox" id="lv18" onchange="SetVisible(17)" checked/><img id="icon18" src="./img/none.png" /> <span id="name18">Layer18</span></div>
<div id="layer19" onclick="SelLayer(18)"><input type="checkbox" id="lv19" onchange="SetVisible(18)" checked/><img id="icon19" src="./img/none.png" /> <span id="name19">Layer19</span></div>
<div id="layer20" onclick="SelLayer(19)"><input type="checkbox" id="lv20" onchange="SetVisible(19)" checked/><img id="icon20" src="./img/none.png" /> <span id="name20">Layer20</span></div>
<div id="layer21" onclick="SelLayer(20)"><input type="checkbox" id="lv21" onchange="SetVisible(20)" checked/><img id="icon21" src="./img/none.png" /> <span id="name21">Layer21</span></div>
<div id="layer22" onclick="SelLayer(21)"><input type="checkbox" id="lv22" onchange="SetVisible(21)" checked/><img id="icon22" src="./img/none.png" /> <span id="name22">Layer22</span></div>
<div id="layer23" onclick="SelLayer(22)"><input type="checkbox" id="lv23" onchange="SetVisible(22)" checked/><img id="icon23" src="./img/none.png" /> <span id="name23">Layer23</span></div>
<div id="layer24" onclick="SelLayer(23)"><input type="checkbox" id="lv24" onchange="SetVisible(23)" checked/><img id="icon24" src="./img/none.png" /> <span id="name24">Layer24</span></div>
<div id="layer25" onclick="SelLayer(24)"><input type="checkbox" id="lv25" onchange="SetVisible(24)" checked/><img id="icon25" src="./img/none.png" /> <span id="name25">Layer25</span></div>
<div id="layer26" onclick="SelLayer(25)"><input type="checkbox" id="lv26" onchange="SetVisible(25)" checked/><img id="icon26" src="./img/none.png" /> <span id="name26">Layer26</span></div>
<div id="layer27" onclick="SelLayer(26)"><input type="checkbox" id="lv27" onchange="SetVisible(26)" checked/><img id="icon27" src="./img/none.png" /> <span id="name27">Layer27</span></div>
<div id="layer28" onclick="SelLayer(27)"><input type="checkbox" id="lv28" onchange="SetVisible(27)" checked/><img id="icon28" src="./img/none.png" /> <span id="name28">Layer28</span></div>
<div id="layer29" onclick="SelLayer(28)"><input type="checkbox" id="lv29" onchange="SetVisible(28)" checked/><img id="icon29" src="./img/none.png" /> <span id="name29">Layer29</span></div>
<div id="layer30" onclick="SelLayer(29)"><input type="checkbox" id="lv30" onchange="SetVisible(29)" checked/><img id="icon30" src="./img/none.png" /> <span id="name30">Layer30</span></div>
<div id="layer31" onclick="SelLayer(30)"><input type="checkbox" id="lv31" onchange="SetVisible(30)" checked/><img id="icon31" src="./img/none.png" /> <span id="name31">Layer31</span></div>
<div id="layer32" onclick="SelLayer(31)"><input type="checkbox" id="lv32" onchange="SetVisible(31)" checked/><img id="icon32" src="./img/none.png" /> <span id="name32">Layer32</span></div>
<div id="layer33" onclick="SelLayer(32)"><input type="checkbox" id="lv33" onchange="SetVisible(32)" checked/><img id="icon33" src="./img/none.png" /> <span id="name33">Layer33</span></div>
<div id="layer34" onclick="SelLayer(33)"><input type="checkbox" id="lv34" onchange="SetVisible(33)" checked/><img id="icon34" src="./img/none.png" /> <span id="name34">Layer34</span></div>
<div id="layer35" onclick="SelLayer(34)"><input type="checkbox" id="lv35" onchange="SetVisible(34)" checked/><img id="icon35" src="./img/none.png" /> <span id="name35">Layer35</span></div>
<div id="layer36" onclick="SelLayer(35)"><input type="checkbox" id="lv36" onchange="SetVisible(35)" checked/><img id="icon36" src="./img/none.png" /> <span id="name36">Layer36</span></div>
<div id="layer37" onclick="SelLayer(36)"><input type="checkbox" id="lv37" onchange="SetVisible(36)" checked/><img id="icon37" src="./img/none.png" /> <span id="name37">Layer37</span></div>
<div id="layer38" onclick="SelLayer(37)"><input type="checkbox" id="lv38" onchange="SetVisible(37)" checked/><img id="icon38" src="./img/none.png" /> <span id="name38">Layer38</span></div>
<div id="layer39" onclick="SelLayer(38)"><input type="checkbox" id="lv39" onchange="SetVisible(38)" checked/><img id="icon39" src="./img/none.png" /> <span id="name39">Layer39</span></div>
<div id="layer40" onclick="SelLayer(39)"><input type="checkbox" id="lv40" onchange="SetVisible(39)" checked/><img id="icon40" src="./img/none.png" /> <span id="name40">Layer40</span></div>
<div id="layer41" onclick="SelLayer(40)"><input type="checkbox" id="lv41" onchange="SetVisible(40)" checked/><img id="icon41" src="./img/none.png" /> <span id="name41">Layer41</span></div>
<div id="layer42" onclick="SelLayer(41)"><input type="checkbox" id="lv42" onchange="SetVisible(41)" checked/><img id="icon42" src="./img/none.png" /> <span id="name42">Layer42</span></div>
<div id="layer43" onclick="SelLayer(42)"><input type="checkbox" id="lv43" onchange="SetVisible(42)" checked/><img id="icon43" src="./img/none.png" /> <span id="name43">Layer43</span></div>
<div id="layer44" onclick="SelLayer(43)"><input type="checkbox" id="lv44" onchange="SetVisible(43)" checked/><img id="icon44" src="./img/none.png" /> <span id="name44">Layer44</span></div>
<div id="layer45" onclick="SelLayer(44)"><input type="checkbox" id="lv45" onchange="SetVisible(44)" checked/><img id="icon45" src="./img/none.png" /> <span id="name45">Layer45</span></div>
<div id="layer46" onclick="SelLayer(45)"><input type="checkbox" id="lv46" onchange="SetVisible(45)" checked/><img id="icon46" src="./img/none.png" /> <span id="name46">Layer46</span></div>
<div id="layer47" onclick="SelLayer(46)"><input type="checkbox" id="lv47" onchange="SetVisible(46)" checked/><img id="icon47" src="./img/none.png" /> <span id="name47">Layer47</span></div>
<div id="layer48" onclick="SelLayer(47)"><input type="checkbox" id="lv48" onchange="SetVisible(47)" checked/><img id="icon48" src="./img/none.png" /> <span id="name48">Layer48</span></div>
<div id="layer49" onclick="SelLayer(48)"><input type="checkbox" id="lv49" onchange="SetVisible(48)" checked/><img id="icon49" src="./img/none.png" /> <span id="name49">Layer49</span></div>
<div id="layer50" onclick="SelLayer(49)"><input type="checkbox" id="lv50" onchange="SetVisible(49)" checked/><img id="icon50" src="./img/none.png" /> <span id="name50">Layer50</span></div>
<div id="layer51" onclick="SelLayer(50)"><input type="checkbox" id="lv51" onchange="SetVisible(50)" checked/><img id="icon51" src="./img/none.png" /> <span id="name51">Layer51</span></div>
<div id="layer52" onclick="SelLayer(51)"><input type="checkbox" id="lv52" onchange="SetVisible(51)" checked/><img id="icon52" src="./img/none.png" /> <span id="name52">Layer52</span></div>
<div id="layer53" onclick="SelLayer(52)"><input type="checkbox" id="lv53" onchange="SetVisible(52)" checked/><img id="icon53" src="./img/none.png" /> <span id="name53">Layer53</span></div>
<div id="layer54" onclick="SelLayer(53)"><input type="checkbox" id="lv54" onchange="SetVisible(53)" checked/><img id="icon54" src="./img/none.png" /> <span id="name54">Layer54</span></div>
<div id="layer55" onclick="SelLayer(54)"><input type="checkbox" id="lv55" onchange="SetVisible(54)" checked/><img id="icon55" src="./img/none.png" /> <span id="name55">Layer55</span></div>
<div id="layer56" onclick="SelLayer(55)"><input type="checkbox" id="lv56" onchange="SetVisible(55)" checked/><img id="icon56" src="./img/none.png" /> <span id="name56">Layer56</span></div>
<div id="layer57" onclick="SelLayer(56)"><input type="checkbox" id="lv57" onchange="SetVisible(56)" checked/><img id="icon57" src="./img/none.png" /> <span id="name57">Layer57</span></div>
<div id="layer58" onclick="SelLayer(57)"><input type="checkbox" id="lv58" onchange="SetVisible(57)" checked/><img id="icon58" src="./img/none.png" /> <span id="name58">Layer58</span></div>
<div id="layer59" onclick="SelLayer(58)"><input type="checkbox" id="lv59" onchange="SetVisible(58)" checked/><img id="icon59" src="./img/none.png" /> <span id="name59">Layer59</span></div>
<div id="layer60" onclick="SelLayer(59)"><input type="checkbox" id="lv60" onchange="SetVisible(59)" checked/><img id="icon60" src="./img/none.png" /> <span id="name60">Layer60</span></div>
</div>
<div id="preference" style="float:left;width:562px;height:560px;border:1px solid;margin:5px;padding:25px;display:none;">
<form name="prefs" action="javascript:EditPrefs(2)">
<div><div style="float:left;width:120px">Width:</div><input type="text" name="paramwidth" value="32" size="10" onchange="EditPrefs(1)" /><button class="spin" onmousedown="EditValue(document.prefs.paramwidth,0)"><img src="img/spin.png"/></button></div>
<div style="clear:both;margin-left:120px"><input type="checkbox" id="imgxylink" value="imgxylink" checked onchange="EditPrefs(1)" />Link</div>
<div style="margin-bottom:20px"><div style="float:left;width:120px">Height:</div><input type="text" name="paramheight" value="32" size="10" onchange="EditPrefs(1)" /><button class="spin" onmousedown="EditValue(document.prefs.paramheight,0)"><img src="img/spin.png"/></button></div>
<div id="prevframes"><div style="float:left;width:120px">Preview Frames:</div><input type="text" name="framesprev" value="5" size="10" onchange="EditPrefs(1)" /><button class="spin" onmousedown="EditValue(document.prefs.framesprev,0)"><img src="img/spin.png"/></button></div>
<div><div style="float:left;width:120px">Rendering Frames:</div><input type="text" name="framesrender" value="31" size="10" onchange="EditPrefs(1)" /><button class="spin" onmousedown="EditValue(document.prefs.framesrender,0)"><img src="img/spin.png"/></button></div>
<br />
<div><div style="float:left;width:120px">Export As:</div><select id="exportas" name="exportas" onchange="EditPrefs(1)"><option>Stitched Image</option><option>APNG Animation</option></select></div>
<div id="orientationrow"><div style="float:left;width:120px">Orientation:</div><select id="orientation" name="orientation" onchange="EditPrefs(1)"><option>Vertical</option><option>Horizontal</option></select></div>
<div id="durationrow"><div style="float:left;width:120px">Duration (ms):</div><input type="text" id="duration" name="duration" value="100" size="10" onchange="EditPrefs(1)" /><button class="spin" onmousedown="EditValue(document.prefs.duration,0)"><img src="img/spin.png"/></button></div>
<div id="shuttlerow"><div style="float:left;width:120px">Shuttle:</div><input id="shuttle" name="shuttle" type="checkbox" onchange="EditPrefs(1)"/></div>
<br />
<button id="exportexec" style="width:160px;height:24px;display:none" title="Export As PNG" onclick="Export()">Export Exec</button>
<br />
<div><div style="float:left;width:120px">BkColor R:</div><input type="text" name="bkcolr" value="255" size="6" onchange="EditPrefs(1)" /></div>
<div><div style="float:left;width:120px">BkColor G:</div><input type="text" name="bkcolg" value="255" size="6" onchange="EditPrefs(1)" /></div>
<div><div style="float:left;width:120px">BkColor B:</div><input type="text" name="bkcolb" value="255" size="6" onchange="EditPrefs(1)" /></div>
<br/>


</form>
</div>
<div id="thumb" style="display:none"><center><img id="thumbimg" src=""/><div id="thumbname">name</div></center></div>
<div id="primitive" style="float:left;width:280px;border:1px solid;margin:5px;padding:5px;display:none">
<form name="prim"  action="javascript:EditEff(1)">
<div id="primtype">
<div style="float:left;width:100px">Type:</div><div style="float:left;width:120px">

<div id="typesel" name="type" onchange="SetPrimType()" class="select" style="width:130px">
  <div class="option"><img src="img/none.png" /> None</div>
  <div class="option"><img src="img/image.png"/> Image</div>
  <div class="option"><img src="img/circle.png"/> Circle</div>
  <div class="option"><img src="img/circlefill.png"/> CircleFill</div>
  <div class="option"><img src="img/metalcircle.png"/> MetalCircle</div>
  <div class="option"><img src="img/wavecircle.png"/> WaveCircle</div>
  <div class="option"><img src="img/sphere.png"/> Sphere</div>
  <div class="option"><img src="img/rect.png"/> Rect</div>
  <div class="option"><img src="img/rectfill.png"/> RectFill</div>
  <div class="option"><img src="img/triangle.png"/> Triangle</div>
  <div class="option"><img src="img/line.png"/> Line</div>
  <div class="option"><img src="img/radiateline.png"/> RadiateLine</div>
  <div class="option"><img src="img/hlines.png"/> HLines</div>
  <div class="option"><img src="img/vlines.png"/> VLines</div>
  <div class="option"><img src="img/text.png"/> Text</div>
  <div class="option"><img src="img/shape.png"/> Shape</div>
</div>


<!--<select id="typesel" name="type" onchange="SetPrimType()">
<option value="None" data-image="img/none.png">None</option>
<option value="Image" data-image="img/image.png">Image</option>
<option value="Circle" data-image="img/circle.png">Circle</option>
<option value="CircleFill" data-image="img/circlefill.png">CircleFill</option>
<option value="MetalCircle" data-image="img/metalcircle.png">MetalCircle</option>
<option value="WaveCircle" data-image="img/wavecircle.png">WaveCircle</option>
<option value="Sphere" data-image="img/sphere.png">Sphere</option>
<option value="Rect" data-image="img/rect.png">Rect</option>
<option value="RectFill" data-image="img/rectfill.png">RectFill</option>
<option value="Triangle" data-image="img/triangle.png">Triangle</option>
<option value="Line" data-image="img/line.png">Line</option>
<option value="RadiateLine" data-image="img/radiateline.png">RadiateLine</option>
<option value="HLines" data-image="img/hlines.png">HLines</option>
<option value="VLines" data-image="img/vlines.png">VLines</option>
<option value="Text" data-image="img/text.png">Text</option>
<option value="Shape" data-image="img/shape.png">Shape</option>
</select>-->
</div></div>
<div style="clear:both"><br /></div><button style="display:none"></button>
  <div id="primshape" class="paramrow">
    <div style="width:100px">Shape:</div>
    <input type="text" id="shapestr" name="shape" value="" size="16" onchange="EditPrim(1)" />
    <button style="width:40px" onclick="shapeeditor.Open()">Edit</button>
  </div>
  <div id="primaspect" class="paramrow">
    <div style="width:100px">Aspect:</div>
    <input type="text" name="aspect" value="0" size="13" onchange="EditPrim(1)" class="valedit" />
    <button class="spin" onmousedown="EditValue(document.prim.aspect,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primround" class="paramrow">
    <div style="width:100px">Round:</div>
    <input type="text" name="round" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.round,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primwidth" class="paramrow">
    <div style="width:100px">Width:</div>
    <input type="text" name="width" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.width,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primlength" class="paramrow">
    <div style="width:100px">Length:</div>
    <input type="text" name="length" value="50" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.length,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primstep" class="paramrow">
    <div style="width:100px">Step:</div>
    <input type="text" name="step" value="20" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.step,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primanglestep" class="paramrow">
    <div style="width:100px">AngleStep:</div>
    <input type="text" name="anglestep" value="45" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.anglestep,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primemboss" class="paramrow">
    <div style="width:100px">Emboss:</div>
    <input type="text" name="emboss" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.emboss,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primembossdiffuse" class="paramrow">
    <div style="width:100px">EmbossDiffuse:</div>
    <input type="text" name="embossdiffuse" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.embossdiffuse,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primambient" class="paramrow">
    <div style="width:100px">Ambient:</div>
    <input type="text" name="ambient" value="50" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.ambient,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primlightdir" class="paramrow">
    <div style="width:100px">LightDir:</div>
    <input type="text" name="lightdir" value="-50" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.lightdir,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primspecular" class="paramrow">
    <div style="width:100px">Specular:</div>
    <input type="text" name="specular" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.specular,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primspecularwidth" class="paramrow">
    <div style="width:100px">SpecularWidth:</div>
    <input type="text" name="specularwidth" value="50" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.specularwidth,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primtexturefile" class="paramrow">
    <div style="width:100px">Texture:</div>
    <div class="select" id="texturesel" name="texturefile" onchange="SetTexture()">
      <div id="textureopt0" class="option"></div>
      <div class="option" style="height:30px"><img src="texture/Aura.jpg" style="height:29px"/>Aura</div>
      <div class="option" style="height:30px"><img src="texture/Checkers.bmp" style="height:29px"/>Checkers</div>
      <div class="option" style="height:30px"><img src="texture/Circle.jpg" style="height:29px"/>Circle</div>
      <div class="option" style="height:30px"><img src="texture/Coal.jpg" style="height:29px"/>Coal</div>
      <div class="option" style="height:30px"><img src="texture/Fabric.bmp" style="height:29px"/>Fabric</div>
      <div class="option" style="height:30px"><img src="texture/Hairline.bmp" style="height:29px"/>Hairline</div>
      <div class="option" style="height:30px"><img src="texture/HairlineV.bmp" style="height:29px"/>HairlineV</div>
      <div class="option" style="height:30px"><img src="texture/Hexagon.png" style="height:29px"/>Hexagon</div>
      <div class="option" style="height:30px"><img src="texture/Magma.bmp" style="height:29px"/>Magma</div>
      <div class="option" style="height:30px"><img src="texture/Mosaic.bmp" style="height:29px"/>Mosaic</div>
      <div class="option" style="height:30px"><img src="texture/Plant.png" style="height:29px"/>Plant</div>
      <div class="option" style="height:30px"><img src="texture/Plasma.bmp" style="height:29px"/>Plasma</div>
      <div class="option" style="height:30px"><img src="texture/PunchingMetal.png" style="height:29px"/>PunchingMetal</div>
      <div class="option" style="height:30px"><img src="texture/Radiation.jpg" style="height:29px"/>Radiation</div>
      <div class="option" style="height:30px"><img src="texture/Sand.bmp" style="height:29px"/>Sand</div>
      <div class="option" style="height:30px"><img src="texture/Scratch.jpg" style="height:29px"/>Scratch</div>
      <div class="option" style="height:30px"><img src="texture/Stripe.bmp" style="height:29px"/>Stripe</div>
      <div class="option" style="height:30px"><img src="texture/StripeV.bmp" style="height:29px"/>StripeV</div>
    </div>
  </div>
<!--
  <div id="primtexturefile" class="paramrow">
    <div style="width:100px">Texture:</div>
    <select name="texturefile" onchange="SetTexture()">
      <option value=""></option>
      <option value="Aura">Aura</option>
      <option value="Checkers" selected>Checkers</option>
      <option value="Circle">Circle</option>
      <option value="Coal">Coal</option>
      <option value="Fabric">Fabric</option>
      <option value="Hairline">Hairline</option>
      <option value="HairlineV">HairlineV</option>
      <option value="Hexagon">Hexagon</option>
      <option value="Magma">Magma</option>
      <option value="Mosaic">Mosaic</option>
      <option value="Plant">Plant</option>
      <option value="Plasma">Plasma</option>
      <option value="PunchingMetal">PunchingMetal</option>
      <option value="Radiation">Radiation</option>
      <option value="Sand">Sand</option>
      <option value="Scratch">Scratch</option>
      <option value="Stripe">Stripe</option>
      <option value="StripeV">StripeV</option>
    </select>
  </div>
-->
  <div id="primtexturedepth" class="paramrow">
    <div style="width:100px">TextureDepth:</div>
    <input type="text" name="texturedepth" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.texturedepth,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primtexturezoom" class="paramrow">
    <div style="width:100px">TextureZoom:</div>
    <input type="text" name="texturezoom" value="100" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.texturezoom,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primdiffuse" class="paramrow">
    <div style="width:100px">Diffuse:</div>
    <input type="text" name="diffuse" value="0" size="13" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.diffuse,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primfile" class="paramrow">
    <div style="width:100px">File:</div>
    <input type="file" name="file" onchange="OpenImage()"/>
  </div>
  <div id="primtext" class="paramrow">
    <div style="width:100px">Text:</div>
    <input type="text" name="texts" value="(1:100)" size="20" onchange="EditPrim(1)" />
  </div>
  <div id="primfont" class="paramroww">
    <div style="width:100px">Font:</div>
    <select style="width:100px" name="font" size="1" onchange="SetFont()">
      <option value=""></option>
      <option value="Arial">Arial</option>
      <option value="Arial Black">Arial Black</option>
      <option value="Arial Bold">Arial Bold</option>
      <option value="Arial Narrow">Arial Narrow</option>
      <option value="Comic Sans MS">Comic Sans MS</option>
      <option value="Comic Sans MS Bold">Comic Sans MS Bold</option>
      <option value="Courier">Courier</option>
      <option value="Courier New">Courier New</option>
      <option value="Courier New Bold">Courier New Bold</option>
      <option value="Georgia">Georgia</option>
      <option value="Impact">Impact</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Verdana">Verdana</option>
      <option value="Verdana Bold">Verdana Bold</option>
      <option value="Yu Gothic">Yu Gothic</option>
      <option value="Yu Gothic Bold">Yu Gothic Bold</option>
    </select>
  </div>
  <div id="primfontsize" class="paramrow">
    <div style="width:100px">FontSize:</div>
    <input type="text" name="fontsize" value="50" size="10" onchange="EditPrim(1)" class="valedit"/>
    <button class="spin" onmousedown="EditValue(document.prim.fontsize,1)"><img src="img/spin.png"/></button>
  </div>
  <div id="primbold" class="paramrow">
    <div style="width:100px">Bold:</div>
    <input type="checkbox" name="bold" value="bold" onchange="EditPrim(1)" />
  </div>
  <div id="primitalic" class="paramrow">
    <div style="width:100px">Italic:</div>
    <input type="checkbox" name="italic" value="italic" onchange="EditPrim(1)" />
  </div>
  <div id="primalign" class="paramrow">
    <div style="width:100px">Align:</div>
    <select name="textalign" onchange="EditPrim(1)">
      <option>Center</option>
      <option>Left</option>
      <option>Right</option>
    </select>
  </div>
  <div id="primcolor">Color:<br/></div>
<!--
  <div id="primcolor"><div style="float:left;width:100px">Color:</div><div style="float:left"><input type="text" name="colorbutton" style="width:100px" onchange="SetupColorFromText()"/> <button onclick="OpenColor()">Edit</button></div></div>
  <div id="colmap" style="display:none;clear:both;">
    <canvas id="colormap" width="140" height="120" style="float:left;margin:5px;"></canvas>
    <div>
    <div><div style="float:left;width:40px">H: </div><input name="colh" type="text" style="width:40px;" onchange="EditHls()"/></div>
    <div><div style="float:left;width:40px">L: </div><input name="coll" type="text" style="width:40px;" onchange="EditHls()"/></div>
    <div><div style="float:left;width:40px">S: </div><input name="cols" type="text" style="width:40px;" onchange="EditHls()"/></div>
    <div><div style="float:left;width:40px">R: </div><input name="colr" type="text" style="width:40px;" onchange="EditRgb()"/></div>
    <div><div style="float:left;width:40px">G: </div><input name="colg" type="text" style="width:40px;" onchange="EditRgb()"/></div>
    <div><div style="float:left;width:40px">B: </div><input name="colb" type="text" style="width:40px;" onchange="EditRgb()"/></div>
    </div>
    <div>
    <button id="pal0" style="width:20px;height:16px;background:#000000" onclick="SelPal(0,0,0)"> </button>
    <button id="pal1" style="width:20px;height:16px;background:#000080" onclick="SelPal(0,0,128)"> </button>
    <button id="pal2" style="width:20px;height:16px;background:#008000" onclick="SelPal(0,128,0)"> </button>
    <button id="pal3" style="width:20px;height:16px;background:#008080" onclick="SelPal(0,128,128)"> </button>
    <button id="pal4" style="width:20px;height:16px;background:#800000" onclick="SelPal(128,0,0)"> </button>
    <button id="pal5" style="width:20px;height:16px;background:#800080" onclick="SelPal(128,0,128)"> </button>
    <button id="pal6" style="width:20px;height:16px;background:#808000" onclick="SelPal(128,128,0)"> </button>
    <button id="pal7" style="width:20px;height:16px;background:#808080" onclick="SelPal(128,128,128)"> </button>
    </div>
    <div>
    <button id="pal8" style="width:20px;height:16px;background:#c0c0c0" onclick="SelPal(220,220,220)"> </button>
    <button id="pal9" style="width:20px;height:16px;background:#0000ff" onclick="SelPal(0,0,255)"> </button>
    <button id="pal10" style="width:20px;height:16px;background:#00ff00" onclick="SelPal(0,255,0)"> </button>
    <button id="pal11" style="width:20px;height:16px;background:#00ffff" onclick="SelPal(0,255,255)"> </button>
    <button id="pal12" style="width:20px;height:16px;background:#ff0000" onclick="SelPal(255,0,0)"> </button>
    <button id="pal13" style="width:20px;height:16px;background:#ff00ff" onclick="SelPal(255,0,255)"> </button>
    <button id="pal14" style="width:20px;height:16px;background:#ffff00" onclick="SelPal(255,255,0)"> </button>
    <button id="pal15" style="width:20px;height:16px;background:#ffffff" onclick="SelPal(255,255,255)"> </button>
    </div>
  </div>
-->
</form>
<div style="clear:both;">
<canvas id="canvasprevfrom" width="128" height="128" style="float:left;margin:4px"></canvas>
<canvas id="canvasprevto" width="128" height="128" style="float:left;margin:4px"></canvas>
</div>
</div>
<div id="effects" style="float:left;width:320px;height:600px;overflow:auto;border:1px solid;margin:5px;padding:5px;display:none">
<form name="eff" action="javascript:EditEff(1)">
<div>
  <input type="checkbox" name="antialias" onchange="EditEff(1)" checked />Antialias
</div>
<div class="paramrow">
  <div style="float:left;width:100px"><input type="checkbox" name="unfold" onchange="EditEff(1)" />Unfold</div><div style="float:left">AnimStep:<input style="width:50px" type="text" name="animstep" value="0" size="3" onchange="EditEff(1)" onkeydown="EditV(this)"/><button class="spin" onmousedown="EditValue(document.eff.animstep,2)"><img src="img/spin.png"/></button></div>
</div>
<div style="clear:both;border:1px solid #c0c0c0;padding:5px;margin:5px;"><b>Zoom</b>
  <div style="margin-left:70px">
    <input type="checkbox" name="zoomxysepa" value="zoomxysepa" onchange="EditEff(1)" />XY Separate
  </div>
  <div class="paramrow">
    <div style="width:70px">X:</div><input style="width:50px" type="text" name="zoomxf" value="100" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.zoomxf,2)"><img src="img/spin.png"/></button>
    <select name="zoomxanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="zoomxt" value="100" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.zoomxt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Y:</div><input style="width:50px" type="text" name="zoomyf" value="100" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.zoomyf,2)"><img src="img/spin.png"/></button>
    <select name="zoomyanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="zoomyt" value="100" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.zoomyt,2)"><img src="img/spin.png"/></button>
  </div>
</div>
<div style="border:1px solid #c0c0c0;padding:5px;margin:5px;"><b>Offset</b>
  <div class="paramrow">
    <div style="width:70px">X:</div><input style="width:50px" type="text" name="offxf" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.offxf,2)"><img src="img/spin.png"/></button>
    <select name="offxanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="offxt" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.offxt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Y:</div><input style="width:50px" type="text" name="offyf" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.offyf,2)"><img src="img/spin.png"/></button>
    <select name="offyanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="offyt" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.offyt,2)"><img src="img/spin.png"/></button>
  </div>
</div>
<div style="border:1px solid #c0c0c0;padding:5px;margin:5px;"><b>Rotate At</b>
  <div style="margin-left:70px"><input type="checkbox" name="keepdir" value="keepdir" onchange="EditEff(1)" />Keep Dir</div>
  <div class="paramrow">
    <div style="width:70px">CenterX:</div><input style="width:50px" type="text" name="centerx" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.centerx,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">CenterY:</div><input style="width:50px" type="text" name="centery" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.centery,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Angle:</div><input style="width:50px" type="text" name="anglef" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.anglef,2)"><img src="img/spin.png"/></button>
    <select name="angleanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="anglet" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.anglet,2)"><img src="img/spin.png"/></button>
  </div>
</div>
<div style="border:1px solid #c0c0c0;padding:5px;margin:5px;"><b>Colors</b>
  <div class="paramrow">
    <div style="width:70px">Alpha:</div><input style="width:50px" type="text" name="alphaf" value="100" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.alphaf,2)"><img src="img/spin.png"/></button>
    <select name="alphaanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="alphat" value="100" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.alphat,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Brightness:</div><input style="width:50px" type="text" name="brightf" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.brightf,2)"><img src="img/spin.png"/></button>
    <select name="brightanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="brightt" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.brightt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Contrast:</div><input style="width:50px" type="text" name="contrastf" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.contrastf,2)"><img src="img/spin.png"/></button>
    <select name="contrastanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="contrastt" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.contrastt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Saturation:</div><input style="width:50px" type="text" name="saturationf" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.saturationf,2)"><img src="img/spin.png"/></button>
    <select name="saturationanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="saturationt" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.saturationt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Hue:</div><input style="width:50px" type="text" name="huef" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.huef,2)"><img src="img/spin.png"/></button>
    <select name="hueanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="huet" value="0"size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.huet,2)"><img src="img/spin.png"/></button>
  </div>
</div>
<div style="border:1px solid #c0c0c0;padding:5px;margin:5px;"><b>Mask</b>
  <div class="subgrp"><input type="checkbox" name="mask1ena" value="mask1ena" onchange="EditEff(1)" />Mask Enable 1</div>
  <div class="paramrow">
    <div style="width:70px">Type:</div>
    <select name="mask1type" onchange="EditEff(1)">
      <option value="Rotate">Rotate</option>
      <option value="Radius">Radius</option>
      <option value="Horizontal">Horizontal</option>
      <option value="Vertical">Vertical</option>
    </select>
  </div>
  <div class="paramrow">
    <div style="width:70px">Gradation:</div>
    <input style="width:50px" type="text" name="mask1grad" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask1grad,2)"><img src="img/spin.png"/></button>
    <select name="mask1graddir" onchange="EditEff(1)">
      <option value="SingleDir">SingleDir</option>
      <option value="BiDir">BiDir</option>
    </select>
  </div>
  <div class="paramrow">
    <div style="width:70px">Start:</div>
    <input style="width:50px" type="text" name="mask1startf" value="-140" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask1startf,2)"><img src="img/spin.png"/></button>
    <select name="mask1startanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="mask1startt" value="-140" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask1startt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Stop:</div>
    <input style="width:50px" type="text" name="mask1stopf" value="140" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask1stopf,2)"><img src="img/spin.png"/></button>
    <select name="mask1stopanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="mask1stopt" value="140" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask1stopt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="subgrp"><input type="checkbox" name="mask2ena" value="mask2ena" onchange="EditEff(1)" />Mask Enable 2</div>
  <div class="paramrow">
    <div style="width:70px">Operation:</div>
    <select name="mask2op" onchange="EditEff(1)">
      <option value="And">And</option>
      <option value="Or">Or</option>
    </select>
  </div>
  <div class="paramrow">
    <div style="width:70px">Type:</div>
    <select name="mask2type" onchange="EditEff(1)">
      <option value="Rotate">Rotate</option>
      <option value="Radius">Radius</option>
      <option value="Horizontal">Horizontal</option>
      <option value="Vertical">Vertical</option>
    </select>
  </div>
  <div class="paramrow">
    <div style="width:70px">Gradation:</div>
    <input style="width:50px" type="text" name="mask2grad" value="0" size="3" onchange="EditEff()" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask2grad,2)"><img src="img/spin.png"/></button>
    <select name="mask2graddir" onchange="EditEff(1)">
      <option value="SingleDir">SingleDir</option>
      <option value="BiDir">BiDir</option>
    </select>
  </div>
  <div class="paramrow">
    <div style="width:70px">Start:</div><input style="width:50px" type="text" name="mask2startf" value="-140" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask2startf,2)"><img src="img/spin.png"/></button>
    <select name="mask2startanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="mask2startt" value="-140" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask2startt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Stop:</div>
    <input style="width:50px" type="text" name="mask2stopf" value="140" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask2stopf,2)"><img src="img/spin.png"/></button>
    <select name="mask2stopanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="mask2stopt" value="140" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.mask2stopt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="subgrp">FrameMask <select name="fmaskena" value="fmaskena" onchange="EditEff(1)"><option>Disable</option><option>Range</option><option>BitMask</option></select></div>
  <div class="paramrow">
    <div style="width:70px">Start:</div>
    <input style="width:50px" type="text" name="fmaskstart" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.fmaskstart,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Stop:</div>
    <input style="width:50px" type="text" name="fmaskstop" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.fmaskstop,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">MaskBits:</div>
    <input type="text" name="fmaskbits" value="11111" size="15" onchange="EditEff(1)" />
  </div>
</div>
<div style="border:1px solid #c0c0c0;padding:5px;margin:5px"><b>Lighting</b>
  <div class="subgrp">Specular</div>
  <div class="paramrow">
    <div style="width:70px">LightDir:</div>
    <input style="width:50px" type="text" name="slightdirf" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.slightdirf,2)"><img src="img/spin.png"/></button>
    <select name="slightdiranim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="slightdirt" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.slightdirt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Density:</div>
    <input style="width:50px" type="text" name="sdensityf" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.sdensityf,2)"><img src="img/spin.png"/></button>
    <select name="sdensityanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="sdensityt" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.sdensityt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="subgrp">Drop Shadow</div>
  <div class="paramrow">
    <div style="width:50px">LightDir:</div>
    <input type="checkbox" name="dlightdirena" onchange="EditEff(1)" />
    <input style="width:50px" type="text" name="dlightdirf" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.dlightdirf,2)"><img src="img/spin.png"/></button>
    <select name="dlightdiranim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="dlightdirt" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.dlightdirt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Offset:</div>
    <input style="width:50px" type="text" name="doffsetf" value="5" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.doffsetf,2)"><img src="img/spin.png"/></button>
    <select name="doffsetanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="doffsett" value="5" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.doffsett,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Density:</div>
    <input style="width:50px" type="text" name="ddensityf" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ddensityf,2)"><img src="img/spin.png"/></button>
    <select name="ddensityanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="ddensityt" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ddensityt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Diffuse:</div>
    <input style="width:50px" type="text" name="ddiffusef" value="20" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ddiffusef,2)"><img src="img/spin.png"/></button>
    <select name="ddiffuseanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="ddiffuset" value="20" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ddiffuset,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:65px">Type:</div>
    <select name="dstype" onchange="EditEff(1)">
      <option value="Spot">Spot</option>
      <option value="Line">Line</option>
    </select>
    <input style="width:50px" type="text" name="dsgrad" value="100" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.dsgrad,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="subgrp">Inside Shadow</div>
  <div class="paramrow">
    <div style="width:50px">LightDir:</div>
    <input type="checkbox" name="ilightdirena" onchange="EditEff(1)" />
    <input style="width:50px" type="text" name="ilightdirf" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ilightdirf,2)"><img src="img/spin.png"/></button>
    <select name="ilightdiranim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="ilightdirt" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ilightdirt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Offset:</div>
    <input style="width:50px" type="text" name="ioffsetf" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ioffsetf,2)"><img src="img/spin.png"/></button>
    <select name="ioffsetanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="ioffsett" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.ioffsett,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Density:</div>
    <input style="width:50px" type="text" name="idensityf" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.idensityf,2)"><img src="img/spin.png"/></button>
    <select name="idensityanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="idensityt" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.idensityt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Diffuse:</div>
    <input style="width:50px" type="text" name="idiffusef" value="20" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.idiffusef,2)"><img src="img/spin.png"/></button>
    <select name="idiffuseanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="idiffuset" value="20" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.idiffuset,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="subgrp">Edge Shadow</div>
  <div class="paramrow">
    <div style="width:50px">LightDir:</div>
    <input type="checkbox" name="elightdirena" value="elightdirena" onchange="EditEff(1)" />
    <input style="width:50px" type="text" name="elightdirf" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.elightdirf,2)"><img src="img/spin.png"/></button>
    <select name="elightdiranim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="elightdirt" value="-45" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.elightdirt,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Offset:</div>
    <input style="width:50px" type="text" name="eoffsetf" value="20" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.eoffsetf,2)"><img src="img/spin.png"/></button>
    <select name="eoffsetanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="eoffsett" value="20" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.eoffsett,2)"><img src="img/spin.png"/></button>
  </div>
  <div class="paramrow">
    <div style="width:70px">Density:</div>
    <input style="width:50px" type="text" name="edensityf" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.edensityf,2)"><img src="img/spin.png"/></button>
    <select name="edensityanim" onchange="EditEff(1)"><option></option><option>&#x25b6;</option><option>1&#x25b6;</option><option>2&#x25b6;</option><option>3&#x25b6;</option><option>4&#x25b6;</option><option>5&#x25b6;</option><option>6&#x25b6;</option><option>7&#x25b6;</option><option>8&#x25b6;</option></select>
    <input style="width:50px" type="text" name="edensityt" value="0" size="3" onchange="EditEff(1)" class="valedit"/><button class="spin" onmousedown="EditValue(document.eff.edensityt,2)"><img src="img/spin.png"/></button>
  </div>
</div>

</form>
</div>
<div id="renderpane" style="float:left;width:150px;height:600px;overflow:auto;border:1px solid;margin:5px;padding:5px;text-align:center;display:none">
<canvas id="canvasrender" width="32" height="160"></canvas>
</div>
<div style="clear:both"></div>

<div style="z-index:2;background:rgba(128,128,128,0.8);position:absolute;top:0;left:0;display:none;overflow:scroll;height:700px;width:100%" id="renderpaneframe">
  <button onclick="CloseRender()" style="display:block;margin:0px auto;width:120px;height:25px;">Close</button>
  <div id="rendermsg" style="text-align:center">Save the image bellow as PNG file</div>
  <img alt="" id="renderimage" src="./img/none.png" style="display:block;border:1px solid #c0c0c0;margin:0px auto;"/>
</div>
  
</div>
<hr />
<h2>How to use</h2>
<p>WebKnobman is a subset of 'JKnobMan'. JKnobMan online help is here.
</p>
<a href="https://www.g200kg.com/jp/docs/jknobman/" target="_blank">JKnobMan Online Help</a>
<hr/>
<h2>Limitations</h2>
<p>Because WebKnobMan uses some cutting edge functions of the browser, please use the latest browser.
I recommend using Chrome or Firefox.</p>
<p>Rendering results are almost same as standalone 'KnobMan', but lacking some functions.</p>
<ul>
<li>User definable textures.</li>
<li>Fonts are limited to a few things that can be used commonly on Win / Mac.</li>
<li>'Image' primitives has no parameters.</li>
<li>Exporting support only PNG format</li>
<li>Oversampling mode, styles, and some preference settings.</li>
</ul>

<hr />

<div style="display:none;">
<canvas id="canvaswork" width="800" height="800"></canvas>
<canvas id="canvaswork2" width="256" height="256"></canvas>
<canvas style="border:1px solid #c00000" id="canvaswork3" width="100" height="100"></canvas>
</div>
<div style="height:1px;width:1px;overflow:hidden">
<img alt="" src="./texture/Aura.jpg" id="tex-Aura"/>
<img alt="" src="./texture/Checkers.bmp" id="tex-Checkers"/>
<img alt="" src="./texture/Circle.jpg" id="tex-Circle" />
<img alt="" src="./texture/Coal.jpg" id="tex-Coal" />
<img alt="" src="./texture/Fabric.bmp" id="tex-Fabric"/>
<img alt="" src="./texture/Hairline.bmp" id="tex-Hairline" />
<img alt="" src="./texture/HairlineV.bmp" id="tex-HairlineV" />
<img alt="" src="./texture/Hexagon.png" id="tex-Hexagon" />
<img alt="" src="./texture/Magma.bmp" id="tex-Magma" />
<img alt="" src="./texture/Mosaic.bmp" id="tex-Mosaic" />
<img alt="" src="./texture/Plant.png" id="tex-Plant" />
<img alt="" src="./texture/Plasma.bmp" id="tex-Plasma" />
<img alt="" src="./texture/PunchingMetal.png" id="tex-PunchingMetal" />
<img alt="" src="./texture/Radiation.jpg" id="tex-Radiation" />
<img alt="" src="./texture/Sand.bmp" id="tex-Sand" />
<img alt="" src="./texture/Scratch.jpg" id="tex-Scratch" />
<img alt="" src="./texture/Stripe.bmp" id="tex-Stripe" />
<img alt="" src="./texture/StripeV.bmp" id="tex-StripeV" />
<img alt="" src="./texture/None.bmp" id="tex-None" />
</div>
</div>
</body>
</html>
